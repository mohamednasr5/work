<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة الموظف</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>

    <nav class="navbar-custom d-none d-lg-block">
        <div class="container d-flex justify-content-between">
            <span class="navbar-brand"><i class="fas fa-user-clock me-2"></i> بوابة الموظف</span>
            <span id="userNameDisplay">مرحباً</span>
        </div>
    </nav>

    <div class="container mt-3 mt-lg-0">
        <div class="d-lg-none mb-3">
            <h4 class="fw-bold" id="userNameMobile">مرحباً..</h4>
            <p class="text-muted small">قم بتسجيل حضورك اليومي</p>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="glass-card p-3">
                    <h5 class="mb-3 fw-bold text-primary"><i class="fas fa-map-marker-alt me-2"></i> موقعك الحالي</h5>
                    <div id="map" class="map-frame"></div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="distanceText">جاري حساب المسافة...</small>
                        <span class="badge bg-secondary" id="gpsAccuracy">DQL: --</span>
                    </div>
                </div>

                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <button id="checkInBtn" class="btn-glass bg-success text-white" disabled>
                            <i class="fas fa-fingerprint fa-2x d-block mb-1"></i>
                            تسجيل دخول
                        </button>
                    </div>
                    <div class="col-6">
                        <button id="checkOutBtn" class="btn-glass bg-danger text-white" disabled>
                            <i class="fas fa-sign-out-alt fa-2x d-block mb-1"></i>
                            تسجيل خروج
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="glass-card p-3 text-center">
                    <h5 class="mb-3">حالة اليوم</h5>
                    <div id="statusBadge" class="status-pill absent mb-3">غائب</div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6 border-start">
                            <small class="d-block text-muted">دخول</small>
                            <strong id="inTime">--:--</strong>
                        </div>
                        <div class="col-6">
                            <small class="d-block text-muted">خروج</small>
                            <strong id="outTime">--:--</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="#" class="nav-item-link active"><i class="fas fa-home"></i>الرئيسية</a>
            <a href="profile.html" class="nav-item-link"><i class="fas fa-user"></i>حسابي</a>
            <a href="#" id="logoutBtn" class="nav-item-link"><i class="fas fa-sign-out-alt"></i>خروج</a>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=geometry" async defer></script>
    <script src="script.js"></script>
    
    <script>
        // Logic for Employee Page
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if(!user || user.role !== 'employee') window.location.href = 'index.html';

        document.getElementById('userNameDisplay').innerText = user.name;
        document.getElementById('userNameMobile').innerText = 'مرحباً ' + user.name;

        // دالة يتم استدعاؤها من script.js عند تحديث الموقع
        window.checkDistanceLogic = function(userPos, workPos, radius) {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(userPos),
                new google.maps.LatLng(workPos)
            );
            
            document.getElementById('distanceText').innerText = `تبعد ${Math.round(distance)} متر عن العمل`;
            
            const inBtn = document.getElementById('checkInBtn');
            const outBtn = document.getElementById('checkOutBtn');
            
            if(distance <= radius) {
                inBtn.disabled = false;
                outBtn.disabled = false;
                inBtn.style.opacity = "1";
                outBtn.style.opacity = "1";
            } else {
                inBtn.disabled = true;
                outBtn.disabled = true;
                inBtn.style.opacity = "0.5";
                outBtn.style.opacity = "0.5";
            }
        };

        // Check-in/out Handlers (Simple Implementation)
        document.getElementById('checkInBtn').onclick = () => registerAction('checkin');
        document.getElementById('checkOutBtn').onclick = () => registerAction('checkout');

        async function registerAction(type) {
            const now = new Date();
            const timestamp = now.getTime();
            const dateStr = now.toISOString().split('T')[0];
            
            await database.ref(`attendance/${user.id}/${timestamp}`).set({
                type: type,
                time: timestamp,
                date: dateStr,
                location: window.currentPos || 'GPS'
            });
            
            showNotification(type === 'checkin' ? 'تم تسجيل الدخول' : 'تم تسجيل الخروج', 'success');
            updateUI(type, now);
        }

        function updateUI(type, date) {
            const timeStr = date.toLocaleTimeString('ar-SA');
            if(type === 'checkin') {
                document.getElementById('inTime').innerText = timeStr;
                document.getElementById('statusBadge').className = 'status-pill present';
                document.getElementById('statusBadge').innerText = 'حاضر';
            } else {
                document.getElementById('outTime').innerText = timeStr;
            }
        }
    </script>
</body>
</html>
