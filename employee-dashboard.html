<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير - نظام الحضور الذكي</title>
    <!-- Bootstrap 5 Arabic -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-rtl@0.4.0/dist/css/bootstrap-rtl.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap&libraries=geometry" async defer></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #1abc9c;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
        }
        
        /* Navbar */
        .navbar {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        /* Sidebar */
        #sidebar {
            background-color: white;
            min-height: calc(100vh - 70px);
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 70px;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .sidebar-header h5 {
            color: var(--primary-color);
            font-weight: 700;
            margin: 10px 0 5px;
        }
        
        .sidebar-header p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .nav-pills .nav-link {
            color: #555;
            border-radius: 8px;
            padding: 12px 20px;
            margin: 5px 15px;
            transition: all 0.3s;
            text-align: right;
        }
        
        .nav-pills .nav-link:hover {
            background-color: #f8f9fa;
            color: var(--secondary-color);
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(to right, var(--secondary-color), #2980b9);
            color: white;
            font-weight: 600;
        }
        
        .nav-pills .nav-link i {
            margin-left: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        #content {
            padding: 25px;
            min-height: calc(100vh - 70px);
        }
        
        .page-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .page-header h3 {
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .page-header h3 i {
            margin-left: 10px;
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 2px solid #f1f1f1;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .card-header i {
            margin-left: 8px;
            color: var(--secondary-color);
        }
        
        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            color: white;
        }
        
        .present .stat-icon {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
        }
        
        .absent .stat-icon {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .late .stat-icon {
            background: linear-gradient(135deg, var(--warning-color), #d35400);
        }
        
        .total .stat-icon {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
        }
        
        .stat-card h2 {
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-card p {
            color: #666;
            margin: 0;
        }
        
        /* Map */
        #map {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        /* Tables */
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background-color: #f8f9fa;
            color: var(--primary-color);
            font-weight: 700;
            border-bottom: 2px solid #dee2e6;
        }
        
        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .badge-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .badge-present {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-absent {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .badge-late {
            background-color: #fff3cd;
            color: #856404;
        }
        
        /* Form Controls */
        .form-control, .form-select {
            border-radius: 10px;
            padding: 10px 15px;
            border: 2px solid #e1e5eb;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(to right, var(--secondary-color), #2980b9);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success-color), #27ae60);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning-color), #d35400);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger-color), #c0392b);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            #sidebar {
                min-height: auto;
                position: relative;
                top: 0;
                margin-bottom: 20px;
            }
            
            #content {
                padding: 15px;
            }
            
            #map {
                height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .stat-card {
                margin-bottom: 20px;
            }
            
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>لوحة تحكم المدير
            </a>
            
            <div class="d-flex align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-2"></i>
                        <span id="adminName">مدير النظام</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                            <i class="fas fa-user-edit me-2"></i>تعديل الملف الشخصي
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="fas fa-key me-2"></i>تغيير كلمة المرور
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt me-2"></i>تسجيل الخروج
                        </a></li>
                    </ul>
                </div>
                
                <div class="text-white">
                    <i class="fas fa-clock me-2"></i>
                    <span id="currentTime">--:--:--</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 col-xl-2">
                <div id="sidebar">
                    <div class="sidebar-header">
                        <div class="position-relative">
                            <div class="avatar mx-auto" style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                                م
                            </div>
                            <span class="position-absolute bottom-0 start-50 translate-middle p-1 bg-success border border-3 border-white rounded-circle">
                                <i class="fas fa-circle text-success" style="font-size: 10px;"></i>
                            </span>
                        </div>
                        <h5 id="sidebarAdminName">مدير النظام</h5>
                        <p class="text-muted">صلاحية: مدير كامل</p>
                    </div>
                    
                    <ul class="nav nav-pills flex-column mb-auto mt-3">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-page="dashboard">
                                <i class="fas fa-tachometer-alt"></i>
                                لوحة التحكم
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="map">
                                <i class="fas fa-map-marked-alt"></i>
                                الخريطة الحية
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="employees">
                                <i class="fas fa-users"></i>
                                إدارة الموظفين
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="attendance">
                                <i class="fas fa-clipboard-check"></i>
                                سجلات الحضور
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="reports">
                                <i class="fas fa-chart-bar"></i>
                                التقارير والإحصائيات
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="settings">
                                <i class="fas fa-cog"></i>
                                إعدادات النظام
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9 col-xl-10">
                <div id="content">
                    <!-- صفحة لوحة التحكم الرئيسية -->
                    <div id="dashboardPage" class="page-content">
                        <div class="page-header">
                            <h3><i class="fas fa-tachometer-alt"></i>لوحة التحكم الرئيسية</h3>
                        </div>
                        
                        <!-- إحصائيات سريعة -->
                        <div class="row">
                            <div class="col-md-3 col-sm-6">
                                <div class="card stat-card present">
                                    <div class="card-body">
                                        <div class="stat-icon">
                                            <i class="fas fa-user-check"></i>
                                        </div>
                                        <h2 id="presentCount">0</h2>
                                        <p>موظف حاضر الآن</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="card stat-card absent">
                                    <div class="card-body">
                                        <div class="stat-icon">
                                            <i class="fas fa-user-times"></i>
                                        </div>
                                        <h2 id="absentCount">0</h2>
                                        <p>موظف غائب الآن</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="card stat-card late">
                                    <div class="card-body">
                                        <div class="stat-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <h2 id="lateCount">0</h2>
                                        <p>موظف متأخر</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="card stat-card total">
                                    <div class="card-body">
                                        <div class="stat-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h2 id="totalEmployees">0</h2>
                                        <p>إجمالي الموظفين</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- الخريطة المصغرة -->
                        <div class="row mt-4">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-map-marker-alt"></i>خريطة موقع العمل
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="miniMap" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-exclamation-circle"></i>تنبيهات فورية
                                    </div>
                                    <div class="card-body">
                                        <div id="alertsList" class="list-group list-group-flush">
                                            <!-- سيتم ملء التنبيهات بواسطة JavaScript -->
                                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                                <i class="fas fa-clock me-2"></i>
                                                <strong>محمد أحمد</strong> لم يسجل دخوله حتى الآن
                                                <small class="d-block text-muted">منذ 45 دقيقة</small>
                                            </div>
                                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>سارة خالد</strong> سجلت دخولها تلقائياً
                                                <small class="d-block text-muted">قبل 10 دقائق</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- جدول الحضور الأخير -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-history"></i>آخر حركات الحضور
                                        </div>
                                        <button class="btn btn-sm btn-primary" id="refreshAttendance">
                                            <i class="fas fa-sync-alt"></i>تحديث
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>الموظف</th>
                                                        <th>الحالة</th>
                                                        <th>الوقت</th>
                                                        <th>المسافة</th>
                                                        <th>الإجراءات</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recentAttendance">
                                                    <!-- سيتم ملء البيانات بواسطة JavaScript -->
                                                    <tr>
                                                        <td>1</td>
                                                        <td>أحمد محمد</td>
                                                        <td><span class="badge badge-present">داخل العمل</span></td>
                                                        <td>08:15 ص</td>
                                                        <td>15 م</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-map-marker-alt"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- صفحة الخريطة الحية (مخفية حالياً) -->
                    <div id="mapPage" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h3><i class="fas fa-map-marked-alt"></i>الخريطة الحية للموظفين</h3>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-map"></i>خريطة التتبع المباشر
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-success me-2" id="centerMap">
                                                <i class="fas fa-crosshairs"></i>توسيط الخريطة
                                            </button>
                                            <button class="btn btn-sm btn-primary" id="updateLocations">
                                                <i class="fas fa-sync-alt"></i>تحديث المواقع
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="liveMap" style="height: 600px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- صفحات أخرى سيتم إضافتها لاحقاً -->
                    <div id="employeesPage" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h3><i class="fas fa-users"></i>إدارة الموظفين</h3>
                        </div>
                        <p>صفحة إدارة الموظفين قيد التطوير...</p>
                    </div>
                    
                    <div id="attendancePage" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h3><i class="fas fa-clipboard-check"></i>سجلات الحضور</h3>
                        </div>
                        <p>صفحة سجلات الحضور قيد التطوير...</p>
                    </div>
                    
                    <div id="reportsPage" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h3><i class="fas fa-chart-bar"></i>التقارير والإحصائيات</h3>
                        </div>
                        <p>صفحة التقارير والإحصائيات قيد التطوير...</p>
                    </div>
                    
                    <div id="settingsPage" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h3><i class="fas fa-cog"></i>إعدادات النظام</h3>
                        </div>
                        <p>صفحة الإعدادات قيد التطوير...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لتحديد موقع العمل -->
    <div class="modal fade" id="workLocationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-map-marker-alt me-2"></i>تحديد موقع العمل
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>اسحب العلامة الحمراء لتحديد موقع العمل الدقيق، ثم اضغط حفظ.</p>
                    <div id="modalMap" style="height: 400px; border-radius: 8px; overflow: hidden;"></div>
                    <div class="mt-3">
                        <label class="form-label">نصف قطر منطقة الحضور (بالمتر)</label>
                        <input type="range" class="form-range" id="radiusRange" min="10" max="100" value="20">
                        <div class="d-flex justify-content-between">
                            <span id="radiusValue">20 متر</span>
                            <span>10 م - 100 م</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveLocation">حفظ الموقع</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC4J8ncbuejvzfWvzCTAXRzjFg_vrchXpE",
            authDomain: "hedor-bea3c.firebaseapp.com",
            databaseURL: "https://hedor-bea3c-default-rtdb.firebaseio.com",
            projectId: "hedor-bea3c",
            storageBucket: "hedor-bea3c.firebasestorage.app",
            messagingSenderId: "369239455736",
            appId: "1:369239455736:web:116295854269abecf6480d",
            measurementId: "G-R2MG1YKQEP"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // متغيرات عامة
        let currentUser = null;
        let map, liveMap, modalMap;
        let workLocation = { lat: 24.7136, lng: 46.6753 };
        let geofenceRadius = 20;
        let employeeMarkers = {};
        
        // التحقق من جلسة المدير
        function checkAdminSession() {
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            if (currentUser.role !== 'admin') {
                window.location.href = 'index.html';
                return;
            }
            
            // عرض اسم المدير
            document.getElementById('adminName').textContent = currentUser.name;
            document.getElementById('sidebarAdminName').textContent = currentUser.name;
        }
        
        // تحديث الوقت الحالي
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-SA');
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // تبديل الصفحات في اللوحة
        function setupPageNavigation() {
            const navLinks = document.querySelectorAll('.nav-link[data-page]');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // إزالة النشاط من جميع الروابط
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // إضافة النشاط للرابط الحالي
                    this.classList.add('active');
                    
                    // إخفاء جميع الصفحات
                    const pages = document.querySelectorAll('.page-content');
                    pages.forEach(page => page.style.display = 'none');
                    
                    // عرض الصفحة المحددة
                    const pageId = this.getAttribute('data-page') + 'Page';
                    document.getElementById(pageId).style.display = 'block';
                    
                    // تهيئة الصفحة إذا لزم الأمر
                    if (pageId === 'mapPage') {
                        initLiveMap();
                    }
                });
            });
        }
        
        // تهيئة الخريطة المصغرة
        function initMiniMap() {
            const mapOptions = {
                center: workLocation,
                zoom: 17,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true,
                zoomControl: true
            };
            
            map = new google.maps.Map(document.getElementById('miniMap'), mapOptions);
            
            // إضافة علامة موقع العمل
            new google.maps.Marker({
                position: workLocation,
                map: map,
                title: 'موقع العمل',
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                }
            });
            
            // إضافة دائرة نصف قطر منطقة الحضور
            new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.1,
                map: map,
                center: workLocation,
                radius: geofenceRadius
            });
            
            // زر لتحديد موقع العمل في الخريطة المصغرة
            const locationButton = document.createElement('button');
            locationButton.innerHTML = '<i class="fas fa-crosshairs"></i>';
            locationButton.classList.add('btn', 'btn-primary', 'btn-sm');
            locationButton.style.margin = '10px';
            locationButton.title = 'تحديد موقع العمل';
            
            locationButton.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('workLocationModal'));
                modal.show();
                setTimeout(initModalMap, 300);
            });
            
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(locationButton);
        }
        
        // تهيئة الخريطة الحية
        function initLiveMap() {
            if (typeof google === 'undefined') {
                console.error('Google Maps API لم يتم تحميلها بعد');
                return;
            }
            
            const mapOptions = {
                center: workLocation,
                zoom: 16,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            
            liveMap = new google.maps.Map(document.getElementById('liveMap'), mapOptions);
            
            // دائرة منطقة الحضور
            new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.1,
                map: liveMap,
                center: workLocation,
                radius: geofenceRadius
            });
            
            // تحميل مواقع الموظفين
            loadEmployeeLocations();
        }
        
        // تحميل مواقع الموظفين من Firebase
        function loadEmployeeLocations() {
            database.ref('attendance').on('value', (snapshot) => {
                // مسح جميع العلامات القديمة
                Object.values(employeeMarkers).forEach(marker => marker.setMap(null));
                employeeMarkers = {};
                
                const data = snapshot.val();
                if (!data) return;
                
                Object.keys(data).forEach(employeeId => {
                    const employeeAttendance = data[employeeId];
                    const timestamps = Object.keys(employeeAttendance).sort().reverse();
                    
                    if (timestamps.length > 0) {
                        const latestRecord = employeeAttendance[timestamps[0]];
                        const location = latestRecord.location;
                        
                        // الحصول على بيانات الموظف
                        database.ref('employees/' + employeeId).once('value')
                            .then(employeeSnapshot => {
                                if (employeeSnapshot.exists()) {
                                    const employee = employeeSnapshot.val();
                                    createEmployeeMarker(employeeId, employee.name, location, latestRecord.state);
                                }
                            });
                    }
                });
            });
        }
        
        // إنشاء علامة موظف على الخريطة
        function createEmployeeMarker(employeeId, name, location, state) {
            const iconUrl = state === 'IN' 
                ? 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                : 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
            
            const marker = new google.maps.Marker({
                position: location,
                map: liveMap,
                title: `${name} - ${state === 'IN' ? 'داخل العمل' : 'خارج العمل'}`,
                icon: {
                    url: iconUrl
                }
            });
            
            // نافذة معلومات عند النقر على العلامة
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 10px; min-width: 200px;">
                        <h6 style="margin: 0 0 10px; color: #2c3e50;">${name}</h6>
                        <p style="margin: 5px 0;"><strong>الحالة:</strong> 
                            <span style="color: ${state === 'IN' ? '#27ae60' : '#e74c3c'}">
                                ${state === 'IN' ? 'داخل العمل' : 'خارج العمل'}
                            </span>
                        </p>
                        <p style="margin: 5px 0;"><strong>الموقع:</strong> ${location.lat.toFixed(5)}, ${location.lng.toFixed(5)}</p>
                        <button onclick="centerOnEmployee('${employeeId}')" 
                                style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-crosshairs"></i> التوسيط
                        </button>
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                infoWindow.open(liveMap, marker);
            });
            
            employeeMarkers[employeeId] = marker;
        }
        
        // توسيط الخريطة على موظف محدد
        window.centerOnEmployee = function(employeeId) {
            if (employeeMarkers[employeeId]) {
                liveMap.setCenter(employeeMarkers[employeeId].getPosition());
                liveMap.setZoom(18);
            }
        };
        
        // تهيئة خريطة المودال لتحديد موقع العمل
        function initModalMap() {
            if (typeof google === 'undefined') return;
            
            const mapOptions = {
                center: workLocation,
                zoom: 17,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            
            modalMap = new google.maps.Map(document.getElementById('modalMap'), mapOptions);
            
            // علامة قابلة للسحب
            const marker = new google.maps.Marker({
                position: workLocation,
                map: modalMap,
                draggable: true,
                title: 'اسحبني لتحديد موقع العمل'
            });
            
            // دائرة نصف القطر
            const circle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.1,
                map: modalMap,
                center: workLocation,
                radius: geofenceRadius
            });
            
            // تحديث الدائرة عند سحب العلامة
            marker.addListener('drag', function() {
                circle.setCenter(marker.getPosition());
                workLocation = marker.getPosition();
            });
            
            // تحديد نصف القطر
            const radiusRange = document.getElementById('radiusRange');
            const radiusValue = document.getElementById('radiusValue');
            
            radiusRange.addEventListener('input', function() {
                const radius = parseInt(this.value);
                radiusValue.textContent = `${radius} متر`;
                circle.setRadius(radius);
                geofenceRadius = radius;
            });
            
            // حفظ الإعدادات
            document.getElementById('saveLocation').addEventListener('click', function() {
                database.ref('settings/workLocation').set({
                    lat: workLocation.lat(),
                    lng: workLocation.lng(),
                    radius: geofenceRadius
                }).then(() => {
                    // إعادة تحميل الخريطة المصغرة
                    initMiniMap();
                    
                    // إغلاق المودال
                    bootstrap.Modal.getInstance(document.getElementById('workLocationModal')).hide();
                    
                    alert('تم حفظ موقع العمل بنجاح!');
                });
            });
        }
        
        // تحميل إحصائيات الموظفين
        function loadEmployeeStats() {
            database.ref('employees').once('value')
                .then(snapshot => {
                    const total = snapshot.numChildren();
                    document.getElementById('totalEmployees').textContent = total;
                    
                    // في نظام حقيقي، هنا نحسب الحاضرين والغائبين من سجلات الحضور
                    document.getElementById('presentCount').textContent = Math.floor(total * 0.7); // مثال
                    document.getElementById('absentCount').textContent = Math.floor(total * 0.2); // مثال
                    document.getElementById('lateCount').textContent = Math.floor(total * 0.1); // مثال
                });
        }
        
        // تحديث جدول الحضور الأخير
        function loadRecentAttendance() {
            database.ref('attendance').limitToLast(10).once('value')
                .then(snapshot => {
                    const tbody = document.getElementById('recentAttendance');
                    tbody.innerHTML = '';
                    
                    let counter = 1;
                    snapshot.forEach(employeeSnap => {
                        const employeeId = employeeSnap.key;
                        const records = employeeSnap.val();
                        const latestTimestamp = Object.keys(records).sort().reverse()[0];
                        const latestRecord = records[latestTimestamp];
                        
                        // الحصول على اسم الموظف
                        database.ref('employees/' + employeeId).once('value')
                            .then(employeeData => {
                                if (employeeData.exists()) {
                                    const employee = employeeData.val();
                                    const time = new Date(latestRecord.timestamp).toLocaleTimeString('ar-SA', {
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                    
                                    // حساب المسافة
                                    const distance = calculateDistance(
                                        latestRecord.location.lat,
                                        latestRecord.location.lng,
                                        workLocation.lat,
                                        workLocation.lng
                                    );
                                    
                                    const row = `
                                        <tr>
                                            <td>${counter}</td>
                                            <td>${employee.name}</td>
                                            <td><span class="badge badge-${latestRecord.state === 'IN' ? 'present' : 'absent'}">
                                                ${latestRecord.state === 'IN' ? 'داخل العمل' : 'خارج العمل'}
                                            </span></td>
                                            <td>${time}</td>
                                            <td>${Math.round(distance)} م</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="centerOnEmployee('${employeeId}')">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                    
                                    tbody.innerHTML += row;
                                    counter++;
                                }
                            });
                    });
                });
        }
        
        // دالة حساب المسافة (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // نصف قطر الأرض بالأمتار
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // المسافة بالأمتار
        }
        
        // تحميل إعدادات النظام
        function loadSettings() {
            database.ref('settings/workLocation').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const settings = snapshot.val();
                        workLocation = { lat: settings.lat, lng: settings.lng };
                        geofenceRadius = settings.radius || 20;
                    }
                });
        }
        
        // تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        });
        
        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminSession();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            setupPageNavigation();
            loadSettings();
            
            // تهيئة الخريطة عند تحميل API
            if (typeof google !== 'undefined') {
                initMiniMap();
            } else {
                // إعادة المحاولة بعد ثانيتين
                setTimeout(initMiniMap, 2000);
            }
            
            loadEmployeeStats();
            loadRecentAttendance();
            
            // زر تحديث الحضور
            document.getElementById('refreshAttendance').addEventListener('click', loadRecentAttendance);
            
            // زر توسيط الخريطة
            document.getElementById('centerMap')?.addEventListener('click', function() {
                if (liveMap) {
                    liveMap.setCenter(workLocation);
                    liveMap.setZoom(16);
                }
            });
            
            // زر تحديث المواقع
            document.getElementById('updateLocations')?.addEventListener('click', loadEmployeeLocations);
            
            // تحميل إعدادات موقع العمل عند فتح المودال
            document.getElementById('workLocationModal')?.addEventListener('shown.bs.modal', initModalMap);
        });
        
        // معالجة خطأ تحميل Google Maps API
        window.gm_authFailure = function() {
            alert('حدث خطأ في تحميل خرائط جوجل. يرجى التحقق من مفتاح API.');
        };
    </script>
</body>
</html>
