<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الإعدادات - نظام الحضور والانصراف</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        * { font-family: 'Cairo', sans-serif; }
        body { background-color: #f8f9fa; }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1a2530 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .card-header {
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-bottom: 2px solid #e9ecef;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .setting-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .setting-item:last-child { border-bottom: none; }
        .setting-label { font-weight: 600; color: #2c3e50; }
        .setting-description { color: #7f8c8d; font-size: 0.9rem; margin-top: 5px; }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(30px); }
        
        .color-picker {
            width: 40px; height: 40px;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        
        .danger-zone {
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 20px;
            background: rgba(231, 76, 60, 0.05);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="admin-dashboard.html">
                <i class="fas fa-cogs me-2"></i>
                إعدادات النظام
            </a>
            <a href="admin-dashboard.html" class="btn btn-outline-light">
                <i class="fas fa-arrow-right me-2"></i>
                العودة
            </a>
        </div>
    </nav>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-bars me-2"></i>
                        قائمة الإعدادات
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="#generalSettings" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                            <i class="fas fa-cog me-2"></i>
                            الإعدادات العامة
                        </a>
                        <a href="#attendanceSettings" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="fas fa-clock me-2"></i>
                            إعدادات الحضور
                        </a>
                        <a href="#locationSettings" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            إعدادات الموقع
                        </a>
                        <a href="#securitySettings" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="fas fa-shield-alt me-2"></i>
                            الأمان
                        </a>
                        <a href="#backupSettings" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="fas fa-database me-2"></i>
                            النسخ الاحتياطي
                        </a>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-body text-center">
                        <button class="btn btn-primary w-100 mb-2" id="saveAllSettings">
                            <i class="fas fa-save me-2"></i>
                            حفظ جميع الإعدادات
                        </button>
                        <button class="btn btn-outline-secondary w-100" id="resetSettings">
                            <i class="fas fa-undo me-2"></i>
                            استعادة الإفتراضيات
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-9">
                <div class="tab-content">
                    <!-- General Settings -->
                    <div class="tab-pane fade show active" id="generalSettings">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cog me-2"></i>
                                الإعدادات العامة
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">اسم المؤسسة</div>
                                        <div class="setting-description">الاسم الذي سيظهر في النظام</div>
                                    </div>
                                    <input type="text" class="form-control" id="companyName" style="width: 300px;" value="شركة التقنية المبتكرة">
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">المنطقة الزمنية</div>
                                        <div class="setting-description">المنطقة الزمنية للنظام</div>
                                    </div>
                                    <select class="form-control" id="timezone" style="width: 300px;">
                                        <option value="Asia/Riyadh" selected>الرياض (ت ع م+03:00)</option>
                                        <option value="Asia/Dubai">دبي (ت ع م+04:00)</option>
                                        <option value="Asia/Kuwait">الكويت (ت ع م+03:00)</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">لون السمة الرئيسية</div>
                                        <div class="setting-description">اختيار اللون الرئيسي للنظام</div>
                                    </div>
                                    <input type="color" class="color-picker" id="primaryColor" value="#2c3e50">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendance Settings -->
                    <div class="tab-pane fade" id="attendanceSettings">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-clock me-2"></i>
                                إعدادات الحضور والانصراف
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">وقت بداية الدوام</div>
                                        <div class="setting-description">الوقت الرسمي لبداية الدوام</div>
                                    </div>
                                    <input type="time" class="form-control" id="workStartTime" style="width: 200px;" value="08:00">
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">وقت نهاية الدوام</div>
                                        <div class="setting-description">الوقت الرسمي لنهاية الدوام</div>
                                    </div>
                                    <input type="time" class="form-control" id="workEndTime" style="width: 200px;" value="17:00">
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">تسجيل الدخول المتأخر</div>
                                        <div class="setting-description">اعتبار الموظف متأخراً إذا دخل بعد</div>
                                    </div>
                                    <div class="d-flex align-items-center" style="gap: 10px;">
                                        <input type="number" class="form-control" id="lateThreshold" style="width: 100px;" value="15" min="0">
                                        <span>دقيقة من بداية الدوام</span>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">تفعيل التحقق من الموقع</div>
                                        <div class="setting-description">التأكد من وجود الموظف في موقع العمل</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableLocationCheck" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">نطاق التسجيل (متر)</div>
                                        <div class="setting-description">المسافة المسموحة من موقع العمل</div>
                                    </div>
                                    <div class="d-flex align-items-center" style="gap: 10px;">
                                        <input type="range" class="form-range" id="attendanceRadius" min="10" max="500" value="100" style="width: 200px;">
                                        <span id="radiusValue">100 متر</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Settings -->
                    <div class="tab-pane fade" id="locationSettings">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                إعدادات الموقع الجغرافي
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">موقع العمل الرئيسي</div>
                                        <div class="setting-description">الإحداثيات الجغرافية لموقع العمل</div>
                                    </div>
                                    <div>
                                        <div class="row g-2 mb-2">
                                            <div class="col">
                                                <input type="text" class="form-control" id="locationLat" placeholder="خط العرض" value="24.7136">
                                            </div>
                                            <div class="col">
                                                <input type="text" class="form-control" id="locationLng" placeholder="خط الطول" value="46.6753">
                                            </div>
                                        </div>
                                        <small class="text-muted">إحداثيات الموقع: الرياض، المملكة العربية السعودية</small>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">عنوان موقع العمل</div>
                                        <div class="setting-description">العنوان الوصفي لموقع العمل</div>
                                    </div>
                                    <textarea class="form-control" id="workAddress" style="width: 300px;" rows="3">الرياض - حي العليا - طريق الملك فهد</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div class="tab-pane fade" id="securitySettings">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-shield-alt me-2"></i>
                                إعدادات الأمان
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">قوة كلمة المرور</div>
                                        <div class="setting-description">متطلبات قوة كلمة المرور</div>
                                    </div>
                                    <select class="form-control" id="passwordStrength" style="width: 200px;">
                                        <option value="low">ضعيفة (6 أحرف)</option>
                                        <option value="medium" selected>متوسطة (8 أحرف + أرقام)</option>
                                        <option value="high">قوية (10 أحرف + أرقام + رموز)</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">المحاولات المسموحة</div>
                                        <div class="setting-description">عدد محاولات الدخول الخاطئة قبل القفل</div>
                                    </div>
                                    <div class="d-flex align-items-center" style="gap: 10px;">
                                        <input type="number" class="form-control" id="maxLoginAttempts" style="width: 100px;" value="5" min="1" max="10">
                                        <span>محاولة</span>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">تسجيل النشاط</div>
                                        <div class="setting-description">تسجيل جميع نشاطات المستخدمين</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableActivityLog" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup Settings -->
                    <div class="tab-pane fade" id="backupSettings">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-database me-2"></i>
                                النسخ الاحتياطي والاستعادة
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">النسخ الاحتياطي التلقائي</div>
                                        <div class="setting-description">تفعيل النسخ الاحتياطي التلقائي</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableAutoBackup" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div>
                                        <div class="setting-label">توقيت النسخ الاحتياطي</div>
                                        <div class="setting-description">الوقت اليومي للنسخ الاحتياطي</div>
                                    </div>
                                    <input type="time" class="form-control" id="backupTime" style="width: 200px;" value="02:00">
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-download fa-3x text-primary mb-3"></i>
                                                <h5>إنشاء نسخة احتياطية</h5>
                                                <p class="text-muted">إنشاء نسخة احتياطية يدوية</p>
                                                <button class="btn btn-primary" id="createBackupBtn">
                                                    <i class="fas fa-plus-circle me-2"></i>
                                                    إنشاء نسخة الآن
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-upload fa-3x text-success mb-3"></i>
                                                <h5>استعادة نسخة</h5>
                                                <p class="text-muted">استعادة البيانات من نسخة احتياطية</p>
                                                <input type="file" class="form-control mb-2" id="restoreFile" accept=".json">
                                                <button class="btn btn-success" id="restoreBackupBtn">
                                                    <i class="fas fa-history me-2"></i>
                                                    استعادة الآن
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4J8ncbuejvzfWvzCTAXRzjFgvrchXpE8",
            authDomain: "hedor-bea3c.firebaseapp.com",
            databaseURL: "https://hedor-bea3c-default-rtdb.firebaseio.com",
            projectId: "hedor-bea3c",
            storageBucket: "hedor-bea3c.firebasestorage.app",
            messagingSenderId: "369239455736",
            appId: "1:369239455736:web:116295854269abecf6480d"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        
        function checkUserSession() {
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return false;
            }
            const user = JSON.parse(userData);
            if (user.role !== 'admin') {
                window.location.href = 'employee-dashboard.html';
                return false;
            }
            return true;
        }
        
        async function loadSettings() {
            try {
                const snapshot = await database.ref('settings').once('value');
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    if (settings.general?.companyName) {
                        document.getElementById('companyName').value = settings.general.companyName;
                    }
                    if (settings.attendance?.workStartTime) {
                        document.getElementById('workStartTime').value = settings.attendance.workStartTime;
                    }
                    if (settings.attendance?.workEndTime) {
                        document.getElementById('workEndTime').value = settings.attendance.workEndTime;
                    }
                    if (settings.attendance?.radius) {
                        document.getElementById('attendanceRadius').value = settings.attendance.radius;
                        document.getElementById('radiusValue').textContent = settings.attendance.radius + ' متر';
                    }
                }
            } catch (error) {
                console.error('خطأ في تحميل الإعدادات:', error);
            }
        }
        
        async function saveSettings() {
            const settings = {
                general: {
                    companyName: document.getElementById('companyName').value,
                    timezone: document.getElementById('timezone').value,
                    primaryColor: document.getElementById('primaryColor').value
                },
                attendance: {
                    workStartTime: document.getElementById('workStartTime').value,
                    workEndTime: document.getElementById('workEndTime').value,
                    lateThreshold: document.getElementById('lateThreshold').value,
                    radius: document.getElementById('attendanceRadius').value,
                    enableLocationCheck: document.getElementById('enableLocationCheck').checked
                },
                location: {
                    lat: document.getElementById('locationLat').value,
                    lng: document.getElementById('locationLng').value,
                    address: document.getElementById('workAddress').value
                },
                security: {
                    passwordStrength: document.getElementById('passwordStrength').value,
                    maxLoginAttempts: document.getElementById('maxLoginAttempts').value,
                    enableActivityLog: document.getElementById('enableActivityLog').checked
                },
                backup: {
                    enableAutoBackup: document.getElementById('enableAutoBackup').checked,
                    time: document.getElementById('backupTime').value
                }
            };
            
            try {
                await database.ref('settings').set(settings);
                showNotification('تم حفظ الإعدادات بنجاح', 'success');
            } catch (error) {
                showNotification('حدث خطأ في حفظ الإعدادات', 'danger');
                console.error('خطأ:', error);
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; left: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
        
        document.getElementById('saveAllSettings').addEventListener('click', saveSettings);
        
        document.getElementById('attendanceRadius').addEventListener('input', function() {
            document.getElementById('radiusValue').textContent = this.value + ' متر';
        });
        
        document.getElementById('createBackupBtn').addEventListener('click', async function() {
            try {
                const snapshot = await database.ref().once('value');
                const data = snapshot.val();
                const backupData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                showNotification('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
            } catch (error) {
                showNotification('حدث خطأ في إنشاء النسخة الاحتياطية', 'danger');
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkUserSession()) return;
            loadSettings();
        });
    </script>
</body>
</html>
