<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - V5</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --accent: #f59e0b;
            --bg: #f1f5f9;
            --text: #0f172a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© (Desktop App Style) --- */
        body { 
            background: var(--bg); 
            color: var(--text); 
            height: 100vh; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            overflow: hidden; /* Ù…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            display: flex; 
            flex-direction: column; 
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
        }
        .header h1 { font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }

        /* --- Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ --- */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ */
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø§Ù„ØªÙŠ ØªÙ‚Ø¨Ù„ Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„) --- */
        .workspace {
            flex: 1;
            padding: 20px;
            background: #f8fafc;
            overflow-y: auto; /* Ø§Ù„Ø§Ø³ÙƒØ±ÙˆÙ„ Ù‡Ù†Ø§ ÙÙ‚Ø· */
            position: relative;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: white;
            margin-bottom: 25px;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .upload-area:hover { border-color: var(--primary); background: #eff6ff; }
        .upload-area h3 { color: var(--secondary); margin-bottom: 5px; }

        /* --- Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 20px;
            padding-bottom: 60px;
        }

        .card-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: 0.2s;
            position: relative;
            cursor: grab; /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø­Ø¨ */
        }
        .card-item:active { cursor: grabbing; }
        .card-item.dragging { opacity: 0.4; border: 2px dashed var(--primary); transform: scale(0.95); }
        .card-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .card-preview {
            height: 150px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 10px 10px;
        }
        .card-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            pointer-events: none; /* Ù„Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø®Ø·Ø£ */
        }

        /* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }
        .badge-auto { background: #16a34a; }
        .badge-manual { background: #ea580c; }

        .card-tools {
            display: flex;
            border-top: 1px solid #e2e8f0;
            background: white;
        }
        .tool-btn {
            flex: 1;
            background: transparent;
            border: none;
            border-right: 1px solid #f1f5f9;
            padding: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.2s;
            color: #475569;
        }
        .tool-btn:hover { background: #f1f5f9; color: var(--primary); }
        .tool-btn.delete:hover { background: #fee2e2; color: #dc2626; }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø«Ø§Ø¨ØªØ©) --- */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            box-shadow: -4px 0 15px rgba(0,0,0,0.03);
            z-index: 5;
        }

        .panel-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .panel-title { font-weight: bold; margin-bottom: 10px; color: var(--secondary); font-size: 0.95rem; }

        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600; color: #475569; }
        select, input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }

        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 8px; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-print { background: #16a34a; }
        .btn-img { background: var(--primary); }
        .btn-pdf { background: #ea580c; }
        .btn-danger { background: #ef4444; }
        .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* --- Ø§Ù„ÙÙˆØªØ± --- */
        .footer {
            background: #1e293b;
            color: #94a3b8;
            padding: 10px;
            text-align: center;
            font-size: 0.85rem;
            flex-shrink: 0;
            border-top: 1px solid #334155;
        }
        .footer a { color: #60a5fa; text-decoration: none; font-weight: bold; }
        .footer a:hover { color: white; }

        /* --- Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ (Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }

        .modal-content {
            background: #0f172a; width: 95%; max-width: 1100px; height: 92vh;
            border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        .editor-header { padding: 15px 20px; background: #1e293b; color: white; display: flex; justify-content: space-between; align-items: center; }
        .editor-canvas-wrapper { 
            flex: 1; position: relative; background: #000; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; cursor: crosshair; 
        }
        canvas { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1); max-width: 100%; max-height: 100%; }
        
        .editor-footer { padding: 15px 20px; background: #1e293b; display: flex; justify-content: flex-end; gap: 12px; }

        /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
        #printableArea { position: absolute; top: -9999px; left: -9999px; }
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
            @page { size: A4; margin: 0; }
            .print-page { width: 210mm; height: 297mm; page-break-after: always; padding: 10mm; background: white; }
            .print-grid { display: grid; gap: 5mm; align-content: start; }
            .print-item { border: 1px dashed #e5e7eb; overflow: hidden; display: flex; justify-content: center; align-items: center; }
            .print-item img { width: 100%; height: 100%; object-fit: fill; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>ğŸ“¸ Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª <span style="font-size:0.8rem; opacity:0.8; margin-right:10px;">Pro V5</span></h1>
        <div id="statusBadge" style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; display:flex; align-items:center; gap:5px;">
            <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</span> <span class="spinner">â³</span>
        </div>
    </div>

    <div class="main-layout">
        <div class="workspace">
            <input type="file" id="fileInput" multiple accept="image/*" hidden>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ“¤</div>
                <h3>Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h3>
                <p style="color:#64748b; font-size:0.9rem;">Ø³ÙŠØªÙ… Ø§Ù„Ù‚Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª.</p>
            </div>
            
            <div class="gallery" id="gallery"></div>
        </div>

        <div class="sidebar">
            <div class="panel-box">
                <div class="panel-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
                <div class="control-group">
                    <label>ØªØ®Ø·ÙŠØ· Ø§Ù„ØµÙØ­Ø©</label>
                    <select id="cardsPerRow">
                        <option value="1">Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© (ÙƒØ¨ÙŠØ±Ø©)</option>
                        <option value="2" selected>Ø¨Ø·Ø§Ù‚ØªÙŠÙ† (Ù‚ÙŠØ§Ø³ÙŠ)</option>
                        <option value="3">3 Ø¨Ø·Ø§Ù‚Ø§Øª (ØµØºÙŠØ±Ø©)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
                    <select id="cardSize">
                        <option value="standard">Ø´Ø®ØµÙŠØ© (8.6 Ã— 5.4 Ø³Ù…)</option>
                        <option value="large">ÙƒØ¨ÙŠØ±Ø© (9.0 Ã— 6.0 Ø³Ù…)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø±Ø£Ø³ÙŠØ© (Ù…Ù„Ù…)</label>
                    <input type="number" id="vGap" value="5" min="0" max="50">
                </div>
            </div>

            <div class="panel-box" style="flex:1; display:flex; flex-direction:column; justify-content:flex-end; border:none; background:none; padding:0;">
                <button class="btn-action btn-print" onclick="printCards()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØ±Ù‚Ø©</button>
                <button class="btn-action btn-img" onclick="saveImage()">ğŸ–¼ï¸ Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©</button>
                <button class="btn-action btn-pdf" onclick="savePDF()">ğŸ“„ Ø­ÙØ¸ PDF</button>
                <button class="btn-action btn-danger" onclick="clearAll()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
            </div>
        </div>
    </div>

    <div class="footer">
        Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± <span style="color:#ef4444">â¤</span> <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank">Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</a>
    </div>
</div>

<div class="modal-overlay" id="editorModal">
    <div class="modal-content">
        <div class="editor-header">
            <h3>âœ‚ï¸ Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚</h3>
            <button onclick="closeEditor()" style="background:none; border:none; color:white; font-size:1.8rem; cursor:pointer;">&times;</button>
        </div>
        <div class="editor-canvas-wrapper">
            <canvas id="editorCanvas"></canvas>
        </div>
        <div class="editor-footer">
            <span style="margin-left:auto; color:#94a3b8; font-size:0.9rem;">Ø­Ø±Ùƒ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø±ÙƒØ§Ù† Ø¨Ø¯Ù‚Ø©</span>
            <button class="btn-action" style="width:auto; background:#475569; margin:0;" onclick="closeEditor()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-action btn-print" style="width:auto; margin:0;" onclick="applyManualCrop()">âœ“ Ù‚Øµ ÙˆØ­ÙØ¸</button>
        </div>
    </div>
</div>

<div id="printableArea"></div>

<script>
    let cvReady = false;
    let cards = [];
    let currentEditId = null;
    let dragSrcIndex = null;

    // Editor Global Vars
    let canvas, ctx, originalImg = new Image(), points = [], isDragging = false, dragPoint = -1;

    // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    function onOpenCvReady() {
        cvReady = true;
        const badge = document.getElementById('statusBadge');
        badge.innerHTML = '<span>âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²</span>';
        badge.style.background = '#22c55e';
    }

    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        if(!cvReady) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…...");
        for (const file of e.target.files) {
            await processFile(file);
        }
        e.target.value = '';
    });

    async function processFile(file) {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.src = url;
        await new Promise(r => img.onload = r);

        const id = Date.now() + Math.random();
        
        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© (Priority Logic) ---
        // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ù‚Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡ØŒ Ø¥Ø°Ø§ ÙØ´Ù„ Ù†Ø¹ÙˆØ¯ Ù„Ù„Ø£ØµÙ„
        let processed = url;
        let detectedPoints = null;
        let method = 'manual';

        try {
            const res = autoDetect(img);
            processed = res.url;
            detectedPoints = res.points;
            method = 'auto';
        } catch(e) {
            console.log("ÙØ´Ù„ Ø§Ù„Ù‚Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ");
            // ØªØ¨Ù‚Ù‰ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ…Ø§ Ù‡ÙŠ (url) ÙˆØªÙƒÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø© manual
        }

        cards.push({
            id: id,
            original: url, 
            processed: processed,
            rotation: 0,
            points: detectedPoints,
            method: method
        });
        renderGallery();
    }

    // 3. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ù‚Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (OpenCV)
    function autoDetect(imgElement) {
        let src = cv.imread(imgElement);
        let dst = new cv.Mat();
        let gray = new cv.Mat();
        let blur = new cv.Mat();
        let edges = new cv.Mat();

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆÙ„ÙŠØ©
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
        cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);
        cv.Canny(blur, edges, 75, 200); // Ù‚ÙŠÙ… Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙØ¬ÙˆØ§Øª
        let kernel = cv.Mat.ones(3, 3, cv.CV_8U);
        cv.dilate(edges, edges, kernel, new cv.Point(-1, -1), 1);

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆÙ†ØªÙˆØ±
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let maxArea = 0;
        let bestApprox = null;

        for (let i = 0; i < contours.size(); ++i) {
            let cnt = contours.get(i);
            let area = cv.contourArea(cnt);
            if (area < 5000) continue; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡

            let peri = cv.arcLength(cnt, true);
            let approx = new cv.Mat();
            cv.approxPolyDP(cnt, approx, 0.02 * peri, true);

            if (approx.rows === 4 && area > maxArea) {
                maxArea = area;
                if(bestApprox) bestApprox.delete();
                bestApprox = approx.clone();
            }
            approx.delete();
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¥Ø°Ø§ ÙØ´Ù„
        if (!bestApprox) {
            src.delete(); dst.delete(); gray.delete(); blur.delete(); edges.delete(); contours.delete(); hierarchy.delete();
            throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø©");
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Ù‚Ø§Ø·
        let ptsData = [];
        for(let i=0; i<4; i++) {
            ptsData.push({x: bestApprox.data32S[i*2], y: bestApprox.data32S[i*2+1]});
        }

        // ØªÙ†Ø¸ÙŠÙ Ù†Ù‡Ø§Ø¦ÙŠ
        src.delete(); dst.delete(); gray.delete(); blur.delete(); edges.delete(); contours.delete(); hierarchy.delete(); bestApprox.delete();

        return warpImage(imgElement, ptsData);
    }

    function warpImage(imgSource, rawPoints) {
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‚Ø§Ø· (TL, TR, BR, BL)
        rawPoints.sort((a,b) => a.y - b.y);
        const top = rawPoints.slice(0, 2).sort((a,b) => a.x - b.x);
        const bottom = rawPoints.slice(2, 4).sort((a,b) => a.x - b.x);
        const sorted = [top[0], top[1], bottom[1], bottom[0]];

        let src = cv.imread(imgSource);
        const width = 1000;
        const height = 630; // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©

        let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
            sorted[0].x, sorted[0].y, sorted[1].x, sorted[1].y,
            sorted[2].x, sorted[2].y, sorted[3].x, sorted[3].y
        ]);
        let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, width, 0, width, height, 0, height]);
        
        let M = cv.getPerspectiveTransform(srcTri, dstTri);
        let warped = new cv.Mat();
        cv.warpPerspective(src, warped, M, new cv.Size(width, height), cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());

        let outCanvas = document.createElement('canvas');
        cv.imshow(outCanvas, warped);
        
        // Cleanup
        src.delete(); srcTri.delete(); dstTri.delete(); M.delete(); warped.delete();

        return {
            url: outCanvas.toDataURL('image/jpeg', 0.95),
            points: sorted
        };
    }

    // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø±Ø¶ + Ø§Ù„ØªØ±ØªÙŠØ¨ (Drag & Drop)
    function renderGallery() {
        const gal = document.getElementById('gallery');
        gal.innerHTML = '';
        
        cards.forEach((card, index) => {
            const badgeClass = card.method === 'auto' ? 'badge-auto' : 'badge-manual';
            const badgeText = card.method === 'auto' ? 'âœ“ ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'âš ï¸ ÙŠØ¯ÙˆÙŠ';

            const div = document.createElement('div');
            div.className = 'card-item';
            div.draggable = true; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨
            div.dataset.index = index;

            div.innerHTML = `
                <div class="card-preview">
                    <span class="status-badge ${badgeClass}">${badgeText}</span>
                    <img src="${card.processed}" style="transform: rotate(${card.rotation}deg)">
                </div>
                <div class="card-tools">
                    <button class="tool-btn" onclick="openEditor(${card.id})" title="ØªØ¹Ø¯ÙŠÙ„">âœ‚ï¸</button>
                    <button class="tool-btn" onclick="rotate(${index})" title="ØªØ¯ÙˆÙŠØ±">ğŸ”„</button>
                    <button class="tool-btn delete" onclick="remove(${index})" title="Ø­Ø°Ù">âœ•</button>
                </div>
            `;
            
            addDragEvents(div);
            gal.appendChild(div);
        });
    }

    function addDragEvents(item) {
        item.addEventListener('dragstart', function(e) {
            dragSrcIndex = this.dataset.index;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        });
        item.addEventListener('dragenter', function() { this.style.borderColor = '#2563eb'; });
        item.addEventListener('dragleave', function() { this.style.borderColor = '#e2e8f0'; });
        item.addEventListener('drop', function(e) {
            e.stopPropagation();
            if (dragSrcIndex !== this.dataset.index) {
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                const temp = cards[dragSrcIndex];
                cards[dragSrcIndex] = cards[this.dataset.index];
                cards[this.dataset.index] = temp;
                renderGallery();
            }
            return false;
        });
        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            this.style.borderColor = '#e2e8f0';
        });
    }

    function rotate(idx) { cards[idx].rotation = (cards[idx].rotation + 90) % 360; renderGallery(); }
    function remove(idx) { cards.splice(idx, 1); renderGallery(); }
    function clearAll() { if(confirm("Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§ØªØŸ")) { cards = []; renderGallery(); } }

    // 5. Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ (The Perfect Logic)
    function openEditor(id) {
        currentEditId = id;
        const card = cards.find(c => c.id === id);
        
        const modal = document.getElementById('editorModal');
        modal.classList.add('active');

        canvas = document.getElementById('editorCanvas');
        ctx = canvas.getContext('2d');

        originalImg.src = card.original;
        originalImg.onload = () => {
            canvas.width = originalImg.width;
            canvas.height = originalImg.height;

            if (card.points && card.points.length === 4) {
                points = JSON.parse(JSON.stringify(card.points));
            } else {
                const w = canvas.width, h = canvas.height, p = Math.min(w, h) * 0.1;
                points = [{x: p, y: p}, {x: w-p, y: p}, {x: w-p, y: h-p}, {x: p, y: h-p}];
            }
            draw();
        };
        setupCanvasEvents();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(originalImg, 0, 0);
        
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fillRect(0,0, canvas.width, canvas.height);

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[1].x, points[1].y);
        ctx.lineTo(points[2].x, points[2].y);
        ctx.lineTo(points[3].x, points[3].y);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(originalImg, 0, 0);
        ctx.restore();

        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = Math.max(3, canvas.width * 0.005);
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for(let i=1; i<4; i++) ctx.lineTo(points[i].x, points[i].y);
        ctx.closePath();
        ctx.stroke();

        points.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, Math.max(12, canvas.width * 0.015), 0, Math.PI*2);
            ctx.fillStyle = '#ef4444'; ctx.fill(); 
            ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke();
        });
    }

    function setupCanvasEvents() {
        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
        };

        const start = (e) => {
            const pos = getPos(e);
            const r = Math.max(60, canvas.width * 0.06); // Ù…Ù†Ø·Ù‚Ø© Ù„Ù…Ø³ Ø£ÙƒØ¨Ø±
            for(let i=0; i<4; i++) {
                const dx = pos.x - points[i].x, dy = pos.y - points[i].y;
                if(Math.sqrt(dx*dx + dy*dy) < r) {
                    isDragging = true; dragPoint = i; e.preventDefault(); return;
                }
            }
        };
        const move = (e) => {
            if(!isDragging) return;
            e.preventDefault();
            points[dragPoint] = getPos(e);
            draw();
        };
        const end = () => { isDragging = false; };

        canvas.onmousedown = start; canvas.onmousemove = move; canvas.onmouseup = end;
        canvas.ontouchstart = start; canvas.ontouchmove = move; canvas.ontouchend = end;
    }

    function applyManualCrop() {
        const res = warpImage(originalImg, JSON.parse(JSON.stringify(points)));
        const idx = cards.findIndex(c => c.id === currentEditId);
        if(idx !== -1) {
            cards[idx].processed = res.url;
            cards[idx].points = res.points;
            cards[idx].method = 'manual';
            renderGallery();
        }
        closeEditor();
    }

    function closeEditor() { document.getElementById('editorModal').classList.remove('active'); }

    // 6. Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØµØ¯ÙŠØ±
    function generateOutput() {
        const area = document.getElementById('printableArea');
        const perRow = document.getElementById('cardsPerRow').value;
        const size = document.getElementById('cardSize').value;
        const gap = document.getElementById('vGap').value;
        const w = size === 'standard' ? '86mm' : '90mm';
        const h = size === 'standard' ? '54mm' : '60mm';

        let html = `<div class="print-page"><div class="print-grid" style="grid-template-columns: repeat(${perRow}, ${w}); row-gap: ${gap}mm;">`;
        cards.forEach(card => {
            html += `<div class="print-item" style="width:${w}; height:${h};"><img src="${card.processed}" style="transform: rotate(${card.rotation}deg)"></div>`;
        });
        html += `</div></div>`;
        area.innerHTML = html;
        return area;
    }

    function printCards() {
        if(!cards.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª");
        generateOutput();
        window.print();
    }

    function saveImage() {
        if(!cards.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª");
        generateOutput();
        const element = document.querySelector('.print-page');
        const prevPos = document.getElementById('printableArea').style.position;
        document.getElementById('printableArea').style.position = 'static'; // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ù‚Øª Ù„Ù„Ø±Ø³Ù…
        
        html2canvas(element, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `cards-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            document.getElementById('printableArea').style.position = prevPos;
        });
    }

    function savePDF() {
        if(!cards.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª");
        generateOutput();
        const element = document.querySelector('.print-page');
        const opt = {
            margin: 0,
            filename: `cards-${Date.now()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
</body>
</html>
