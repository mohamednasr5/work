<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --success: #16a34a;
            --bg: #f3f4f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { background: var(--bg); padding: 20px; min-height: 100vh; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            padding: 20px;
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø¹Ø±Ø¶ --- */
        .upload-section {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: #f8fafc;
        }
        .upload-section:hover { border-color: var(--primary); background: #eff6ff; }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .card-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        
        .card-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .card-item img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            background: #333; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
            display: block;
        }

        .card-actions {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #f1f5f9;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 4px;
            transition: 0.2s;
        }
        .btn-icon:hover { background: #e2e8f0; }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
        .sidebar {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
        }

        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; }
        .control-group select, .control-group input {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: 0.2s;
        }
        .btn-primary:hover { filter: brightness(1.1); }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        .status-loading { background: #fef3c7; color: #d97706; }
        .status-ready { background: #dcfce7; color: #15803d; }

        /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø§ØµØ© --- */
        #printableArea {
            display: none; /* Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
        }

        @media print {
            body * {
                visibility: hidden; /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ */
            }
            
            #printableArea {
                display: block !important;
                visibility: visible !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }

            #printableArea * {
                visibility: visible !important;
            }

            .print-grid {
                display: flex;
                flex-wrap: wrap;
                align-content: flex-start;
                padding: 10mm; /* Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„ÙˆØ±Ù‚Ø© */
                gap: 5mm; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
            }

            .print-card {
                /* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø­Ø¯ÙˆØ¯ Ø£Ùˆ Ø®Ù„ÙÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
                box-shadow: none;
                border: 1px dashed #ccc; /* Ø¥Ø·Ø§Ø± Ù‚Øµ Ø®ÙÙŠÙ */
                break-inside: avoid;
            }
            
            .print-card img {
                width: 100%;
                height: 100%;
                object-fit: fill; /* Ù…Ù„Ø¡ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            }
        }

        @media (max-width: 768px) {
            .content-area { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“¸ Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ + Ø·Ø¨Ø§Ø¹Ø© Ø¯Ù‚ÙŠÙ‚Ø©</p>
    </div>

    <div class="content-area">
        <main>
            <div id="cvStatus" class="status-badge status-loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒÙŠ...</div>
            
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none">
            <div class="upload-section" onclick="document.getElementById('fileInput').click()">
                <h2>ğŸ“¤ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h2>
                <p>ÙŠÙØ¶Ù„ ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù„Ù‰ Ø®Ù„ÙÙŠØ© Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù</p>
            </div>

            <div class="gallery-grid" id="gallery">
                </div>
        </main>

        <aside class="sidebar">
            <div class="control-group">
                <label>ğŸ–¨ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</label>
                <select id="printSize">
                    <option value="standard">Ø­Ø¬Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (8.6 Ã— 5.4 Ø³Ù…)</option>
                    <option value="large">Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± (9 Ã— 6 Ø³Ù…)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ØªØ®Ø·ÙŠØ· Ø§Ù„ØµÙØ­Ø©</label>
                <select id="cardsPerRow">
                    <option value="2">2 Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„ØµÙ</option>
                    <option value="3">3 Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„ØµÙ</option>
                </select>
            </div>

            <button class="btn-primary" onclick="prepareAndPrint()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØ±Ù‚Ø©</button>
            <button class="btn-primary" style="background: #ef4444;" onclick="clearAll()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </aside>
    </div>
</div>

<div id="printableArea"></div>

<script>
    let cardsData = []; // Store original and processed images
    let cvReady = false;

    // 1. ØªÙ‡ÙŠØ¦Ø© Ù…ÙƒØªØ¨Ø© OpenCV
    function onOpenCvReady() {
        cvReady = true;
        const status = document.getElementById('cvStatus');
        status.textContent = "âœ“ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©";
        status.className = "status-badge status-ready";
    }

    // 2. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        if (!cvReady) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…..."); return; }
        
        const files = Array.from(e.target.files);
        for (const file of files) {
            await processUploadedFile(file);
        }
        e.target.value = ''; // Reset input
    });

    async function processUploadedFile(file) {
        const imgUrl = URL.createObjectURL(file);
        const img = new Image();
        img.src = imgUrl;
        
        await new Promise(r => img.onload = r);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        const cardObj = {
            id: Date.now() + Math.random(),
            original: img,
            processed: imgUrl, // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            isProcessed: false
        };
        cardsData.push(cardObj);
        renderGallery();

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù‚Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        try {
            const processedUrl = autoCropCard(img);
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚ØµÙˆØµØ©
            const index = cardsData.findIndex(c => c.id === cardObj.id);
            if (index !== -1) {
                cardsData[index].processed = processedUrl;
                cardsData[index].isProcessed = true;
                renderGallery(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            }
        } catch (err) {
            console.error("ÙØ´Ù„ Ø§Ù„Ù‚Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ØµÙ„ÙŠØ©", err);
        }
    }

    // 3. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆÙ‚ØµÙ‡Ø§ (OpenCV Logic)
    function autoCropCard(imgElement) {
        // Ø¥Ù†Ø´Ø§Ø¡ Canvas Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // ØªÙ‚Ù„ÙŠØµ Ø§Ù„Ø­Ø¬Ù… Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Max width 1000px)
        const scale = Math.min(1000 / imgElement.width, 1);
        canvas.width = imgElement.width * scale;
        canvas.height = imgElement.height * scale;
        ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);

        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© OpenCV
        let src = cv.imread(canvas);
        let dst = new cv.Mat();
        let gray = new cv.Mat();
        let blur = new cv.Mat();
        let edges = new cv.Mat();

        // 1. ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø±Ù…Ø§Ø¯ÙŠ
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
        
        // 2. ØªÙ…ÙˆÙŠÙ‡ Ø®ÙÙŠÙ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
        cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);
        
        // 3. ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù (Canny)
        // Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‡Ù†Ø§ Ø­Ø³Ø§Ø³Ø© Ù„Ù„Ø¥Ø¶Ø§Ø¡Ø©ØŒ 75 Ùˆ 200 ØªØ¹Ù…Ù„ Ø¬ÙŠØ¯Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        cv.Canny(blur, edges, 75, 200);

        // 4. Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„ÙƒÙˆÙ†ØªÙˆØ± (Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…ØºÙ„Ù‚Ø©)
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        // 5. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙƒØ¨Ø± Ù…Ø³ØªØ·ÙŠÙ„
        let maxArea = 0;
        let maxContourIndex = -1;
        let approx = new cv.Mat();
        let bestApprox = null;

        for (let i = 0; i < contours.size(); ++i) {
            let cnt = contours.get(i);
            let area = cv.contourArea(cnt);
            
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
            if (area < 5000) continue;

            // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø´ÙƒÙ„ Ø¥Ù„Ù‰ Ù…Ø¶Ù„Ø¹
            let peri = cv.arcLength(cnt, true);
            cv.approxPolyDP(cnt, approx, 0.02 * peri, true);

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¶Ù„Ø¹ Ù„Ù‡ 4 Ø²ÙˆØ§ÙŠØ§ ÙˆÙ‡Ùˆ Ø§Ù„Ø£ÙƒØ¨Ø± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
            if (approx.rows === 4 && area > maxArea) {
                maxArea = area;
                maxContourIndex = i;
                // Ù†Ø³Ø® Ø§Ù„Ù†Ù‚Ø§Ø·
                bestApprox = approx.clone(); 
            }
        }

        // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù…Ø³ØªØ·ÙŠÙ„ ÙˆØ§Ø¶Ø­ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        if (maxContourIndex === -1 || !bestApprox) {
            src.delete(); dst.delete(); gray.delete(); blur.delete(); edges.delete(); contours.delete(); hierarchy.delete(); approx.delete();
            throw new Error("No card found");
        }

        // 6. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù†Ø¸ÙˆØ± (Perspective Warp)
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© (Ø£Ø¹Ù„Ù‰-ÙŠØ³Ø§Ø±ØŒ Ø£Ø¹Ù„Ù‰-ÙŠÙ…ÙŠÙ†ØŒ Ø£Ø³ÙÙ„-ÙŠÙ…ÙŠÙ†ØŒ Ø£Ø³ÙÙ„-ÙŠØ³Ø§Ø±)
        let pts = [];
        for(let i=0; i<4; i++) {
            pts.push({
                x: bestApprox.data32S[i*2],
                y: bestApprox.data32S[i*2+1]
            });
        }
        const sortedPts = sortPoints(pts);

        // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© 8.56 : 5.4)
        // Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©
        const width = 1000; 
        const height = 1000 * (5.4 / 8.56); // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯

        let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
            sortedPts[0].x, sortedPts[0].y,
            sortedPts[1].x, sortedPts[1].y,
            sortedPts[2].x, sortedPts[2].y,
            sortedPts[3].x, sortedPts[3].y
        ]);

        let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
            0, 0,
            width, 0,
            width, height,
            0, height
        ]);

        let M = cv.getPerspectiveTransform(srcTri, dstTri);
        let warped = new cv.Mat();
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Øµ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© (src)
        cv.warpPerspective(src, warped, M, new cv.Size(width, height), cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        cv.imshow(canvas, warped);
        const resultUrl = canvas.toDataURL('image/jpeg', 0.9);

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        src.delete(); dst.delete(); gray.delete(); blur.delete(); edges.delete(); 
        contours.delete(); hierarchy.delete(); approx.delete(); bestApprox.delete();
        srcTri.delete(); dstTri.delete(); M.delete(); warped.delete();

        return resultUrl;
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
    function sortPoints(pts) {
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Y Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„
        pts.sort((a,b) => a.y - b.y);
        
        // Ø£ÙˆÙ„ Ù†Ù‚Ø·ØªÙŠÙ† Ù‡Ù…Ø§ Ø§Ù„Ø£Ø¹Ù„Ù‰ØŒ Ø¢Ø®Ø± Ù†Ù‚Ø·ØªÙŠÙ† Ù‡Ù…Ø§ Ø§Ù„Ø£Ø³ÙÙ„
        const top = pts.slice(0, 2).sort((a,b) => a.x - b.x); // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø­Ø³Ø¨ X (ÙŠØ³Ø§Ø± ÙˆÙŠÙ…ÙŠÙ†)
        const bottom = pts.slice(2, 4).sort((a,b) => a.x - b.x); // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³ÙÙ„ Ø­Ø³Ø¨ X
        
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: TL, TR, BR, BL
        return [top[0], top[1], bottom[1], bottom[0]];
    }

    // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø±Ø¶
    function renderGallery() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = '';
        cardsData.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card-item';
            div.innerHTML = `
                <img src="${card.processed}" alt="Card">
                <div class="card-actions">
                    <button class="btn-icon" onclick="rotateCard(${card.id})" title="ØªØ¯ÙˆÙŠØ±">ğŸ”„</button>
                    <button class="btn-icon" onclick="revertCard(${card.id})" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚Øµ">â†©ï¸</button>
                    <button class="btn-icon" style="color:red" onclick="removeCard(${card.id})" title="Ø­Ø°Ù">âœ•</button>
                </div>
            `;
            gallery.appendChild(div);
        });
    }

    // 5. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
    function removeCard(id) {
        cardsData = cardsData.filter(c => c.id !== id);
        renderGallery();
    }

    function revertCard(id) {
        const card = cardsData.find(c => c.id === id);
        if(card) {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù€ canvas ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù€ url
            const canvas = document.createElement('canvas');
            canvas.width = card.original.width;
            canvas.height = card.original.height;
            canvas.getContext('2d').drawImage(card.original, 0, 0);
            card.processed = canvas.toDataURL();
            renderGallery();
        }
    }

    function rotateCard(id) {
        const card = cardsData.find(c => c.id === id);
        if(card) {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.height;
                canvas.height = img.width;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(img, -img.width/2, -img.height/2);
                card.processed = canvas.toDataURL();
                renderGallery();
            };
            img.src = card.processed;
        }
    }

    function clearAll() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ")) {
            cardsData = [];
            renderGallery();
        }
    }

    // 6. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø¬Ø°Ø±ÙŠØ§Ù‹)
    function prepareAndPrint() {
        if (cardsData.length === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©"); return; }

        const printableArea = document.getElementById('printableArea');
        const sizeMode = document.getElementById('printSize').value;
        const perRow = document.getElementById('cardsPerRow').value;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Ø¨Ø§Ù„Ù…Ù„ÙŠÙ…ØªØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø© ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
        let widthCss = sizeMode === 'standard' ? '86mm' : '90mm';
        let heightCss = sizeMode === 'standard' ? '54mm' : '60mm';

        let html = `<div class="print-grid" style="display: grid; grid-template-columns: repeat(${perRow}, ${widthCss}); gap: 5mm;">`;
        
        cardsData.forEach(card => {
            html += `
                <div class="print-card" style="width: ${widthCss}; height: ${heightCss}; overflow: hidden;">
                    <img src="${card.processed}" style="width: 100%; height: 100%;">
                </div>
            `;
        });
        html += `</div>`;

        printableArea.innerHTML = html;

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        window.print();
        
        // ØªÙ†Ø¸ÙŠÙ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // setTimeout(() => printableArea.innerHTML = '', 1000);
    }
</script>

</body>
</html>
