<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام الحضور والانصراف الذكي</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: linear-gradient(135deg, #48c774 0%, #3EB489 100%);
            --danger: linear-gradient(135deg, #f14668 0%, #D63864 100%);
            --warning: linear-gradient(135deg, #ffdd57 0%, #F7A400 100%);
            --info: linear-gradient(135deg, #3e8ed0 0%, #2E6FB3 100%);
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --shadow: 0 20px 60px rgba(0,0,0,0.3);
            --shadow-lg: 0 30px 80px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* خلفية متحركة ثلاثية الأبعاد */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(118,75,162,0.2) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        /* حبيبات متحركة */
        .particle {
            position: absolute;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            animation: rise 15s infinite ease-in;
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                opacity: 0;
                transform: translateX(0) scale(1);
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                bottom: 100%;
                opacity: 0;
                transform: translateX(100px) scale(0.5);
            }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header احترافي */
        .header {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideDown 0.8s ease-out;
            transform-style: preserve-3d;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100px) rotateX(-90deg);
                opacity: 0;
            }
            to {
                transform: translateY(0) rotateX(0);
                opacity: 1;
            }
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 2px 2px 20px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 2px 2px 20px rgba(255,255,255,0.3); }
            50% { text-shadow: 2px 2px 40px rgba(255,255,255,0.6); }
        }

        .clock {
            display: flex;
            justify-content: space-around;
            align-items: center;
            color: white;
            font-size: 1.2em;
            margin-top: 15px;
        }

        .clock-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transform: perspective(1000px) rotateY(0deg);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .clock-item:hover {
            transform: perspective(1000px) rotateY(15deg) scale(1.1);
            background: rgba(255,255,255,0.2);
        }

        /* بطاقات ثلاثية الأبعاد */
        .card-3d {
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            transform-style: preserve-3d;
            perspective: 1000px;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }

        .card-3d::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
        }

        .card-3d:hover::before {
            left: 100%;
        }

        .card-3d:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow: var(--shadow-lg);
        }

        /* خريطة احترافية */
        #map {
            width: 100%;
            height: 500px;
            border-radius: 20px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 10px 30px rgba(102,126,234,0.3); }
            50% { box-shadow: 0 10px 50px rgba(102,126,234,0.6); }
        }

        /* أزرار احترافية ثلاثية الأبعاد */
        .btn-3d {
            padding: 18px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform-style: preserve-3d;
        }

        .btn-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-3d:hover::before {
            left: 100%;
        }

        .btn-3d:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        }

        .btn-3d:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-checkin {
            background: var(--success);
        }

        .btn-checkout {
            background: var(--danger);
        }

        .btn-primary {
            background: var(--primary);
        }

        /* إدخال احترافي */
        .input-3d {
            width: 100%;
            padding: 18px 25px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: white;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .input-3d:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 5px rgba(102,126,234,0.1), inset 0 2px 5px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        /* سجلات اليوم */
        .records-container {
            display: grid;
            gap: 20px;
        }

        .record-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: perspective(1000px);
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .record-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .record-card:hover::after {
            left: 100%;
        }

        .record-card:hover {
            transform: perspective(1000px) rotateY(-5deg) translateX(10px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

        /* معلومات الموقع */
        .location-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .accuracy-meter {
            background: rgba(255,255,255,0.2);
            height: 10px;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #48c774, #3EB489);
            border-radius: 10px;
            transition: width 0.5s;
            box-shadow: 0 0 10px rgba(72,199,116,0.5);
        }

        /* حالة التحميل */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* تنبيهات */
        .alert {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            animation: slideIn 0.5s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #48c774 0%, #3EB489 100%);
            color: white;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f14668 0%, #D63864 100%);
            color: white;
        }

        .alert-info {
            background: linear-gradient(135deg, #3e8ed0 0%, #2E6FB3 100%);
            color: white;
        }

        /* استجابة للموبايل */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .clock {
                flex-direction: column;
                gap: 10px;
            }

            #map {
                height: 400px;
            }

            .btn-3d {
                padding: 15px 30px;
                font-size: 1em;
            }
        }

        /* تأثيرات إضافية */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- خلفية متحركة -->
    <div class="animated-bg"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-briefcase"></i> نظام الحضور والانصراف الذكي</h1>
            <div class="clock">
                <div class="clock-item">
                    <i class="fas fa-calendar-day"></i>
                    <div id="currentDate">...</div>
                </div>
                <div class="clock-item">
                    <i class="fas fa-clock"></i>
                    <div id="currentTime">...</div>
                </div>
            </div>
        </div>

        <!-- تسجيل الدخول -->
        <div id="loginSection" class="card-3d fade-in">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 25px;">
                <i class="fas fa-user-lock"></i> تسجيل الدخول
            </h2>
            <input type="text" id="employeeId" class="input-3d" placeholder="أدخل رقم الموظف">
            <button onclick="login()" class="btn-3d btn-primary" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> دخول
            </button>
        </div>

        <!-- القسم الرئيسي -->
        <div id="mainSection" style="display: none;">
            <!-- معلومات الموظف -->
            <div class="card-3d fade-in">
                <h2 style="color: #667eea; margin-bottom: 20px;">
                    <i class="fas fa-user"></i> معلومات الموظف
                </h2>
                <div id="employeeInfo"></div>
            </div>

            <!-- الخريطة -->
            <div class="card-3d fade-in">
                <h2 style="color: #667eea; margin-bottom: 20px;">
                    <i class="fas fa-map-marked-alt"></i> موقعك الحالي
                </h2>
                <div id="map"></div>
                <div class="location-info">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <i class="fas fa-crosshairs"></i> دقة الموقع:
                            <strong id="accuracyValue">جاري التحديد...</strong>
                        </div>
                        <div>
                            <i class="fas fa-ruler"></i> المسافة من العمل:
                            <strong id="distanceValue">...</strong>
                        </div>
                    </div>
                    <div class="accuracy-meter">
                        <div id="accuracyBar" class="accuracy-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- أزرار الحضور والانصراف -->
            <div class="card-3d fade-in" style="text-align: center;">
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="checkIn()" class="btn-3d btn-checkin">
                        <i class="fas fa-sign-in-alt"></i> تسجيل حضور
                    </button>
                    <button onclick="checkOut()" class="btn-3d btn-checkout">
                        <i class="fas fa-sign-out-alt"></i> تسجيل انصراف
                    </button>
                </div>
            </div>

            <!-- سجلات اليوم -->
            <div class="card-3d fade-in">
                <h2 style="color: #667eea; margin-bottom: 20px;">
                    <i class="fas fa-history"></i> سجلات اليوم
                </h2>
                <div id="todayRecords" class="records-container"></div>
            </div>
        </div>

        <!-- تنبيهات -->
        <div id="alertContainer"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?language=ar"></script>

    <script>
        // إضافة الحبيبات المتحركة
        for(let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.width = Math.random() * 10 + 5 + 'px';
            particle.style.height = particle.style.width;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 15 + 's';
            particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
            document.querySelector('.animated-bg').appendChild(particle);
        }

         // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4J8ncbuejvzfWvzCTAXRzjFg_vrchXpE",
            authDomain: "hedor-bea3c.firebaseapp.com",
            databaseURL: "https://hedor-bea3c-default-rtdb.firebaseio.com",
            projectId: "hedor-bea3c",
            storageBucket: "hedor-bea3c.firebasestorage.app",
            messagingSenderId: "369239455736",
            appId: "1:369239455736:web:116295854269abecf6480d",
            measurementId: "G-R2MG1YKQEP"
        };


        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // متغيرات عامة
        let currentUser = null;
        let map = null;
        let userMarker = null;
        let workplaceMarker = null;
        let accuracyCircle = null;
        let watchId = null;
        let workplaceLocation = null;

        // تحديث الساعة
        function updateClock() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-EG', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ar-EG');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // تسجيل الدخول
        async function login() {
            const employeeId = document.getElementById('employeeId').value.trim();
            
            if (!employeeId) {
                showAlert('يرجى إدخال رقم الموظف', 'danger');
                return;
            }

            try {
                const snapshot = await database.ref('employees/' + employeeId).once('value');
                
                if (snapshot.exists()) {
                    currentUser = {
                        id: employeeId,
                        ...snapshot.val()
                    };
                    
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('mainSection').style.display = 'block';
                    
                    showEmployeeInfo();
                    initMap();
                    loadTodayRecords();
                    
                    showAlert('مرحباً ' + currentUser.name, 'success');
                } else {
                    showAlert('رقم الموظف غير موجود', 'danger');
                }
            } catch (error) {
                console.error('خطأ في تسجيل الدخول:', error);
                showAlert('حدث خطأ أثناء تسجيل الدخول', 'danger');
            }
        }

        // عرض معلومات الموظف
        function showEmployeeInfo() {
            document.getElementById('employeeInfo').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px;">
                        <i class="fas fa-id-badge" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <div><strong>الرقم:</strong> ${currentUser.id}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #48c774 0%, #3EB489 100%); color: white; border-radius: 15px;">
                        <i class="fas fa-user" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <div><strong>الاسم:</strong> ${currentUser.name}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #3e8ed0 0%, #2E6FB3 100%); color: white; border-radius: 15px;">
                        <i class="fas fa-briefcase" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <div><strong>القسم:</strong> ${currentUser.department || 'غير محدد'}</div>
                    </div>
                </div>
            `;
        }

        // تهيئة الخريطة
        async function initMap() {
            // جلب موقع العمل من Firebase
            const workplaceSnapshot = await database.ref('settings/workplace').once('value');
            workplaceLocation = workplaceSnapshot.val() || { lat: 30.0444, lng: 31.2357 }; // القاهرة كموقع افتراضي

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18,
                center: workplaceLocation,
                mapTypeId: 'hybrid',
                disableDefaultUI: false,
                zoomControl: true,
                mapTypeControl: true,
                scaleControl: true,
                streetViewControl: true,
                rotateControl: true,
                fullscreenControl: true,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'on' }]
                    }
                ]
            });

            // علامة موقع العمل
            workplaceMarker = new google.maps.Marker({
                position: workplaceLocation,
                map: map,
                title: 'موقع العمل',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: '#f14668',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                animation: google.maps.Animation.BOUNCE
            });

            // دائرة حول موقع العمل
            new google.maps.Circle({
                map: map,
                center: workplaceLocation,
                radius: 100, // 100 متر
                fillColor: '#f14668',
                fillOpacity: 0.2,
                strokeColor: '#f14668',
                strokeOpacity: 0.8,
                strokeWeight: 2
            });

            // بدء تتبع الموقع
            startLocationTracking();
        }

        // تتبع الموقع بدقة عالية جداً
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                const options = {
                    enableHighAccuracy: true,  // دقة عالية جداً
                    timeout: 5000,
                    maximumAge: 0
                };

                watchId = navigator.geolocation.watchPosition(
                    updatePosition,
                    handleLocationError,
                    options
                );
            } else {
                showAlert('المتصفح لا يدعم تحديد الموقع', 'danger');
            }
        }

        // تحديث الموقع
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            const userLocation = { lat, lng };

            // تحديث/إنشاء علامة المستخدم
            if (userMarker) {
                userMarker.setPosition(userLocation);
            } else {
                userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'موقعك الحالي',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#48c774',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    },
                    animation: google.maps.Animation.DROP
                });
            }

            // تحديث/إنشاء دائرة الدقة
            if (accuracyCircle) {
                accuracyCircle.setCenter(userLocation);
                accuracyCircle.setRadius(accuracy);
            } else {
                accuracyCircle = new google.maps.Circle({
                    map: map,
                    center: userLocation,
                    radius: accuracy,
                    fillColor: '#48c774',
                    fillOpacity: 0.15,
                    strokeColor: '#48c774',
                    strokeOpacity: 0.6,
                    strokeWeight: 1
                });
            }

            // حساب المسافة من موقع العمل
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(lat, lng),
                new google.maps.LatLng(workplaceLocation.lat, workplaceLocation.lng)
            );

            // تحديث المعلومات
            updateLocationInfo(accuracy, distance);

            // تحريك الخريطة
            map.panTo(userLocation);
        }

        // تحديث معلومات الموقع
        function updateLocationInfo(accuracy, distance) {
            // تحديث الدقة
            document.getElementById('accuracyValue').textContent = accuracy.toFixed(1) + ' متر';
            
            // حساب نسبة الدقة (كلما كانت القيمة أقل كانت أفضل)
            let accuracyPercent = Math.max(0, Math.min(100, (30 - accuracy) / 30 * 100));
            document.getElementById('accuracyBar').style.width = accuracyPercent + '%';

            // تحديث المسافة
            document.getElementById('distanceValue').textContent = distance.toFixed(1) + ' متر';

            // تغيير اللون حسب الدقة
            if (accuracy <= 5) {
                document.getElementById('accuracyBar').style.background = 'linear-gradient(90deg, #48c774, #3EB489)';
            } else if (accuracy <= 15) {
                document.getElementById('accuracyBar').style.background = 'linear-gradient(90deg, #ffdd57, #F7A400)';
            } else {
                document.getElementById('accuracyBar').style.background = 'linear-gradient(90deg, #f14668, #D63864)';
            }
        }

        // معالجة أخطاء الموقع
        function handleLocationError(error) {
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'يرجى السماح بالوصول إلى الموقع';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'معلومات الموقع غير متوفرة';
                    break;
                case error.TIMEOUT:
                    message = 'انتهت مهلة طلب الموقع';
                    break;
                default:
                    message = 'خطأ غير معروف في تحديد الموقع';
            }
            showAlert(message, 'danger');
        }

        // تسجيل حضور
        async function checkIn() {
            if (!userMarker) {
                showAlert('يرجى الانتظار حتى يتم تحديد موقعك', 'info');
                return;
            }

            const position = userMarker.getPosition();
            const record = {
                employeeId: currentUser.id,
                employeeName: currentUser.name,
                type: 'حضور',
                timestamp: Date.now(),
                date: new Date().toLocaleDateString('ar-EG'),
                time: new Date().toLocaleTimeString('ar-EG'),
                location: {
                    lat: position.lat(),
                    lng: position.lng()
                }
            };

            try {
                await database.ref('attendance').push(record);
                showAlert('تم تسجيل الحضور بنجاح', 'success');
                loadTodayRecords();
            } catch (error) {
                console.error('خطأ:', error);
                showAlert('حدث خطأ أثناء تسجيل الحضور', 'danger');
            }
        }

        // تسجيل انصراف
        async function checkOut() {
            if (!userMarker) {
                showAlert('يرجى الانتظار حتى يتم تحديد موقعك', 'info');
                return;
            }

            const position = userMarker.getPosition();
            const record = {
                employeeId: currentUser.id,
                employeeName: currentUser.name,
                type: 'انصراف',
                timestamp: Date.now(),
                date: new Date().toLocaleDateString('ar-EG'),
                time: new Date().toLocaleTimeString('ar-EG'),
                location: {
                    lat: position.lat(),
                    lng: position.lng()
                }
            };

            try {
                await database.ref('attendance').push(record);
                showAlert('تم تسجيل الانصراف بنجاح', 'success');
                loadTodayRecords();
            } catch (error) {
                console.error('خطأ:', error);
                showAlert('حدث خطأ أثناء تسجيل الانصراف', 'danger');
            }
        }

        // تحميل سجلات اليوم
        async function loadTodayRecords() {
            const today = new Date().toLocaleDateString('ar-EG');
            
            try {
                const snapshot = await database.ref('attendance')
                    .orderByChild('employeeId')
                    .equalTo(currentUser.id)
                    .once('value');

                const records = [];
                snapshot.forEach(child => {
                    const record = child.val();
                    if (record.date === today) {
                        records.push(record);
                    }
                });

                displayRecords(records);
            } catch (error) {
                console.error('خطأ:', error);
            }
        }

        // عرض السجلات
        function displayRecords(records) {
            const container = document.getElementById('todayRecords');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">لا توجد سجلات اليوم</p>';
                return;
            }

            container.innerHTML = records.map(record => `
                <div class="record-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: ${record.type === 'حضور' ? '#48c774' : '#f14668'};">
                                <i class="fas fa-${record.type === 'حضور' ? 'sign-in-alt' : 'sign-out-alt'}"></i>
                                ${record.type}
                            </h3>
                            <p style="margin: 5px 0;">
                                <i class="fas fa-clock"></i> ${record.time}
                            </p>
                        </div>
                        <div style="text-align: left;">
                            <i class="fas fa-map-marker-alt" style="font-size: 2em; color: #667eea;"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // عرض تنبيه
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            container.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideIn 0.5s reverse';
                setTimeout(() => alert.remove(), 500);
            }, 3000);
        }

        // تسجيل Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker مسجل', reg))
                .catch(err => console.log('خطأ في تسجيل Service Worker', err));
        }
    </script>
    
    <!-- مكتبة الهندسة لـ Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry"></script>
</body>
</html>
