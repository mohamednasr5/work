<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            /* Added Info/Purple for Ihtia */
            --info: #8b5cf6; 
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --nav-height-mobile: 65px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--background); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* --- Sidebar (Desktop) --- */
        .sidebar { width: 280px; background: var(--surface); height: 100%; display: flex; flex-direction: column; padding: 20px; box-shadow: var(--shadow); z-index: 100; transition: transform 0.3s ease; }
        .logo { display: flex; align-items: center; gap: 15px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0; }
        .logo i { font-size: 2rem; color: var(--primary); }
        .logo h2 { font-size: 1.1rem; font-weight: 800; line-height: 1.4; color: var(--text-main); }
        .nav-links { list-style: none; flex: 1; }
        .nav-links li { margin-bottom: 10px; padding: 12px 15px; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; color: var(--text-light); font-weight: 600; }
        .nav-links li:hover { background-color: #eff6ff; color: var(--primary); }
        .nav-links li.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transform: scale(1.02); }
        .nav-links li i { font-size: 1.2rem; width: 24px; text-align: center; }

        /* --- Main Content --- */
        .main-content { flex: 1; height: 100%; overflow-y: auto; padding: 20px; padding-bottom: calc(var(--nav-height-mobile) + 20px); position: relative; scroll-behavior: smooth; }
        .header-3d h1 { font-size: 1.8rem; font-weight: 900; background: linear-gradient(135deg, var(--text-main), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .glass-panel { background: var(--glass-bg); border: var(--glass-border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); backdrop-filter: blur(10px); }

        /* --- Tabs Logic --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .stat-card.total::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.danger::before { background: var(--danger); }
        /* New Card Style */
        .stat-card.info::before { background: var(--info); }
        
        .stat-card .icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-light); margin-bottom: 5px; }
        .stat-card .number { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }

        /* --- Authority Report Styles --- */
        .authority-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .authority-card { 
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; 
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
        }
        .authority-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--primary); }
        .authority-card h4 { font-size: 0.95rem; margin-bottom: 10px; color: var(--text-main); line-height: 1.4; height: 40px; overflow: hidden; }
        .authority-count { 
            font-size: 1.5rem; font-weight: 800; color: var(--primary); 
            background: #eff6ff; padding: 5px 10px; border-radius: 8px; display: inline-block;
        }
        .authority-card:hover .authority-count { background: var(--primary); color: white; }

        /* --- Forms --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group.full-width { grid-column: 1 / -1; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; transition: border-color 0.2s; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--primary); }

        /* --- Buttons --- */
        .btn-3d { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 12px 25px; border-radius: 10px; font-family: inherit; font-weight: 700; cursor: pointer; box-shadow: 0 4px 0 #1e3a8a; transition: all 0.1s; display: inline-flex; align-items: center; gap: 8px; font-size: 1rem; }
        .btn-3d:active { transform: translateY(4px); box-shadow: none; }
        .btn-3d.secondary { background: linear-gradient(135deg, #64748b, #475569); box-shadow: 0 4px 0 #334155; }

        /* --- Table --- */
        .table-responsive { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: var(--surface); min-width: 600px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #f1f5f9; white-space: nowrap; }
        th { background-color: #f8fafc; color: var(--text-light); font-weight: 700; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-execution { background: #fff7ed; color: #c2410c; }
        .status-review { background: #eff6ff; color: #1d4ed8; }
        .status-completed { background: #ecfdf5; color: #047857; }
        .status-rejected { background: #fef2f2; color: #b91c1c; }

        /* --- Reports & AI --- */
        .report-controls { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 12px; align-items: end; }
        .ai-badge { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; margin-right: 5px; }
        .ai-result-box { background: #f5f3ff; border: 1px solid #ddd6fe; padding: 15px; border-radius: 12px; margin-top: 15px; display: none; }
        .ai-result-box.active { display: block; animation: fadeIn 0.5s; }
        .ai-number-display { 
            font-size: 2.5rem; 
            font-weight: 900; 
            color: #6366f1; 
            cursor: pointer; 
            transition: transform 0.2s; 
            display: inline-block;
        }
        .ai-number-display:hover { transform: scale(1.05); color: #4f46e5; text-decoration: underline; }

        /* --- Mobile Navigation --- */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); background: var(--surface); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.7rem; gap: 4px; width: 100%; height: 100%; cursor: pointer; transition: all 0.2s; }
        .mobile-nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .mobile-nav-item i { font-size: 1.3rem; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--surface); border-radius: var(--radius); width: 100%; max-width: 500px; overflow: hidden; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content.large { max-width: 900px; }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text-light); z-index: 10; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-actions { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #e2e8f0; }
        .btn-action { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 5px; }

        /* --- Documents Section Toggle --- */
        #documentsSection { display: none; background: #f8fafc; padding: 15px; border-radius: 12px; border: 2px dashed #cbd5e1; margin-top: 15px; }
        #documentsSection.active { display: block; animation: fadeIn 0.3s; }
        .doc-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .doc-item { display: flex; gap: 10px; align-items: center; background: white; padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .doc-item input { flex: 1; border: none; padding: 5px; }

        /* --- Footer --- */
        .app-footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; color: var(--text-light); font-size: 0.9rem; }
        .footer-content { display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .footer-social-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; }
        .facebook { background: #1877f2; }
        .github { background: #333; }

        /* --- PRINT STYLES (A4 Professional) --- */
        #printArea { display: none; } /* Hidden on screen */

        @media print {
            body { 
                background: white; 
                height: auto; 
                overflow: visible; 
                display: block; 
                margin: 0; 
                padding: 0;
            }
            
            /* Hide everything */
            aside, nav.mobile-nav, .header-3d, .modal-overlay, .btn-action, .btn-3d, .stats-grid, .no-print, .close-modal, #searchInput, .report-controls, .ai-result-box, #alertsContent {
                display: none !important;
            }

            /* Show Print Area */
            #printArea {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                visibility: visible;
                background: white;
                color: black;
                padding: 20px;
                direction: rtl;
                font-size: 12pt;
                z-index: 9999;
            }

            /* Print Specific Styles */
            .print-header {
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            .print-header h1 { font-size: 18pt; margin: 0; color: #000; }
            .print-header p { margin: 5px 0; font-size: 11pt; }
            
            .print-details-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-bottom: 20px;
                border: 1px solid #ddd;
                padding: 15px;
                background: #f9f9f9;
            }
            
            .print-field { margin-bottom: 10px; }
            .print-field strong { display: block; color: #333; }
            .print-field span { color: #000; }

            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            .print-table th, .print-table td {
                border: 1px solid #333;
                padding: 8px;
                text-align: right;
                font-size: 10pt;
                white-space: normal;
            }
            .print-table th { background-color: #eee !important; color: #000; }

            /* A4 Page Settings */
            @page {
                size: A4;
                margin: 10mm;
            }
        }

        /* --- Responsive Queries --- */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .form-grid { grid-template-columns:1fr; }
            .report-controls { flex-direction: column; align-items: stretch; }
            .footer-content { flex-direction: column; gap: 10px; }
            th:nth-child(5), td:nth-child(5) { display: none; } 
        }
    </style>
</head>
<body>
    <!-- Sidebar (Desktop) -->
    <aside class="sidebar no-print">
        <div class="logo">
            <i class="fas fa-landmark"></i>
            <h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø©<br>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†</h2>
        </div>
        <nav>
            <ul class="nav-links">
                <li class="active" onclick="switchTab('dashboard', this)">
                    <i class="fas fa-chart-line"></i>
                    <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </li>
                <li onclick="switchTab('reports', this)">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
                </li>
                <li onclick="switchTab('register', this)">
                    <i class="fas fa-plus-circle"></i>
                    <span>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨</span>
                </li>
                <li onclick="switchTab('archive', this)">
                    <i class="fas fa-archive"></i>
                    <span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav no-print">
        <div class="mobile-nav-item active" onclick="switchTab('dashboard', this)">
            <i class="fas fa-chart-pie"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="mobile-nav-item" onclick="switchTab('reports', this)">
            <i class="fas fa-robot"></i>
            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± AI</span>
        </div>
        <div class="mobile-nav-item" onclick="switchTab('register', this)">
            <i class="fas fa-plus-circle"></i>
            <span>Ø¥Ø¶Ø§ÙØ©</span>
        </div>
        <div class="mobile-nav-item" onclick="switchTab('archive', this)">
            <i class="fas fa-list"></i>
            <span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Tab -->
        <section id="dashboard" class="tab-content active">
            <div class="header-3d no-print">
                <h1><i class="fas fa-chart-line"></i> ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h1>
            </div>
            <div class="glass-panel no-print">
                <h2 style="margin-bottom: 20px; color: var(--primary); font-weight: 800;"><i class="fas fa-bell"></i> ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù‡Ø§Ù…Ø©</h2>
                <div id="alertsContent">
                    <p class="no-alerts">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©</p>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid no-print">
                <div class="stat-card total">
                    <div class="icon">ğŸ“Š</div>
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                    <span class="number" id="totalRequests">0</span>
                </div>
                <div class="stat-card success">
                    <div class="icon">âœ…</div>
                    <h3>Ù…ÙƒØªÙ…Ù„Ø©</h3>
                    <span class="number" id="completedRequests">0</span>
                </div>
                <div class="stat-card warning">
                    <div class="icon">â³</div>
                    <h3>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3>
                    <span class="number" id="pendingRequests">0</span>
                </div>
                <div class="stat-card danger">
                    <div class="icon">âŒ</div>
                    <h3>Ù…Ø±ÙÙˆØ¶Ø©</h3>
                    <span class="number" id="rejectedRequests">0</span>
                </div>
                <!-- NEW CARD: Ihtia Requests -->
                <div class="stat-card info">
                    <div class="icon">ğŸ“œ</div>
                    <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ø·Ø©</h3>
                    <span class="number" id="ihtiaRequests">0</span>
                </div>
            </div>

            <div class="glass-panel no-print">
                <canvas id="requestsChart"></canvas>
            </div>
        </section>

        <!-- Reports & AI Tab -->
        <section id="reports" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-file-invoice"></i> ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</h1>
            </div>
            
            <!-- Authority Report Section (NEW) -->
            <div class="glass-panel no-print">
                <h3 style="margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                    <i class="fas fa-building"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Øª
                </h3>
                <p style="margin-bottom: 15px; color: var(--text-light); font-size: 0.9rem;">
                    Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ù‡Ø§ ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡Ø§.
                </p>
                <div id="authorityGrid" class="authority-grid">
                    <!-- Authority Cards Injected Here -->
                    <div style="grid-column: 1/-1; text-align: center; color: var(--text-light);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
                </div>
            </div>

            <div class="glass-panel no-print">
                <h3 style="margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                    <i class="fas fa-calendar-alt"></i> ØªÙ‚Ø±ÙŠØ± Ø¨ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
                </h3>
                <div class="report-controls">
                    <div class="input-group" style="flex: 1;">
                        <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    <button class="btn-3d" onclick="generateDateReport()">
                        <i class="fas fa-search"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>
                <div id="dateReportResult" class="ai-result-box">
                    <h4>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</h4>
                    <div class="stat-card" style="margin-top: 10px; padding: 10px;">
                        <span class="number" id="reportCount" style="font-size: 1.5rem;">0</span>
                        <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                    </div>
                </div>
            </div>
            <div class="glass-panel no-print">
                <h3 style="margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                    <i class="fas fa-brain"></i> Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø­Ø§Ø·Ø©
                </h3>
                <p style="color: var(--text-light); margin-bottom: 15px; font-size: 0.9rem;">
                    Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨ÙƒÙ„Ù…Ø© "Ø·Ù„Ø¨ Ø§Ø­Ø§Ø·Ø©".
                </p>
                <button class="btn-3d secondary" onclick="runAIAnalysis()" id="aiBtn">
                    <i class="fas fa-magic"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                </button>
                <div id="aiResult" class="ai-result-box">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-robot" style="font-size: 2rem; color: #6366f1;"></i>
                        <div>
                            <h4 style="margin:0;">ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h4>
                            <span class="ai-badge">AI Processed</span>
                        </div>
                    </div>
                    <p style="margin-bottom: 5px;">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰: </p>
                    <span id="ihtiaCount" class="ai-number-display" onclick="openAiModal()" title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">0</span>
                    <p style="font-size: 0.8rem; color: #64748b;">(Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„)</p>
                </div>
            </div>
            <div class="glass-panel no-print">
                 <button class="btn-3d" style="width: 100%; background: var(--secondary);" onclick="printFullReport()">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù…
                 </button>
            </div>
        </section>

        <!-- Register Tab -->
        <section id="register" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-plus-circle"></i> â• ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨</h1>
            </div>
            <div class="glass-panel form-container">
                <form id="requestForm">
                    <div class="form-grid">
                        <div class="input-group">
                            <label><i class="fas fa-hashtag"></i> Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
                            <input type="text" id="reqId" required placeholder="Ù…Ø«Ø§Ù„: 2024/001">
                        </div>
                        <div class="input-group">
                            <label><i class="fas fa-calendar"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
                            <input type="date" id="reqDate" required>
                        </div>
                        <div class="input-group full-width">
                            <label><i class="fas fa-heading"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
                            <input type="text" id="reqTitle" required placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ± Ù„Ù„Ø·Ù„Ø¨">
                        </div>
                        <div class="input-group full-width">
                            <label><i class="fas fa-building"></i> Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù†ÙŠØ©</label>
                            <input type="text" id="reqAuthority" required placeholder="Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©">
                        </div>
                        <div class="input-group full-width">
                            <label><i class="fas fa-align-right"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
                            <textarea id="reqDetails" rows="5" required placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§..."></textarea>
                        </div>
                        <div class="input-group">
                            <label><i class="fas fa-tasks"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                            <select id="reqStatus" required>
                                <option value="execution">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="review">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                                <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                            </select>
                        </div>
                        <div class="input-group" style="display: flex; align-items: center; justify-content: flex-end;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="hasDocuments" onchange="toggleDocumentsSection()" style="width: 20px; height: 20px;">
                                <i class="fas fa-paperclip"></i> ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø±ÙÙ‚Ø©
                            </label>
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <div id="documentsSection">
                        <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: var(--primary);">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h3>
                        <div id="documentsList" class="doc-list">
                            <!-- Dynamic inputs go here -->
                        </div>
                        <button type="button" class="btn-3d secondary" onclick="addDocumentField()" style="margin-top: 10px; font-size: 0.8rem; padding: 8px 15px;">
                            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø¢Ø®Ø±
                        </button>
                    </div>

                    <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px;" class="no-print">
                        <button type="submit" class="btn-3d" style="flex: 1;">
                            <i class="fas fa-save"></i> <span id="submitButtonText">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</span>
                        </button>
                        <button type="button" class="btn-3d secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Archive Tab -->
        <section id="archive" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-archive"></i> ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</h1>
            </div>
            <div class="glass-panel">
                <div class="controls-bar">
                    <div class="input-group">
                        <div style="position: relative;">
                            <i class="fas fa-search" style="position: absolute; right: 15px; top: 12px; color: var(--text-light);"></i>
                            <input type="text" id="searchInput" style="padding-right: 40px;" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..." oninput="searchRequests(this.value)">
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="margin-top: 15px;">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>ğŸ›ï¸ Ø§Ù„Ø¬Ù‡Ø©</th>
                                <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>ğŸ“ Ù…Ø³ØªÙ†Ø¯Ø§Øª</th>
                                <th>âœ… Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¹Ø±Ø¶</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr><td colspan="7" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <footer class="app-footer no-print">
                <div class="footer-card">
                    <div class="footer-content">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="footer-icon" style="background: #e2e8f0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="footer-text" style="text-align: right;">
                                <h3 style="font-size: 0.9rem;">
                                    <span class="footer-badge">ğŸ’»</span>
                                    Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±
                                </h3>
                                <p style="font-size: 0.8rem;">Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" class="footer-social-btn facebook">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="https://github.com/mohamednasr5" target="_blank" class="footer-social-btn github">
                                <i class="fab fa-github"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </footer>
        </section>
    </main>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">Ã—</span>
            <div class="modal-header">
                <h2 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
                <div style="color: var(--text-light); margin-top: 5px;">
                    <i class="fas fa-hashtag"></i> <span id="modalReqId"></span> <br>
                    <i class="fas fa-calendar"></i> <span id="modalReqDate" style="margin-right: 5px; font-weight:bold;"></span>
                </div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions">
                <button class="btn-action edit" onclick="checkPasscode('edit')" style="background: var(--primary);">
                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                </button>
                <button class="btn-action delete" onclick="checkPasscode('delete')" style="background: var(--danger);">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
                <button class="btn-action print" onclick="printRequest()" style="background: var(--secondary);">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
            </div>
        </div>
    </div>

    <!-- Authority Report Modal (NEW) -->
    <div id="authorityModal" class="modal-overlay">
        <div class="modal-content large">
            <span class="close-modal" onclick="closeAuthorityModal()">Ã—</span>
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> ØªÙ‚Ø±ÙŠØ± Ø¬Ù‡Ø©: <span id="authModalTitle" style="color: var(--primary);"></span></h2>
            </div>
            <div class="modal-body">
                <div id="authPreviewArea" style="padding: 20px; text-align: center; color: var(--text-light);">
                    <!-- Content injected via JS -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-action" onclick="printAuthorityReport()" style="background: var(--primary); flex: 2;">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
                <button class="btn-action" onclick="closeAuthorityModal()" style="background: var(--secondary); flex: 1;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- AI Results Modal -->
    <div id="aiModal" class="modal-overlay">
        <div class="modal-content large">
            <span class="close-modal" onclick="closeAiModal()">Ã—</span>
            <div class="modal-header">
                <h2><i class="fas fa-brain"></i> ØªÙ‚Ø±ÙŠØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø­Ø§Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>
            </div>
            <div class="modal-body">
                <!-- Placeholder for visual preview if needed, print logic handles content injection -->
                <div id="aiPreviewArea" style="padding: 20px; text-align: center; color: var(--text-light);">
                    Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±" Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-action" onclick="printAiReport()" style="background: var(--primary); flex: 2;">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
                <button class="btn-action" onclick="closeAiModal()" style="background: var(--secondary); flex: 1;">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script>
        // ==========================================
        // APP LOGIC
        // ==========================================
        
        let requestsData = [];
        let currentRequestKey = null; 
        let chartInstance = null;
        let documentsData = []; 
        let currentAuthorityData = []; // Stores data for the current authority modal
        const SECURE_CODE = "521988";

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('reqDate').valueAsDate = new Date();
            addDocumentField(); 
            
            if (typeof RequestManager !== 'undefined') {
                fetchRealtimeData();
            } else {
                console.error('RequestManager not loaded. Check firebase-config.js');
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª firebase-config.js');
            }
        });

        // --- 1. Fetch Data using RequestManager ---
        function fetchRealtimeData() {
            RequestManager.listenToRequests((data) => {
                requestsData = data;
                
                // Sort Ascending by ID
                requestsData.sort((a, b) => {
                    return a.reqId.localeCompare(b.reqId, undefined, { numeric: true, sensitivity: 'base' });
                });

                renderTable(requestsData);
                updateDashboard();
                updateAuthorityReport(); // Update Authority Report when data changes
            });
        }

        // --- 2. Navigation ---
        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            document.querySelectorAll('.nav-links li, .mobile-nav-item').forEach(item => item.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }

            document.querySelector('.main-content').scrollTop = 0;
        }

        // --- 3. Document Handling ---
        function toggleDocumentsSection() {
            const isChecked = document.getElementById('hasDocuments').checked;
            const section = document.getElementById('documentsSection');
            
            if (isChecked) {
                section.classList.add('active');
                const list = document.getElementById('documentsList');
                if(list.children.length === 0) addDocumentField();
            } else {
                section.classList.remove('active');
            }
        }

        function addDocumentField() {
            const container = document.getElementById('documentsList');
            const div = document.createElement('div');
            div.className = 'doc-item';
            div.innerHTML = `
                <i class="fas fa-file-alt"></i>
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯" class="doc-input">
                <button type="button" onclick="this.parentElement.remove()" style="border:none; background:none; color: #ef4444; cursor:pointer;"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(div);
        }

        // --- 4. Form Handling (Create/Update) ---
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Gather documents
            const docInputs = document.querySelectorAll('.doc-input');
            const docsList = [];
            docInputs.forEach(input => {
                if(input.value.trim() !== "") docsList.push(input.value.trim());
            });

            const requestData = {
                reqId: document.getElementById('reqId').value,
                reqDate: document.getElementById('reqDate').value,
                title: document.getElementById('reqTitle').value,
                authority: document.getElementById('reqAuthority').value,
                details: document.getElementById('reqDetails').value,
                status: document.getElementById('reqStatus').value,
                hasDocuments: document.getElementById('hasDocuments').checked,
                documentsList: docsList 
            };

            let success = false;

            if (currentRequestKey) {
                success = await RequestManager.updateRequest(currentRequestKey, requestData);
                if(success) showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ­ÙØ¸Ù‡ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                success = await RequestManager.addRequest(requestData);
                if(success) showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            }

            if(success) {
                resetForm();
                switchTab('archive', document.querySelectorAll('.mobile-nav-item')[3]);
            } else {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸', 'error');
            }
        });

        function resetForm() {
            document.getElementById('requestForm').reset();
            document.getElementById('reqDate').valueAsDate = new Date();
            currentRequestKey = null;
            document.getElementById('submitButtonText').innerText = 'Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨';
            document.getElementById('documentsSection').classList.remove('active');
            document.getElementById('documentsList').innerHTML = ''; 
            addDocumentField();
        }

        // --- 5. Table & Search ---
        function renderTable(data) {
            const tbody = document.getElementById('requestsTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>';
                return;
            }

            data.forEach(req => {
                const statusMap = {
                    'execution': { text: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', class: 'status-execution' },
                    'review': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', class: 'status-review' },
                    'completed': { text: 'Ù…ÙƒØªÙ…Ù„', class: 'status-completed' },
                    'rejected': { text: 'Ù…Ø±ÙÙˆØ¶', class: 'status-rejected' }
                };
                const st = statusMap[req.status];

                const row = `
                    <tr onclick="openModal('${req.firebaseKey}')">
                        <td>${req.reqId}</td>
                        <td style="font-weight:bold;">${req.title}</td>
                        <td>${req.authority}</td>
                        <td>${req.reqDate}</td>
                        <td>${req.hasDocuments ? '<i class="fas fa-paperclip"></i>' : '-'}</td>
                        <td><span class="status-badge ${st.class}">${st.text}</span></td>
                        <td>
                             <button class="btn-action" style="padding: 5px 10px; font-size: 0.8rem; background: var(--primary);">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function searchRequests(query) {
            const lowerQ = query.toLowerCase();
            const filtered = requestsData.filter(r => 
                r.title.toLowerCase().includes(lowerQ) || 
                r.reqId.includes(lowerQ) ||
                r.authority.toLowerCase().includes(lowerQ)
            );
            renderTable(filtered);
        }

        // --- 6. Dashboard & Charts ---
        function updateDashboard() {
            const total = requestsData.length;
            const completed = requestsData.filter(r => r.status === 'completed').length;
            const pending = requestsData.filter(r => r.status === 'execution' || r.status === 'review').length;
            const rejected = requestsData.filter(r => r.status === 'rejected').length;
            
            // NEW: Ihtia Requests Calculation
            const ihtiaCount = requestsData.filter(req => {
                const cleanTitle = req.title.trim();
                return cleanTitle.startsWith('Ø·Ù„Ø¨ Ø§Ø­Ø§Ø·Ø©') || cleanTitle.startsWith('Ø·Ù„Ø¨ Ø§Ø­Ø§Ø·Ù‡');
            }).length;

            animateValue("totalRequests", parseInt(document.getElementById("totalRequests").innerText), total, 500);
            animateValue("completedRequests", parseInt(document.getElementById("completedRequests").innerText), completed, 500);
            animateValue("pendingRequests", parseInt(document.getElementById("pendingRequests").innerText), pending, 500);
            animateValue("rejectedRequests", parseInt(document.getElementById("rejectedRequests").innerText), rejected, 500);
            animateValue("ihtiaRequests", parseInt(document.getElementById("ihtiaRequests").innerText), ihtiaCount, 500);

            renderChart(completed, pending, rejected);
        }

        function renderChart(completed, pending, rejected) {
            const ctx = document.getElementById('requestsChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù…ÙƒØªÙ…Ù„Ø©', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°/Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ù…Ø±ÙÙˆØ¶Ø©'],
                    datasets: [{
                        data: [completed, pending, rejected],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { family: 'Cairo' } } } }
                }
            });
        }

        // --- 7. Authority Report Logic (NEW) ---
        function updateAuthorityReport() {
            const grid = document.getElementById('authorityGrid');
            grid.innerHTML = '';

            if (requestsData.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„</div>';
                return;
            }

            // Group by Authority
            const authMap = {};
            requestsData.forEach(req => {
                const auth = req.authority || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!authMap[auth]) authMap[auth] = 0;
                authMap[auth]++;
            });

            // Create Cards
            for (const [auth, count] of Object.entries(authMap)) {
                const card = document.createElement('div');
                card.className = 'authority-card';
                card.innerHTML = `
                    <h4>${auth}</h4>
                    <div class="authority-count" onclick="openAuthorityModal('${auth}', ${count})">
                        ${count}
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-light); margin-top:5px;">Ø·Ù„Ø¨</div>
                `;
                grid.appendChild(card);
            }
        }

        function openAuthorityModal(authorityName, count) {
            // Filter data
            const filteredData = requestsData.filter(req => req.authority === authorityName);
            currentAuthorityData = filteredData;
            
            document.getElementById('authModalTitle').innerText = authorityName;
            
            const previewArea = document.getElementById('authPreviewArea');
            previewArea.innerHTML = `
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${filteredData.length}</h3>
                <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>
            `;

            document.getElementById('authorityModal').style.display = 'flex';
        }

        function closeAuthorityModal() {
            document.getElementById('authorityModal').style.display = 'none';
            currentAuthorityData = [];
        }

        function printAuthorityReport() {
            if (!currentAuthorityData || currentAuthorityData.length === 0) return;

            const printArea = document.getElementById('printArea');
            let tableRows = '';

            currentAuthorityData.forEach(req => {
                const statusMap = {
                    'execution': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', 'review': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                    'completed': 'Ù…ÙƒØªÙ…Ù„', 'rejected': 'Ù…Ø±ÙÙˆØ¶'
                };
                tableRows += `
                    <tr>
                        <td>${req.reqId}</td>
                        <td>${req.title}</td>
                        <td>${req.reqDate}</td>
                        <td>${statusMap[req.status]}</td>
                    </tr>
                `;
            });

            printArea.innerHTML = `
                ${generatePrintHeader('ØªÙ‚Ø±ÙŠØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ù‡Ø©: ' + document.getElementById('authModalTitle').innerText)}
                <p style="margin-bottom: 15px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <strong>${currentAuthorityData.length}</strong></p>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
            setTimeout(() => { window.print(); }, 300);
        }

        // --- 8. Reports & AI Logic (Existing) ---
        function generateDateReport() {
            const start = document.getElementById('reportStartDate').value;
            const end = document.getElementById('reportEndDate').value;

            if (!start || !end) { showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®', 'warning'); return; }

            const filtered = requestsData.filter(r => r.reqDate >= start && r.reqDate <= end);
            document.getElementById('dateReportResult').classList.add('active');
            document.getElementById('reportCount').innerText = filtered.length;
        }

        function runAIAnalysis() {
            const btn = document.getElementById('aiBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ...';

            setTimeout(() => {
                const ihtiaRequests = requestsData.filter(req => {
                    const cleanTitle = req.title.trim();
                    return cleanTitle.startsWith('Ø·Ù„Ø¨ Ø§Ø­Ø§Ø·Ø©') || cleanTitle.startsWith('Ø·Ù„Ø¨ Ø§Ø­Ø§Ø·Ù‡');
                });

                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
                
                const resultBox = document.getElementById('aiResult');
                resultBox.classList.add('active');
                animateValue("ihtiaCount", 0, ihtiaRequests.length, 1000);

                window.currentAiResults = ihtiaRequests;

            }, 1500);
        }

        function openAiModal() {
            if (!window.currentAiResults || window.currentAiResults.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶', 'warning');
                return;
            }
            const modal = document.getElementById('aiModal');
            const previewArea = document.getElementById('aiPreviewArea');
            previewArea.innerHTML = `
                <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                <p>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ <strong>${window.currentAiResults.length}</strong> Ø·Ù„Ø¨ Ø§Ø­Ø§Ø·Ø©.</p>
                <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±" Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù Ø§Ù„ÙƒØ§Ù…Ù„.</p>
            `;
            modal.style.display = 'flex';
        }

        function closeAiModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        // --- 9. PRINTING LOGIC (Existing & Extended) ---
        function generatePrintHeader(title) {
            const now = new Date();
            return `
                <div class="print-header">
                    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†</h1>
                    <p>${title}</p>
                    <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${now.toLocaleDateString('ar-EG')} - ${now.toLocaleTimeString('ar-EG')}</p>
                </div>
                <hr style="border: 0; border-top: 2px solid #000; margin-bottom: 20px;">
            `;
        }

        function printRequest() {
            const req = requestsData.find(r => r.firebaseKey === currentRequestKey);
            if (!req) return;

            const printArea = document.getElementById('printArea');
            
            let docsHtml = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª';
            if (req.hasDocuments) {
                if (req.documentsList && req.documentsList.length > 0) {
                    docsHtml = '<ul style="margin-right: 20px;">' + req.documentsList.map(d => `<li>${d}</li>`).join('') + '</ul>';
                } else {
                    docsHtml = 'Ù†Ø¹Ù…ØŒ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø±ÙÙ‚Ø©';
                }
            }

            printArea.innerHTML = `
                ${generatePrintHeader('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: ' + req.reqId)}
                <div class="print-details-grid">
                    <div class="print-field"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> <span>${req.reqId}</span></div>
                    <div class="print-field"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span>${req.reqDate}</span></div>
                    <div class="print-field"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span>${req.title}</span></div>
                    <div class="print-field"><strong>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù†ÙŠØ©:</strong> <span>${req.authority}</span></div>
                    <div class="print-field"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span>${req.status}</span></div>
                    <div class="print-field"><strong>Ù…Ø±ÙÙ‚Ø§Øª:</strong> <span>${docsHtml}</span></div>
                </div>
                <div style="margin-bottom: 20px;">
                    <strong>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨:</strong>
                    <p style="padding: 15px; background: #fff; border: 1px solid #ccc; margin-top: 5px; line-height: 1.6;">
                        ${req.details}
                    </p>
                </div>
                <div style="margin-top: 50px; display: flex; justify-content: space-between;">
                    <div style="border-top: 1px solid #000; width: 200px; text-align: center;">ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                    <div style="border-top: 1px solid #000; width: 200px; text-align: center;">Ø®ØªÙ… Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                </div>
            `;

            setTimeout(() => { window.print(); }, 300);
        }

        function printAiReport() {
            if (!window.currentAiResults || window.currentAiResults.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
                return;
            }

            const printArea = document.getElementById('printArea');
            let tableRows = '';

            window.currentAiResults.forEach(req => {
                tableRows += `
                    <tr>
                        <td>${req.reqId}</td>
                        <td>${req.title}</td>
                        <td>${req.authority}</td>
                        <td>${req.reqDate}</td>
                        <td>${req.status}</td>
                    </tr>
                `;
            });

            printArea.innerHTML = `
                ${generatePrintHeader('ØªÙ‚Ø±ÙŠØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø­Ø§Ø·Ø© (Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ)')}
                <p style="margin-bottom: 15px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <strong>${window.currentAiResults.length}</strong></p>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„Ø¬Ù‡Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
            setTimeout(() => { window.print(); }, 300);
        }

        function printFullReport() {
            if (requestsData.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
                return;
            }

            const printArea = document.getElementById('printArea');
            let tableRows = '';

            requestsData.forEach(req => {
                const statusMap = {
                    'execution': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', 'review': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                    'completed': 'Ù…ÙƒØªÙ…Ù„', 'rejected': 'Ù…Ø±ÙÙˆØ¶'
                };
                tableRows += `
                    <tr>
                        <td>${req.reqId}</td>
                        <td>${req.title}</td>
                        <td>${req.authority}</td>
                        <td>${req.reqDate}</td>
                        <td>${statusMap[req.status]}</td>
                    </tr>
                `;
            });

            printArea.innerHTML = `
                ${generatePrintHeader('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª')}
                <p style="margin-bottom: 15px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <strong>${requestsData.length}</strong></p>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„Ø¬Ù‡Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
            setTimeout(() => { window.print(); }, 300);
        }

        // --- 10. Modal Actions & Security ---
        function openModal(key) {
            const req = requestsData.find(r => r.firebaseKey === key);
            if (!req) return;

            currentRequestKey = key;
            document.getElementById('modalTitle').innerText = req.title;
            document.getElementById('modalReqId').innerText = req.reqId;
            document.getElementById('modalReqDate').innerText = req.reqDate;
            
            let docsHtml = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª';
            if (req.hasDocuments) {
                if (req.documentsList && req.documentsList.length > 0) {
                    docsHtml = '<ul style="margin-right: 20px;">' + req.documentsList.map(d => `<li>${d}</li>`).join('') + '</ul>';
                } else {
                    docsHtml = '<span style="color:var(--success);"><i class="fas fa-check"></i> Ù†Ø¹Ù…ØŒ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª</span>';
                }
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom:15px;"><strong>Ø§Ù„Ø¬Ù‡Ø©:</strong> ${req.authority}</div>
                <div style="background: #f8fafc; padding: 10px; border-radius: 8px; line-height: 1.6; margin-bottom:15px;">${req.details}</div>
                <div style="margin-bottom:10px;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-badge status-${req.status}">${req.status}</span></div>
                <div style="margin-bottom:10px;"><strong>Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:</strong> ${docsHtml}</div>
            `;
            document.getElementById('detailsModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
            currentRequestKey = null;
        }

        function checkPasscode(action) {
            const code = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:");
            if (code === null) return;
            if (code === SECURE_CODE) {
                if (action === 'edit') performEdit();
                else if (action === 'delete') performDelete();
            } else {
                showToast("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­", "error");
            }
        }

        async function performEdit() {
            const req = requestsData.find(r => r.firebaseKey === currentRequestKey);
            if (!req) return;

            closeModal();
            switchTab('register', document.querySelectorAll('.mobile-nav-item')[2]);
            
            document.getElementById('reqId').value = req.reqId;
            document.getElementById('reqTitle').value = req.title;
            document.getElementById('reqDate').value = req.reqDate;
            document.getElementById('reqAuthority').value = req.authority;
            document.getElementById('reqDetails').value = req.details;
            document.getElementById('reqStatus').value = req.status;
            document.getElementById('hasDocuments').checked = req.hasDocuments;
            
            if (req.hasDocuments) {
                toggleDocumentsSection();
                const list = document.getElementById('documentsList');
                list.innerHTML = ''; 
                if (req.documentsList && req.documentsList.length > 0) {
                    req.documentsList.forEach(docName => {
                        addDocumentField(); 
                        list.lastChild.querySelector('input').value = docName;
                    });
                } else {
                    addDocumentField();
                }
            }

            document.getElementById('submitButtonText').innerText = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨';
        }

        async function performDelete() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                const success = await RequestManager.deleteRequest(currentRequestKey);
                if(success) {
                    closeModal();
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨');
                } else {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
                }
            }
        }

        // --- Utilities ---
        function showToast(msg, type='success') {
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = type === 'success' ? '#10b981' : (type === 'error' ? '#ef4444' : '#f59e0b');
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '30px';
            toast.style.zIndex = '3000';
            toast.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, stepTime > 0 ? stepTime : 10);
        }
    </script>
    
    <!-- Hidden Print Area Container -->
    <div id="printArea"></div>

    <!-- 
       ===================================================================
       FIREBASE CONFIGURATION (Embedded for Single File Portability)
       Normally this would be in firebase-config.js
       ===================================================================
    -->
    <script>
        // firebase-config.js - Firebase Configuration & Request Manager
        // Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯

        const firebaseConfig = {
            apiKey: "AIzaSyC4J8ncbuejvzfWvzCTAXRzjFgvrchXpE8",
            authDomain: "hedor-bea3c.firebaseapp.com",
            databaseURL: "https://hedor-bea3c-default-rtdb.firebaseio.com",
            projectId: "hedor-bea3c",
            storageBucket: "hedor-bea3c.firebasestorage.app",
            messagingSenderId: "369239455736",
            appId: "1:369239455736:web:116295854269abecf6480d",
            measurementId: "G-R2MG1YKQEP"
        };

        // Initialize Firebase
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            window.database = firebase.database();
            console.log('âœ… Firebase Initialized Successfully');
        } else {
            console.error("âŒ Firebase SDK not loaded!");
        }

        /**
         * Enhanced Request Manager with improved error handling and validation
         */
        window.RequestManager = {
            /**
             * Add new request to database
             */
            addRequest: async (data) => {
                try {
                    if (!data.reqId || !data.title) {
                        throw new Error("Missing required fields");
                    }

                    const newRef = window.database.ref('parliament-requests').push();
                    await newRef.set({
                        ...data,
                        firebaseKey: newRef.key,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });

                    console.log('âœ… Request added successfully:', newRef.key);
                    return true;
                } catch (error) {
                    console.error("âŒ Error adding request:", error);
                    return false;
                }
            },

            /**
             * Update existing request
             */
            updateRequest: async (key, data) => {
                try {
                    if (!key) throw new Error("Invalid firebase key");
                    if (!data.reqId || !data.title) throw new Error("Missing required fields");

                    const updateData = {
                        ...data,
                        updatedAt: new Date().toISOString()
                    };

                    await window.database.ref(`parliament-requests/${key}`).update(updateData);
                    console.log('âœ… Request updated successfully:', key);
                    return true;
                } catch (error) {
                    console.error("âŒ Error updating request:", error);
                    return false;
                }
            },

            /**
             * Delete request from database
             */
            deleteRequest: async (key) => {
                try {
                    if (!key) throw new Error("Invalid firebase key");
                    await window.database.ref(`parliament-requests/${key}`).remove();
                    console.log('âœ… Request deleted successfully:', key);
                    return true;
                } catch (error) {
                    console.error("âŒ Error deleting request:", error);
                    return false;
                }
            },

            /**
             * Listen to real-time updates of all requests
             */
            listenToRequests: (callback) => {
                if (!window.database) {
                    console.error("âŒ Database not initialized");
                    return;
                }

                window.database.ref('parliament-requests').on('value', (snapshot) => {
                    try {
                        const data = snapshot.val();
                        let requests = [];

                        if (data && typeof data === 'object') {
                            requests = Object.entries(data).map(([key, value]) => ({
                                ...value,
                                firebaseKey: key
                            }));
                        }

                        callback(requests);
                        console.log(`âœ… Loaded ${requests.length} requests`);
                    } catch (error) {
                        console.error("âŒ Error processing requests:", error);
                        callback([]);
                    }
                }, (error) => {
                    console.error("âŒ Database listener error:", error);
                });
            },

            /**
             * Get single request by key
             */
            getRequest: async (key) => {
                try {
                    const snapshot = await window.database.ref(`parliament-requests/${key}`).once('value');
                    const data = snapshot.val();
                    if (data) {
                        return { ...data, firebaseKey: key };
                    }
                    return null;
                } catch (error) {
                    console.error("âŒ Error fetching request:", error);
                    return null;
                }
            },

            /**
             * Get all requests once (not real-time)
             */
            getAllRequests: async () => {
                try {
                    const snapshot = await window.database.ref('parliament-requests').once('value');
                    const data = snapshot.val();
                    let requests = [];

                    if (data && typeof data === 'object') {
                        requests = Object.entries(data).map(([key, value]) => ({
                            ...value,
                            firebaseKey: key
                        }));
                    }

                    return requests;
                } catch (error) {
                    console.error("âŒ Error fetching all requests:", error);
                    return [];
                }
            }
        };

        console.log('âœ… Firebase Request Manager Ready');
    </script>
</body>
</html>
