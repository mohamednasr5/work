<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù† - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #8b5cf6; 
            --type-special: #7c3aed; /* Ø¨Ù†ÙØ³Ø¬ÙŠ Ù„Ù„Ø®Ø§Øµ */
            --type-general: #0891b2; /* Ø³Ù…Ø§ÙˆÙŠ Ù„Ù„Ø¹Ø§Ù… */
            --type-briefing: #ea580c; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø¥Ø­Ø§Ø·Ø© */
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --nav-height-mobile: 65px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--background); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* --- Sidebar (Desktop) --- */
        .sidebar { width: 280px; background: var(--surface); height: 100%; display: flex; flex-direction: column; padding: 20px; box-shadow: var(--shadow); z-index: 100; transition: transform 0.3s ease; }
        .logo { display: flex; align-items: center; gap: 15px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0; }
        .logo i { font-size: 2rem; color: var(--primary); }
        .logo h2 { font-size: 1.1rem; font-weight: 800; line-height: 1.4; color: var(--text-main); }
        .nav-links { list-style: none; flex: 1; }
        .nav-links li { margin-bottom: 10px; padding: 12px 15px; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; color: var(--text-light); font-weight: 600; }
        .nav-links li:hover { background-color: #eff6ff; color: var(--primary); }
        .nav-links li.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transform: scale(1.02); }
        .nav-links li i { font-size: 1.2rem; width: 24px; text-align: center; }

        /* --- Main Content --- */
        .main-content { flex: 1; height: 100%; overflow-y: auto; padding: 20px; padding-bottom: calc(var(--nav-height-mobile) + 20px); position: relative; scroll-behavior: smooth; }
        .header-3d h1 { font-size: 1.8rem; font-weight: 900; background: linear-gradient(135deg, var(--text-main), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .glass-panel { background: var(--glass-bg); border: var(--glass-border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); backdrop-filter: blur(10px); }

        /* --- Tabs Logic --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .stat-card.total::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.danger::before { background: var(--danger); }
        .stat-card.info::before { background: var(--info); }
        .stat-card.type-special::before { background: var(--type-special); }
        .stat-card.type-general::before { background: var(--type-general); }
        .stat-card.type-briefing::before { background: var(--type-briefing); }
        
        .stat-card .icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-light); margin-bottom: 5px; }
        .stat-card .number { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }

        /* --- Authority Report Styles --- */
        .report-section-title { font-size: 1.1rem; font-weight: bold; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0; display: flex; align-items: center; gap: 10px; }
        .authority-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .authority-card { 
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; 
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .authority-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--primary); }
        .authority-card h4 { font-size: 0.9rem; margin-bottom: 10px; color: var(--text-main); line-height: 1.4; min-height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .authority-count { 
            font-size: 1.4rem; font-weight: 800; color: var(--primary); 
            background: #eff6ff; padding: 4px 12px; border-radius: 8px; display: inline-block; width: fit-content;
        }
        .authority-card:hover .authority-count { background: var(--primary); color: white; }
        .ai-indicator { position: absolute; top: 5px; left: 5px; font-size: 0.6rem; background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; display: none; }
        .authority-card.grouped .ai-indicator { display: block; }

        /* --- Forms --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group.full-width { grid-column: 1 / -1; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; transition: border-color 0.2s; background: #fff; }
        .input-group input[readonly] { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; border-color: #cbd5e1; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--primary); }

        /* --- Filter Controls --- */
        .filter-container {
            background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border: 1px dashed #cbd5e1;
        }
        .filter-container select, .filter-container input[type="text"] { flex: 1; min-width: 150px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .filter-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .filter-checkbox input { width: 18px; height: 18px; }

        /* --- Buttons --- */
        .btn-3d { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 12px 25px; border-radius: 10px; font-family: inherit; font-weight: 700; cursor: pointer; box-shadow: 0 4px 0 #1e3a8a; transition: all 0.1s; display: inline-flex; align-items: center; gap: 8px; font-size: 1rem; }
        .btn-3d:active { transform: translateY(4px); box-shadow: none; }
        .btn-3d.secondary { background: linear-gradient(135deg, #64748b, #475569); box-shadow: 0 4px 0 #334155; }
        .btn-3d.danger { background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 4px 0 #991b1b; }
        .btn-3d.success { background: linear-gradient(135deg, #10b981, #047857); box-shadow: 0 4px 0 #065f46; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; }

        /* --- Table --- */
        .table-responsive { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: var(--surface); min-width: 700px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #f1f5f9; white-space: nowrap; }
        th { background-color: #f8fafc; color: var(--text-light); font-weight: 700; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-execution { background: #fff7ed; color: #c2410c; }
        .status-review { background: #eff6ff; color: #1d4ed8; }
        .status-completed { background: #ecfdf5; color: #047857; }
        .status-rejected { background: #fef2f2; color: #b91c1c; }
        .status-replied { background: #d1fae5; color: #065f46; }
        
        .type-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; color: white; font-weight: normal; }
        .bg-special { background-color: var(--type-special); }
        .bg-general { background-color: var(--type-general); }
        .bg-briefing { background-color: var(--type-briefing); }

        /* --- Mobile Navigation --- */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); background: var(--surface); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.7rem; gap: 4px; width: 100%; height: 100%; cursor: pointer; transition: all 0.2s; }
        .mobile-nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .mobile-nav-item i { font-size: 1.3rem; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--surface); border-radius: var(--radius); width: 100%; max-width: 500px; overflow: hidden; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content.large { max-width: 900px; }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text-light); z-index: 10; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-actions { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #e2e8f0; }
        .btn-action { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 5px; }

        /* --- Backup & Notifications Styles --- */
        .backup-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }
        .backup-card { background: white; padding: 30px; border-radius: var(--radius); text-align: center; border: 2px dashed #cbd5e1; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; }
        .backup-card:hover { border-color: var(--primary); background: #f8fafc; }
        .backup-icon { font-size: 3rem; color: var(--text-light); margin-bottom: 15px; }
        .last-backup-info { margin-top: 20px; padding: 15px; background: #fff7ed; border-radius: 8px; border-right: 4px solid #f59e0b; text-align: right; }

        .notification-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px;
            background: white; padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none; z-index: 3000;
            border-right: 5px solid #ef4444;
            align-items: center; gap: 15px;
            animation: slideDown 0.4s ease;
        }
        @keyframes slideDown { from { transform: translate(-50%, -50px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        /* --- Documents & Replies --- */
        #documentsSection, #repliesSection { display: none; padding: 15px; border-radius: 12px; margin-top: 15px; }
        #documentsSection { background: #f8fafc; border: 2px dashed #cbd5e1; }
        #repliesSection { background: #ecfdf5; border: 2px dashed #10b981; }
        #documentsSection.active, #repliesSection.active { display: block; animation: fadeIn 0.3s; }
        .doc-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .doc-item { display: flex; gap: 10px; align-items: center; background: white; padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .doc-item input, .doc-item textarea { flex: 1; border: none; padding: 5px; font-family: inherit; }

        /* --- PRINT STYLES --- */
        #printArea { display: none; } 
        @media print {
            aside, nav.mobile-nav, .header-3d, .modal-overlay, .btn-action, .btn-3d, .stats-grid, .no-print, .close-modal, #searchInput, .report-controls, .filter-container, .table-responsive, .form-grid, .backup-container {
                display: none !important;
            }
            .tab-content { display: none !important; }
            #printArea {
                display: block !important; position: absolute; top: 0; left: 0; width: 100%; visibility: visible; background: white; color: black; padding: 20px; z-index: 99999; direction: rtl; font-size: 12pt;
            }
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .print-header h1 { font-size: 18pt; margin: 0; color: #000; }
            .print-header p { margin: 5px 0; font-size: 11pt; }
            .print-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; background: #f9f9f9; }
            .print-field { margin-bottom: 10px; }
            .print-field strong { display: block; color: #333; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .print-table th, .print-table td { border: 1px solid #333; padding: 8px; text-align: right; font-size: 10pt; white-space: normal; }
            .print-table th { background-color: #eee !important; color: #000; }
            body { background: white; height: auto; overflow: visible; display: block; margin: 0; padding: 0; }
            @page { size: A4; margin: 10mm; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .form-grid { grid-template-columns:1fr; }
            .backup-container { grid-template-columns: 1fr; }
            th:nth-child(5), td:nth-child(5), th:nth-child(6), td:nth-child(6) { display: none; } 
        }
    </style>
</head>
<body>
    <!-- Notification Toast -->
    <div id="notification-toast" class="notification-toast">
        <div style="background: #fef2f2; padding: 10px; border-radius: 50%; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i></div>
        <div style="flex:1;">
            <h4 style="margin:0; font-size:0.95rem; color:#b91c1c;">ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù‚Ø¯ÙŠÙ…</h4>
            <p style="margin:5px 0 0; font-size:0.85rem; color:#64748b;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£Ø³Ø¨ÙˆØ¹. ÙŠÙÙ†ØµØ­ Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø­Ø§Ù„Ø§Ù‹ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
        </div>
        <button class="btn-3d btn-sm" onclick="dismissNotification()" style="background:var(--secondary)">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        <button class="btn-3d btn-sm" onclick="goToBackup()">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
    </div>

    <aside class="sidebar no-print">
        <div class="logo">
            <i class="fas fa-landmark"></i>
            <h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø©<br>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†</h2>
        </div>
        <nav>
            <ul class="nav-links">
                <li class="active" onclick="switchTab('dashboard', this)">
                    <i class="fas fa-chart-line"></i> <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </li>
                <li onclick="switchTab('reports', this)">
                    <i class="fas fa-file-invoice-dollar"></i> <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</span>
                </li>
                <li onclick="switchTab('register', this)">
                    <i class="fas fa-plus-circle"></i> <span>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨</span>
                </li>
                <li onclick="switchTab('archive', this)">
                    <i class="fas fa-archive"></i> <span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>
                </li>
                <li onclick="switchTab('backup', this)" style="margin-top: 30px; border-top: 1px solid #f1f5f9;">
                    <i class="fas fa-database" style="color: var(--primary);"></i> <span style="color: var(--primary);">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
                </li>
            </ul>
        </nav>
    </aside>

    <nav class="mobile-nav no-print">
        <div class="mobile-nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-pie"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="mobile-nav-item" onclick="switchTab('reports', this)"><i class="fas fa-file-invoice"></i><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
        <div class="mobile-nav-item" onclick="switchTab('register', this)"><i class="fas fa-plus-circle"></i><span>Ø¥Ø¶Ø§ÙØ©</span></div>
        <div class="mobile-nav-item" onclick="switchTab('archive', this)"><i class="fas fa-list"></i><span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span></div>
        <div class="mobile-nav-item" onclick="switchTab('backup', this)"><i class="fas fa-database"></i><span>Ø­ÙØ¸</span></div>
    </nav>

    <main class="main-content">
        <section id="dashboard" class="tab-content active">
            <div class="header-3d no-print">
                <h1><i class="fas fa-chart-line"></i> ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h1>
            </div>
            
            <div class="stats-grid no-print">
                <div class="stat-card total">
                    <div class="icon">ğŸ“Š</div><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><span class="number" id="totalRequests">0</span>
                </div>
                <div class="stat-card type-special">
                    <div class="icon">ğŸŒŸ</div><h3>Ø·Ù„Ø¨Ø§Øª Ø®Ø§ØµØ©</h3><span class="number" id="statsSpecial">0</span>
                </div>
                <div class="stat-card type-general">
                    <div class="icon">ğŸ“¢</div><h3>Ø·Ù„Ø¨Ø§Øª Ø¹Ø§Ù…Ø©</h3><span class="number" id="statsGeneral">0</span>
                </div>
                <div class="stat-card type-briefing">
                    <div class="icon">ğŸ“œ</div><h3>Ø·Ù„Ø¨Ø§Øª Ø¥Ø­Ø§Ø·Ø©</h3><span class="number" id="statsBriefing">0</span>
                </div>
                <div class="stat-card success">
                    <div class="icon">âœ…</div><h3>Ù…ÙƒØªÙ…Ù„Ø©</h3><span class="number" id="completedRequests">0</span>
                </div>
                <div class="stat-card warning">
                    <div class="icon">â³</div><h3>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3><span class="number" id="pendingRequests">0</span>
                </div>
            </div>

            <div class="glass-panel no-print">
                <canvas id="requestsChart"></canvas>
            </div>
        </section>

        <section id="reports" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-file-invoice"></i> ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</h1>
            </div>
            
            <div class="glass-panel no-print">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color: var(--primary);"><i class="fas fa-layer-group"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø¬Ù‡Ø©</h3>
                    <button class="btn-3d" onclick="printCategorizedReport()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµÙ†Ù</button>
                </div>

                <div class="report-section-title" style="color: var(--type-special); border-color: var(--type-special);">
                    <i class="fas fa-star"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
                </div>
                <div id="gridSpecial" class="authority-grid"></div>

                <div class="report-section-title" style="color: var(--type-general); border-color: var(--type-general);">
                    <i class="fas fa-bullhorn"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                </div>
                <div id="gridGeneral" class="authority-grid"></div>

                <div class="report-section-title" style="color: var(--type-briefing); border-color: var(--type-briefing);">
                    <i class="fas fa-scroll"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ø·Ø©
                </div>
                <div id="gridBriefing" class="authority-grid"></div>
            </div>
        </section>

        <section id="register" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-plus-circle"></i> â• ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨</h1>
            </div>
            <div class="glass-panel form-container">
                <form id="requestForm">
                    <div class="form-grid">
                        <div class="input-group">
                            <label><i class="fas fa-hashtag"></i> Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                            <input type="text" id="reqId" readonly placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù‚Ù…..." style="background-color: #f1f5f9; color: #2563eb; font-weight: bold;">
                        </div>
                        <div class="input-group">
                            <label><i class="fas fa-calendar"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
                            <input type="date" id="reqDate" required>
                        </div>
                        
                        <div class="input-group full-width">
                            <label style="color: var(--primary); font-size:1.1rem;"><i class="fas fa-filter"></i> Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
                            <select id="reqType" required style="border: 2px solid var(--primary); background: #f0f9ff;">
                                <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨ --</option>
                                <option value="special">Ø·Ù„Ø¨ Ø®Ø§Øµ</option>
                                <option value="general">Ø·Ù„Ø¨ Ø¹Ø§Ù…</option>
                                <option value="briefing">Ø·Ù„Ø¨ Ø¥Ø­Ø§Ø·Ø©</option>
                            </select>
                        </div>

                        <div class="input-group full-width">
                            <label><i class="fas fa-heading"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
                            <input type="text" id="reqTitle" required placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ± Ù„Ù„Ø·Ù„Ø¨">
                        </div>
                        <div class="input-group full-width">
                            <label><i class="fas fa-building"></i> Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù†ÙŠØ©</label>
                            <input type="text" id="reqAuthority" required placeholder="Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©">
                            <small style="color: var(--text-light); font-size: 0.8rem;">Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</small>
                        </div>
                        <div class="input-group full-width">
                            <label><i class="fas fa-align-right"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
                            <textarea id="reqDetails" rows="5" required placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§..."></textarea>
                        </div>
                        <div class="input-group">
                            <label><i class="fas fa-tasks"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                            <select id="reqStatus" required onchange="toggleRepliesSection()">
                                <option value="execution">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="review">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                <option value="replied">ØªÙ… Ø§Ù„Ø±Ø¯ (ÙˆØ§Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø©)</option>
                                <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                                <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                            </select>
                        </div>
                        
                        <div id="repliesSection" class="input-group full-width">
                            <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: #047857;"><i class="fas fa-reply-all"></i> Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø©</h3>
                            <div id="repliesList" class="doc-list"></div>
                            <button type="button" class="btn-3d" onclick="addReplyField()" style="margin-top: 10px; font-size: 0.8rem; padding: 8px 15px; background: #10b981;">
                                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø¢Ø®Ø±
                            </button>
                        </div>

                        <div class="input-group" style="display: flex; align-items: center; justify-content: flex-end;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="hasDocuments" onchange="toggleDocumentsSection()" style="width: 20px; height: 20px;">
                                <i class="fas fa-paperclip"></i> ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø±ÙÙ‚Ø©
                            </label>
                        </div>
                    </div>

                    <div id="documentsSection">
                        <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: var(--primary);">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h3>
                        <div id="documentsList" class="doc-list"></div>
                        <button type="button" class="btn-3d secondary" onclick="addDocumentField()" style="margin-top: 10px; font-size: 0.8rem; padding: 8px 15px;">
                            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø¢Ø®Ø±
                        </button>
                    </div>

                    <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px;" class="no-print">
                        <button type="submit" class="btn-3d" style="flex: 1;">
                            <i class="fas fa-save"></i> <span id="submitButtonText">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</span>
                        </button>
                        <button type="button" class="btn-3d secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <section id="archive" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-archive"></i> ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</h1>
            </div>
            
            <div class="filter-container no-print">
                <div style="flex: 2; min-width: 200px; position: relative;">
                    <i class="fas fa-search" style="position: absolute; right: 12px; top: 12px; color: var(--text-light);"></i>
                    <input type="text" id="searchInput" style="padding-right: 35px;" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." oninput="applyFilters()">
                </div>
                
                <select id="filterType" onchange="applyFilters()">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                    <option value="special">Ø·Ù„Ø¨ Ø®Ø§Øµ</option>
                    <option value="general">Ø·Ù„Ø¨ Ø¹Ø§Ù…</option>
                    <option value="briefing">Ø·Ù„Ø¨ Ø¥Ø­Ø§Ø·Ø©</option>
                </select>

                <select id="filterStatus" onchange="applyFilters()">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="execution">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                    <option value="review">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                    <option value="replied">ØªÙ… Ø§Ù„Ø±Ø¯</option>
                    <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                    <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                </select>
                <button class="btn-3d btn-sm" onclick="printFilteredReport()">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                </button>
            </div>

            <div class="glass-panel">
                <div class="table-responsive" style="margin-top: 0;">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ”¢ Ø§Ù„Ø±Ù‚Ù…</th>
                                <th>ğŸ“Œ Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>ğŸ›ï¸ Ø§Ù„Ø¬Ù‡Ø©</th>
                                <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>ğŸ“ Ù….</th>
                                <th>âœ… Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¹Ø±Ø¶</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr><td colspan="8" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="backup" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-database"></i> ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
            </div>
            <div class="glass-panel">
                <div class="backup-container">
                    <!-- Export Card -->
                    <div class="backup-card">
                        <div class="backup-icon"><i class="fas fa-file-export"></i></div>
                        <h3>ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <p style="color:#64748b; margin-bottom:20px;">Ù‚Ù… Ø¨ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ…Ù„Ù JSON Ù„Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
                        <button class="btn-3d success" onclick="exportDatabase()">
                            <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                        </button>
                    </div>

                    <!-- Import Card -->
                    <div class="backup-card">
                        <div class="backup-icon"><i class="fas fa-file-import"></i></div>
                        <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <p style="color:#64748b; margin-bottom:20px;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©. (ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©).</p>
                        <button class="btn-3d danger" onclick="triggerFileUpload()">
                            <i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø©
                        </button>
                        <input type="file" id="dbFileInput" accept=".json" style="display: none;" onchange="handleFileImport(this)">
                    </div>
                </div>

                <div class="last-backup-info">
                    <h4><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
                    <p id="lastBackupText" style="margin-top: 5px;">Ù„Ù… ÙŠØªÙ… Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø¨Ù„.</p>
                </div>
            </div>
        </section>
    </main>

    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">Ã—</span>
            <div class="modal-header">
                <h2 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
                <div style="color: var(--text-light); margin-top: 5px;">
                    <i class="fas fa-hashtag"></i> <span id="modalReqId"></span> | <span id="modalReqTypeBadge"></span>
                </div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions">
                <button class="btn-action edit" onclick="checkPasscode('edit')" style="background: var(--primary);"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-action delete" onclick="checkPasscode('delete')" style="background: var(--danger);"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                <button class="btn-action print" onclick="printRequest()" style="background: var(--secondary);"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
        </div>
    </div>

    <div id="authorityModal" class="modal-overlay">
        <div class="modal-content large">
            <span class="close-modal" onclick="closeAuthorityModal()">Ã—</span>
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> ØªÙ‚Ø±ÙŠØ± Ø¬Ù‡Ø©: <span id="authModalTitle" style="color: var(--primary);"></span></h2>
                <div id="authModalSubtitle" style="font-size: 0.85rem; color: var(--text-light); margin-top: 5px;"></div>
            </div>
            <div class="modal-body">
                <div id="authPreviewArea" style="padding: 20px; text-align: center; color: var(--text-light);"></div>
            </div>
            <div class="modal-actions">
                <button class="btn-action" onclick="printAuthorityReport()" style="background: var(--primary); flex: 2;"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button class="btn-action" onclick="closeAuthorityModal()" style="background: var(--secondary); flex: 1;"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // APP LOGIC
        // ==========================================
        
        let requestsData = [];
        let currentRequestKey = null; 
        let chartInstance = null;
        let currentAuthorityData = []; 
        const SECURE_CODE = "521988";

        // Translation Maps
        const statusMap = {
            'execution': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', 'review': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'replied': 'ØªÙ… Ø§Ù„Ø±Ø¯', 'completed': 'Ù…ÙƒØªÙ…Ù„', 'rejected': 'Ù…Ø±ÙÙˆØ¶'
        };
        const typeMap = {
            'special': 'Ø·Ù„Ø¨ Ø®Ø§Øµ', 'general': 'Ø·Ù„Ø¨ Ø¹Ø§Ù…', 'briefing': 'Ø·Ù„Ø¨ Ø¥Ø­Ø§Ø·Ø©'
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('reqDate').valueAsDate = new Date();
            addDocumentField(); 
            addReplyField(); 
            
            checkBackupStatus(); // Weekly Notification Check
            updateLastBackupUI();

            if (typeof RequestManager !== 'undefined') {
                fetchRealtimeData();
            } else {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        });

        // --- 1. Security & Passcode ---
        function checkPasscode(action) {
            // Use a custom modal or prompt. Using prompt as requested but implemented securely in logic.
            const code = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:");
            if (code === SECURE_CODE) {
                if (action === 'edit') performEdit();
                else if (action === 'delete') performDelete();
                else if (action === 'export') performExport();
                else if (action === 'import') return true; // For import flow
            } else { 
                if(code !== null) alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦! Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©."); 
                return false;
            }
        }

        // --- 2. Backup & Import Logic ---
        function updateLastBackupUI() {
            const lastBackup = localStorage.getItem('lastBackupTime');
            const textEl = document.getElementById('lastBackupText');
            if (lastBackup) {
                const date = new Date(parseInt(lastBackup));
                textEl.innerText = `Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${date.toLocaleDateString('ar-EG')} - ${date.toLocaleTimeString('ar-EG')}`;
            } else {
                textEl.innerText = "Ù„Ù… ÙŠØªÙ… Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø¨Ù„.";
            }
        }

        function checkBackupStatus() {
            const lastBackup = localStorage.getItem('lastBackupTime');
            const toast = document.getElementById('notification-toast');
            
            if (!lastBackup) {
                toast.style.display = 'flex';
                return;
            }

            const diffTime = Math.abs(Date.now() - parseInt(lastBackup));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            if (diffDays >= 7) {
                toast.style.display = 'flex';
            }
        }

        function dismissNotification() {
            document.getElementById('notification-toast').style.display = 'none';
        }
        
        function goToBackup() {
            dismissNotification();
            // Find the backup tab li and click it
            const items = document.querySelectorAll('.nav-links li');
            if(items.length > 4) {
                items[4].click(); // Backup is the 5th item
            } else {
                document.querySelectorAll('.mobile-nav-item')[4].click();
            }
        }

        function exportDatabase() {
            if (!checkPasscode('export')) return;

            try {
                const dataStr = JSON.stringify(requestsData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                a.download = `Parliament_Backup_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Save Timestamp
                localStorage.setItem('lastBackupTime', Date.now());
                updateLastBackupUI();
                dismissNotification();
                alert("ØªÙ… ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
            } catch (e) {
                console.error(e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±.");
            }
        }

        function triggerFileUpload() {
            document.getElementById('dbFileInput').click();
        }

        function handleFileUpload() {
             const fileInput = document.getElementById('dbFileInput');
             if (!fileInput.files.length) return;
             const file = fileInput.files[0];
             
             const reader = new FileReader();
             reader.onload = function(e) {
                 try {
                     const json = JSON.parse(e.target.result);
                     if (Array.isArray(json)) {
                         // Security Check before Import
                         if (checkPasscode('import')) {
                             performImport(json);
                         }
                     } else {
                         alert("ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­.");
                     }
                 } catch (err) {
                     alert("Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­.");
                 }
             };
             reader.readAsText(file);
             fileInput.value = ''; // Reset
        }

        async function performImport(data) {
            if (!confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù†Ø³Ø®Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
            
            try {
                // We replace the whole 'parliament-requests' node
                await window.database.ref('parliament-requests').set(null); // Clear old
                await window.database.ref('parliament-requests').set(data); // Set new
                
                // Update local timestamp to avoid immediate warning
                localStorage.setItem('lastBackupTime', Date.now());
                updateLastBackupUI();
                
                alert("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
            } catch (err) {
                console.error(err);
                alert("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.");
            }
        }

        // --- 3. Fetch Data ---
        function fetchRealtimeData() {
            RequestManager.listenToRequests((data) => {
                requestsData = data;
                requestsData.sort((a, b) => a.reqId.localeCompare(b.reqId, undefined, { numeric: true, sensitivity: 'base' }));

                renderTable(requestsData);
                updateDashboard();
                updateAllReports(); 
            });
        }

        // --- 4. Navigation & Auto ID ---
        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-links li, .mobile-nav-item').forEach(item => item.classList.remove('active'));
            if (element) element.classList.add('active');
            if (tabId === 'register') setAutoId();
        }

        function setAutoId() {
            if (requestsData.length === 0) {
                document.getElementById('reqId').value = "1";
                return;
            }
            let maxId = 0;
            requestsData.forEach(req => {
                const matches = req.reqId.match(/\d+/g);
                if (matches) {
                    const num = parseInt(matches.join(''), 10);
                    if (num > maxId) maxId = num;
                }
            });
            document.getElementById('reqId').value = (maxId + 1).toString();
        }

        // --- 5. UI Helpers ---
        function toggleDocumentsSection() {
            const isChecked = document.getElementById('hasDocuments').checked;
            const section = document.getElementById('documentsSection');
            if (isChecked) {
                section.classList.add('active');
                if(document.getElementById('documentsList').children.length === 0) addDocumentField();
            } else {
                section.classList.remove('active');
            }
        }
        function addDocumentField() {
            const container = document.getElementById('documentsList');
            const div = document.createElement('div');
            div.className = 'doc-item';
            div.innerHTML = `<i class="fas fa-file-alt"></i><input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯" class="doc-input"><button type="button" onclick="this.parentElement.remove()" style="border:none; background:none; color: #ef4444;"><i class="fas fa-times"></i></button>`;
            container.appendChild(div);
        }

        function toggleRepliesSection() {
            const status = document.getElementById('reqStatus').value;
            const section = document.getElementById('repliesSection');
            if (status === 'replied') {
                section.style.display = 'block';
                if(document.getElementById('repliesList').children.length === 0) addReplyField();
            } else {
                section.style.display = 'none';
            }
        }
        function addReplyField(value = "") {
            const container = document.getElementById('repliesList');
            const div = document.createElement('div');
            div.className = 'doc-item';
            div.innerHTML = `<i class="fas fa-comment-dots" style="color: #10b981;"></i><textarea placeholder="Ù†Øµ Ø§Ù„Ø±Ø¯..." class="reply-input" rows="2" style="flex:1; border:none; padding:5px;">${value}</textarea><button type="button" onclick="this.parentElement.remove()" style="border:none; background:none; color: #ef4444;"><i class="fas fa-times"></i></button>`;
            container.appendChild(div);
        }

        // --- 6. Form Handling ---
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const reqType = document.getElementById('reqType').value;
            if(!reqType) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨"); return; }

            const docInputs = document.querySelectorAll('.doc-input');
            const docsList = Array.from(docInputs).map(i => i.value.trim()).filter(v => v !== "");
            const replyInputs = document.querySelectorAll('.reply-input');
            const repliesList = Array.from(replyInputs).map(i => i.value.trim()).filter(v => v !== "");

            const requestData = {
                reqId: document.getElementById('reqId').value,
                reqDate: document.getElementById('reqDate').value,
                requestType: reqType,
                title: document.getElementById('reqTitle').value,
                authority: document.getElementById('reqAuthority').value,
                details: document.getElementById('reqDetails').value,
                status: document.getElementById('reqStatus').value,
                hasDocuments: document.getElementById('hasDocuments').checked,
                documentsList: docsList,
                repliesList: repliesList
            };

            let success = false;
            if (currentRequestKey) {
                success = await RequestManager.updateRequest(currentRequestKey, requestData);
                if(success) alert('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                success = await RequestManager.addRequest(requestData);
                if(success) alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            }

            if(success) {
                resetForm();
                switchTab('archive');
            }
        });

        function resetForm() {
            document.getElementById('requestForm').reset();
            document.getElementById('reqDate').valueAsDate = new Date();
            currentRequestKey = null;
            document.getElementById('submitButtonText').innerText = 'Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨';
            document.getElementById('reqType').value = ""; 
            
            document.getElementById('documentsSection').classList.remove('active');
            document.getElementById('documentsList').innerHTML = ''; 
            addDocumentField();
            document.getElementById('repliesSection').style.display = 'none';
            document.getElementById('repliesList').innerHTML = '';
            addReplyField();
            setAutoId();
        }

        // --- 7. Table & Filter ---
        function applyFilters() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const filtered = requestsData.filter(r => {
                const matchText = r.title.toLowerCase().includes(searchText) || r.reqId.includes(searchText) || r.authority.toLowerCase().includes(searchText);
                const matchType = typeFilter === 'all' || r.requestType === typeFilter;
                let matchStatus = statusFilter === 'all';
                if (!matchStatus) {
                    if (statusFilter === 'replied') {
                        matchStatus = (r.status === 'replied') || (r.repliesList && r.repliesList.length > 0);
                    } else {
                        matchStatus = r.status === statusFilter;
                    }
                }
                return matchText && matchType && matchStatus;
            });
            renderTable(filtered);
            window.currentFilteredData = filtered;
        }

        function renderTable(data) {
            const tbody = document.getElementById('requestsTableBody');
            tbody.innerHTML = '';
            if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>'; return; }

            data.forEach(req => {
                const st = statusMap[req.status] || req.status;
                const stClass = 'status-' + req.status;
                const tp = typeMap[req.requestType] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const tpClass = 'bg-' + req.requestType;

                const row = `
                    <tr onclick="openModal('${req.firebaseKey}')" style="cursor:pointer">
                        <td>${req.reqId}</td>
                        <td><span class="type-badge ${tpClass}">${tp}</span></td>
                        <td style="font-weight:bold;">${req.title}</td>
                        <td>${req.authority}</td>
                        <td>${req.reqDate}</td>
                        <td>${req.hasDocuments ? '<i class="fas fa-paperclip"></i>' : '-'}</td>
                        <td><span class="status-badge ${stClass}">${st}</span></td>
                        <td><button class="btn-action" style="padding:5px 10px; background:var(--primary);"><i class="fas fa-eye"></i></button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- 8. Dashboard Stats ---
        function updateDashboard() {
            const total = requestsData.length;
            const special = requestsData.filter(r => r.requestType === 'special').length;
            const general = requestsData.filter(r => r.requestType === 'general').length;
            const briefing = requestsData.filter(r => r.requestType === 'briefing').length;
            
            document.getElementById("totalRequests").innerText = total;
            document.getElementById("statsSpecial").innerText = special;
            document.getElementById("statsGeneral").innerText = general;
            document.getElementById("statsBriefing").innerText = briefing;

            document.getElementById("completedRequests").innerText = requestsData.filter(r => r.status === 'completed').length;
            document.getElementById("pendingRequests").innerText = requestsData.filter(r => r.status === 'execution' || r.status === 'review').length;

            renderChart(special, general, briefing);
        }

        function renderChart(s, g, b) {
            const ctx = document.getElementById('requestsChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ø®Ø§Øµ', 'Ø¹Ø§Ù…', 'Ø¥Ø­Ø§Ø·Ø©'],
                    datasets: [{ data: [s, g, b], backgroundColor: ['#7c3aed', '#0891b2', '#ea580c'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Cairo' } } } } }
            });
        }

        // --- 9. Grouped Reports Logic ---
        const AI_AuthorityMatcher = {
            stopWords: ['ÙˆØ²Ø§Ø±Ø©', 'Ø§Ù„Ù‡ÙŠØ¦Ø©', 'Ø§Ù„Ù…Ø¤Ø³Ø³Ø©', 'Ø§Ù„Ù…ØµÙ„Ø­Ø©', 'Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ø§Ù„Ù…Ø¬Ù„Ø³', 'Ø§Ù„Ø¨Ù†Ùƒ', 'Ø§Ù„Ø´Ø±ÙƒØ©', 'Ø§Ù„Ø¹Ø§Ù…Ø©', 'Ø§Ù„Ù‚ÙˆÙ…ÙŠØ©', 'Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©'],
            cleanText: function(text) {
                if (!text) return "";
                let cleaned = text.replace(/[^\u0600-\u06FFa-zA-Z0-9\s]/g, ""); 
                let words = cleaned.split(" ");
                let filtered = words.filter(w => w.length > 2 && !this.stopWords.includes(w));
                return filtered.join(" ");
            },
            calculateSimilarity: function(str1, str2) {
                if (str1 === str2) return 1.0;
                if (!str1 || !str2) return 0.0;
                if (str1.includes(str2) || str2.includes(str1)) return 0.8;
                const set1 = new Set(str1.split(" "));
                const set2 = new Set(str2.split(" "));
                const intersection = new Set([...set1].filter(x => set2.has(x)));
                const union = new Set([...set1, ...set2]);
                return intersection.size / union.size;
            },
            analyze: function(requests) {
                let groups = [];
                requests.forEach(req => {
                    const originalName = req.authority || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const coreName = this.cleanText(originalName);
                    if (!coreName) return; 
                    let matchedGroup = null;
                    for (let group of groups) {
                        if (this.calculateSimilarity(coreName, group.coreKey) > 0.5) { 
                            matchedGroup = group; break;
                        }
                    }
                    if (matchedGroup) {
                        matchedGroup.count++; matchedGroup.requests.push(req);
                        if (!matchedGroup.variants.includes(originalName)) matchedGroup.variants.push(originalName);
                    } else {
                        groups.push({ displayName: originalName, coreKey: coreName, count: 1, requests: [req], variants: [originalName] });
                    }
                });
                return groups.sort((a, b) => b.count - a.count);
            }
        };

        function updateAllReports() {
            const specials = requestsData.filter(r => r.requestType === 'special');
            const generals = requestsData.filter(r => r.requestType === 'general');
            const briefings = requestsData.filter(r => r.requestType === 'briefing');

            renderAuthorityGrid(specials, 'gridSpecial');
            renderAuthorityGrid(generals, 'gridGeneral');
            renderAuthorityGrid(briefings, 'gridBriefing');
        }

        function renderAuthorityGrid(data, elementId) {
            const grid = document.getElementById(elementId);
            grid.innerHTML = '';
            if (data.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1; color:#999; font-size:0.9rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ</div>'; return; }
            
            const grouped = AI_AuthorityMatcher.analyze(data);
            grouped.forEach(group => {
                const isGrouped = group.variants.length > 1;
                const card = document.createElement('div');
                card.className = `authority-card ${isGrouped ? 'grouped' : ''}`;
                card.innerHTML = `
                    <div class="ai-indicator">AI Grouped</div>
                    <h4>${group.displayName}</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="authority-count" onclick="openAuthorityModalWithGroup('${encodeURIComponent(JSON.stringify(group))}')">${group.count}</div>
                        <div style="font-size:0.8rem; color:var(--text-light);">${isGrouped ? `(${group.variants.length} Ù…Ø³Ù…ÙŠØ§Øª)` : 'Ø·Ù„Ø¨'}</div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        function openAuthorityModalWithGroup(groupString) {
            const group = JSON.parse(decodeURIComponent(groupString));
            currentAuthorityData = group.requests;
            document.getElementById('authModalTitle').innerText = group.displayName;
            document.getElementById('authModalSubtitle').innerHTML = group.variants.length > 1 ? `ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª: ${group.variants.join('ØŒ ')}` : "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù‡Ø©";
            document.getElementById('authPreviewArea').innerHTML = `<h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${group.requests.length}</h3><p>Ø§Ø¶ØºØ· Ø·Ø¨Ø§Ø¹Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</p>`;
            document.getElementById('authorityModal').style.display = 'flex';
        }
        function closeAuthorityModal() { document.getElementById('authorityModal').style.display = 'none'; }

        // --- 10. Modal & Actions ---
        function openModal(key) {
            const req = requestsData.find(r => r.firebaseKey === key);
            if (!req) return;
            currentRequestKey = key;
            document.getElementById('modalTitle').innerText = req.title;
            document.getElementById('modalReqId').innerText = req.reqId;
            document.getElementById('modalReqTypeBadge').innerText = typeMap[req.requestType] || req.requestType;
            
            let docsHtml = req.hasDocuments ? (req.documentsList?.length ? `<ul>${req.documentsList.map(d=>`<li>${d}</li>`).join('')}</ul>` : 'ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            
            let repliesHtml = '';
            if (req.repliesList && req.repliesList.length > 0) {
                repliesHtml = `<div style="background:#f0fdf4; border: 1px solid #10b981; padding:10px; margin-top:10px; border-radius:8px;">
                                <strong style="color: #047857; display:block; margin-bottom:5px;"><i class="fas fa-reply-all"></i> Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©:</strong>
                                <ul>${req.repliesList.map(r=>`<li style="margin-bottom:5px;">${r}</li>`).join('')}</ul>
                              </div>`;
            }

            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom:10px;"><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${typeMap[req.requestType]}</div>
                <div style="margin-bottom:10px;"><strong>Ø§Ù„Ø¬Ù‡Ø©:</strong> ${req.authority}</div>
                <div style="background:#f8fafc; padding:10px; margin-bottom:10px; border-radius:8px;">${req.details}</div>
                <div style="margin-bottom:10px;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-badge status-${req.status}">${statusMap[req.status]}</span></div>
                <div><strong>Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:</strong> ${docsHtml}</div>
                ${repliesHtml}
            `;
            document.getElementById('detailsModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; currentRequestKey = null; }

        async function performEdit() {
            const req = requestsData.find(r => r.firebaseKey === currentRequestKey);
            closeModal();
            switchTab('register');
            document.getElementById('reqId').value = req.reqId;
            document.getElementById('reqDate').value = req.reqDate;
            document.getElementById('reqType').value = req.requestType || 'general'; 
            document.getElementById('reqTitle').value = req.title;
            document.getElementById('reqAuthority').value = req.authority;
            document.getElementById('reqDetails').value = req.details;
            document.getElementById('reqStatus').value = req.status;
            document.getElementById('hasDocuments').checked = req.hasDocuments;

            toggleDocumentsSection();
            const dList = document.getElementById('documentsList'); dList.innerHTML = '';
            if(req.documentsList) req.documentsList.forEach(d => {
                const div = document.createElement('div'); div.className='doc-item';
                div.innerHTML = `<i class="fas fa-file-alt"></i><input type="text" value="${d}" class="doc-input"><button type="button" onclick="this.parentElement.remove()" style="border:none;background:none;color:red;">x</button>`;
                dList.appendChild(div);
            });
            if(dList.children.length === 0) addDocumentField();

            const rList = document.getElementById('repliesList'); rList.innerHTML = '';
            if(req.repliesList) req.repliesList.forEach(r => {
                 const div = document.createElement('div'); div.className='doc-item';
                div.innerHTML = `<i class="fas fa-comment"></i><textarea class="reply-input" style="flex:1;border:none;">${r}</textarea><button type="button" onclick="this.parentElement.remove()" style="border:none;background:none;color:red;">x</button>`;
                rList.appendChild(div);
            });

            if(req.repliesList && req.repliesList.length > 0) {
                document.getElementById('repliesSection').style.display = 'block';
            } else {
                toggleRepliesSection();
            }
            if(document.getElementById('repliesList').children.length === 0 && document.getElementById('repliesSection').style.display === 'block') {
                addReplyField();
            }

            document.getElementById('submitButtonText').innerText = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨';
        }

        async function performDelete() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                await RequestManager.deleteRequest(currentRequestKey);
                closeModal();
            }
        }

        // --- 11. Printing Logic ---
        function generatePrintHeader(title) {
            const now = new Date();
            return `<div class="print-header"><h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†</h1><p>${title}</p><p>${now.toLocaleDateString('ar-EG')} ${now.toLocaleTimeString('ar-EG')}</p></div><hr>`;
        }

        function printRequest() {
            const req = requestsData.find(r => r.firebaseKey === currentRequestKey);
            let repliesPrintHtml = '';
            if(req.repliesList && req.repliesList.length > 0) {
                repliesPrintHtml = `<div style="margin-top:20px; border:1px solid #ddd; padding:15px; background:#f9fffb;">
                                    <strong>Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©:</strong>
                                    <ul>${req.repliesList.map(r=>`<li>${r}</li>`).join('')}</ul>
                                   </div>`;
            }

            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `
                ${generatePrintHeader('ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨: ' + req.reqId)}
                <div class="print-details-grid">
                    <div class="print-field"><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${typeMap[req.requestType]}</div>
                    <div class="print-field"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${req.title}</div>
                    <div class="print-field"><strong>Ø§Ù„Ø¬Ù‡Ø©:</strong> ${req.authority}</div>
                    <div class="print-field"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${req.reqDate}</div>
                    <div class="print-field"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${statusMap[req.status]}</div>
                </div>
                <div style="margin-top:20px; border:1px solid #ddd; padding:15px;"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong><br>${req.details}</div>
                ${repliesPrintHtml}
            `;
            setTimeout(() => window.print(), 300);
        }

        function printAuthorityReport() {
            const printArea = document.getElementById('printArea');
            let rows = '';
            currentAuthorityData.forEach(r => {
                rows += `<tr><td>${r.reqId}</td><td>${typeMap[r.requestType]}</td><td>${r.title}</td><td>${r.reqDate}</td><td>${statusMap[r.status]}</td></tr>`;
            });
            printArea.innerHTML = `
                ${generatePrintHeader('ØªÙ‚Ø±ÙŠØ± Ø¬Ù‡Ø©: ' + document.getElementById('authModalTitle').innerText)}
                <table class="print-table"><thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${rows}</tbody></table>
            `;
            setTimeout(() => window.print(), 300);
        }

        function printFilteredReport() {
            const data = window.currentFilteredData || requestsData;
            const printArea = document.getElementById('printArea');
            let rows = '';
            data.forEach(r => {
                rows += `<tr><td>${r.reqId}</td><td>${typeMap[r.requestType]}</td><td>${r.title}</td><td>${r.authority}</td><td>${statusMap[r.status]}</td></tr>`;
            });
            printArea.innerHTML = `
                ${generatePrintHeader('ØªÙ‚Ø±ÙŠØ± Ø¨Ø­Ø« Ù…ÙÙ„ØªØ±')}
                <table class="print-table"><thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø¬Ù‡Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${rows}</tbody></table>
            `;
            setTimeout(() => window.print(), 300);
        }

        function printCategorizedReport() {
            const printArea = document.getElementById('printArea');
            
            const createSection = (title, data) => {
                if(data.length === 0) return '';
                const groups = AI_AuthorityMatcher.analyze(data);
                let html = `<h3 style="margin-top:20px; border-bottom:1px solid #000;">${title} (Ø§Ù„Ø¹Ø¯Ø¯: ${data.length})</h3>`;
                
                groups.forEach(g => {
                    html += `<h4>â€¢ Ø§Ù„Ø¬Ù‡Ø©: ${g.displayName} <span style="font-size:0.8rem">(${g.count} Ø·Ù„Ø¨Ø§Øª)</span></h4>`;
                    html += `<table class="print-table" style="margin-bottom:15px; width:95%; margin-right:5%;">
                        <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
                    g.requests.forEach(r => {
                        html += `<tr><td>${r.reqId}</td><td>${r.title}</td><td>${r.reqDate}</td><td>${statusMap[r.status]}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                });
                return html;
            };

            const specials = requestsData.filter(r => r.requestType === 'special');
            const generals = requestsData.filter(r => r.requestType === 'general');
            const briefings = requestsData.filter(r => r.requestType === 'briefing');

            printArea.innerHTML = `
                ${generatePrintHeader('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù…ØµÙ†Ù')}
                ${createSection('Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ©', specials)}
                ${createSection('Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©', generals)}
                ${createSection('Ø«Ø§Ù„Ø«Ø§Ù‹: Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ø·Ø©', briefings)}
            `;
            setTimeout(() => window.print(), 300);
        }

    </script>
    <div id="printArea"></div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyC4J8ncbuejvzfWvzCTAXRzjFgvrchXpE8",
            authDomain: "hedor-bea3c.firebaseapp.com",
            databaseURL: "https://hedor-bea3c-default-rtdb.firebaseio.com",
            projectId: "hedor-bea3c",
            storageBucket: "hedor-bea3c.firebasestorage.app",
            messagingSenderId: "369239455736",
            appId: "1:369239455736:web:116295854269abecf6480d",
            measurementId: "G-R2MG1YKQEP"
        };

        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            window.database = firebase.database();
        }

        window.RequestManager = {
            addRequest: async (data) => {
                const ref = window.database.ref('parliament-requests').push();
                await ref.set({ ...data, firebaseKey: ref.key });
                return true;
            },
            updateRequest: async (key, data) => {
                await window.database.ref(`parliament-requests/${key}`).update(data);
                return true;
            },
            deleteRequest: async (key) => {
                await window.database.ref(`parliament-requests/${key}`).remove();
                return true;
            },
            listenToRequests: (cb) => {
                window.database.ref('parliament-requests').on('value', snap => {
                    const data = snap.val();
                    const arr = data ? Object.values(data) : [];
                    cb(arr);
                });
            }
        };
    </script>
</body>
</html>
