<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†- Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #8b5cf6; 
            --type-special: #7c3aed; /* Ø¨Ù†ÙØ³Ø¬ÙŠ Ù„Ù„Ø®Ø§Øµ */
            --type-general: #0891b2; /* Ø³Ù…Ø§ÙˆÙŠ Ù„Ù„Ø¹Ø§Ù… */
            --type-briefing: #ea580c; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø¥Ø­Ø§Ø·Ø© */
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --nav-height-mobile: 65px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--background); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* --- Sidebar (Desktop) --- */
        .sidebar { width: 280px; background: var(--surface); height: 100%; display: flex; flex-direction: column; padding: 20px; box-shadow: var(--shadow); z-index: 100; transition: transform 0.3s ease; overflow-y: auto; }
        .logo { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0; }
        .logo i { font-size: 2rem; color: var(--primary); }
        .logo h2 { font-size: 1.1rem; font-weight: 800; line-height: 1.4; color: var(--text-main); }
        .nav-links { list-style: none; flex: 1; }
        .nav-links li { margin-bottom: 8px; padding: 12px 15px; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; color: var(--text-light); font-weight: 600; }
        .nav-links li:hover { background-color: #eff6ff; color: var(--primary); }
        .nav-links li.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transform: scale(1.02); }
        .nav-links li i { font-size: 1.2rem; width: 24px; text-align: center; }

        /* --- Main Content --- */
        .main-content { flex: 1; height: 100%; overflow-y: auto; padding: 20px; padding-bottom: calc(var(--nav-height-mobile) + 20px); position: relative; scroll-behavior: smooth; }
        .header-3d h1 { font-size: 1.8rem; font-weight: 900; background: linear-gradient(135deg, var(--text-main), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .glass-panel { background: var(--glass-bg); border: var(--glass-border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); backdrop-filter: blur(10px); }

        /* --- Tabs Logic --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .stat-card.total::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.info::before { background: var(--info); }
        .stat-card .icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-light); margin-bottom: 5px; }
        .stat-card .number { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }

        /* --- Forms & Tables --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group.full-width { grid-column: 1 / -1; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; transition: border-color 0.2s; background: #fff; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--primary); }

        .table-responsive { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: var(--surface); min-width: 700px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #f1f5f9; white-space: nowrap; }
        th { background-color: #f8fafc; color: var(--text-light); font-weight: 700; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-execution { background: #fff7ed; color: #c2410c; }
        .status-completed { background: #ecfdf5; color: #047857; }
        .status-rejected { background: #fef2f2; color: #b91c1c; }

        /* --- Filter Controls --- */
        .filter-container { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border: 1px dashed #cbd5e1; }
        .filter-container select, .filter-container input[type="text"] { flex: 1; min-width: 150px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }

        /* --- Buttons --- */
        .btn-3d { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 12px 25px; border-radius: 10px; font-family: inherit; font-weight: 700; cursor: pointer; box-shadow: 0 4px 0 #1e3a8a; transition: all 0.1s; display: inline-flex; align-items: center; gap: 8px; font-size: 1rem; }
        .btn-3d:active { transform: translateY(4px); box-shadow: none; }
        .btn-3d.secondary { background: linear-gradient(135deg, #64748b, #475569); box-shadow: 0 4px 0 #334155; }
        .btn-3d.danger { background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 4px 0 #991b1b; }
        .btn-3d.success { background: linear-gradient(135deg, #10b981, #047857); box-shadow: 0 4px 0 #065f46; }

        /* --- Mobile Navigation --- */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); background: var(--surface); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.7rem; gap: 4px; width: 100%; height: 100%; cursor: pointer; transition: all 0.2s; }
        .mobile-nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .mobile-nav-item i { font-size: 1.3rem; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--surface); border-radius: var(--radius); width: 100%; max-width: 500px; overflow: hidden; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content.large { max-width: 900px; }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text-light); z-index: 10; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-actions { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #e2e8f0; }
        .btn-action { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 5px; }

        /* --- Backup & Notifications --- */
        .backup-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }
        .backup-card { background: white; padding: 30px; border-radius: var(--radius); text-align: center; border: 2px dashed #cbd5e1; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; }
        .backup-card:hover { border-color: var(--primary); background: #f8fafc; }
        .backup-icon { font-size: 3rem; color: var(--text-light); margin-bottom: 15px; }
        .last-backup-info { margin-top: 20px; padding: 15px; background: #fff7ed; border-radius: 8px; border-right: 4px solid #f59e0b; text-align: right; }

        .notification-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px;
            background: white; padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none; z-index: 3000;
            border-right: 5px solid #ef4444;
            align-items: center; gap: 15px;
            animation: slideDown 0.4s ease;
        }
        @keyframes slideDown { from { transform: translate(-50%, -50px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        /* --- Documents & Replies --- */
        #documentsSection, #repliesSection { display: none; padding: 15px; border-radius: 12px; margin-top: 15px; }
        #documentsSection { background: #f8fafc; border: 2px dashed #cbd5e1; }
        #repliesSection { background: #ecfdf5; border: 2px dashed #10b981; }
        #documentsSection.active, #repliesSection.active { display: block; animation: fadeIn 0.3s; }
        .doc-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .doc-item { display: flex; gap: 10px; align-items: center; background: white; padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .doc-item input, .doc-item textarea { flex: 1; border: none; padding: 5px; font-family: inherit; }

        /* --- Logs Styles --- */
        .log-device-mobile { color: #ea580c; font-weight: bold; }
        .log-device-desktop { color: #2563eb; font-weight: bold; }
        .log-action-add { color: #10b981; font-weight: bold; }
        .log-action-edit { color: #f59e0b; font-weight: bold; }
        .log-action-delete { color: #ef4444; font-weight: bold; }
        .log-action-system { color: #64748b; font-weight: bold; }
        .log-action-backup { color: #8b5cf6; font-weight: bold; }

        /* --- Authority Report Styles --- */
        .report-section-title { font-size: 1.1rem; font-weight: bold; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0; display: flex; align-items: center; gap: 10px; }
        .authority-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .authority-card { 
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; 
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .authority-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--primary); }
        .authority-card h4 { font-size: 0.9rem; margin-bottom: 10px; color: var(--text-main); line-height: 1.4; min-height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .authority-count { 
            font-size: 1.4rem; font-weight: 800; color: var(--primary); 
            background: #eff6ff; padding: 4px 12px; border-radius: 8px; display: inline-block; width: fit-content;
        }
        .authority-card:hover .authority-count { background: var(--primary); color: white; }
        .ai-indicator { position: absolute; top: 5px; left: 5px; font-size: 0.6rem; background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; display: none; }
        .authority-card.grouped .ai-indicator { display: block; }

        /* --- PRINT STYLES --- */
        #printArea { display: none; } 
        @media print {
            aside, nav.mobile-nav, .header-3d, .modal-overlay, .btn-action, .btn-3d, .stats-grid, .no-print, .close-modal, #searchInput, .report-controls, .filter-container, .table-responsive, .form-grid, .backup-container { display: none !important; }
            .tab-content { display: none !important; }
            #printArea {
                display: block !important; position: absolute; top: 0; left: 0; width: 100%; visibility: visible; background: white; color: black; padding: 20px; z-index: 99999; direction: rtl; font-size: 12pt;
            }
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .print-header h1 { font-size: 18pt; margin: 0; color: #000; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .print-table th, .print-table td { border: 1px solid #333; padding: 8px; text-align: right; font-size: 10pt; white-space: normal; }
            .print-table th { background-color: #eee !important; color: #000; }
            body { background: white; height: auto; overflow: visible; display: block; margin: 0; padding: 0; }
            @page { size: A4; margin: 10mm; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .form-grid { grid-template-columns:1fr; }
            .backup-container { grid-template-columns: 1fr; }
            th:nth-child(5), td:nth-child(5), th:nth-child(6), td:nth-child(6) { display: none; } 
        }
    </style>
</head>
<body>
    <!-- Notification Toast -->
    <div id="notification-toast" class="notification-toast">
        <div style="background: #fef2f2; padding: 10px; border-radius: 50%; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i></div>
        <div style="flex:1;">
            <h4 style="margin:0; font-size:0.95rem; color:#b91c1c;">ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù‚Ø¯ÙŠÙ…</h4>
            <p style="margin:5px 0 0; font-size:0.85rem; color:#64748b;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£Ø³Ø¨ÙˆØ¹. ÙŠÙÙ†ØµØ­ Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø­Ø§Ù„Ø§Ù‹ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
        </div>
        <button class="btn-3d btn-sm" onclick="dismissNotification()" style="background:var(--secondary)">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        <button class="btn-3d btn-sm" onclick="goToBackup()">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
    </div>

    <aside class="sidebar no-print">
        <div class="logo">
            <i class="fas fa-landmark"></i>
            <h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø©<br>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†</h2>
        </div>
        <nav>
            <ul class="nav-links">
                <li class="active" onclick="switchTab('dashboard', this)">
                    <i class="fas fa-chart-line"></i> <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </li>
                <li onclick="switchTab('reports', this)">
                    <i class="fas fa-file-invoice-dollar"></i> <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</span>
                </li>
                <li onclick="switchTab('register', this)">
                    <i class="fas fa-plus-circle"></i> <span>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨</span>
                </li>
                <li onclick="switchTab('archive', this)">
                    <i class="fas fa-archive"></i> <span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>
                </li>
                <li onclick="openSecureTab('logs', this)">
                    <i class="fas fa-history"></i> <span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</span>
                </li>
                <li onclick="switchTab('backup', this)">
                    <i class="fas fa-database" style="color: var(--primary);"></i> <span style="color: var(--primary);">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
                </li>
            </ul>
        </nav>
    </aside>

    <nav class="mobile-nav no-print">
        <div class="mobile-nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-pie"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="mobile-nav-item" onclick="switchTab('reports', this)"><i class="fas fa-file-invoice"></i><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
        <div class="mobile-nav-item" onclick="switchTab('register', this)"><i class="fas fa-plus-circle"></i><span>Ø¥Ø¶Ø§ÙØ©</span></div>
        <div class="mobile-nav-item" onclick="switchTab('archive', this)"><i class="fas fa-list"></i><span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span></div>
        <div class="mobile-nav-item" onclick="openSecureTab('logs', this)"><i class="fas fa-history"></i><span>Ø§Ù„Ø³Ø¬Ù„</span></div>
        <div class="mobile-nav-item" onclick="switchTab('backup', this)"><i class="fas fa-database"></i><span>Ø­ÙØ¸</span></div>
    </nav>

    <main class="main-content">
        <section id="dashboard" class="tab-content active">
            <div class="header-3d no-print">
                <h1><i class="fas fa-chart-line"></i> ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h1>
            </div>
            <div class="stats-grid no-print">
                <div class="stat-card total">
                    <div class="icon">ğŸ“Š</div><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><span class="number" id="totalRequests">0</span>
                </div>
                <div class="stat-card info">
                    <div class="icon">âœ…</div><h3>Ù…ÙƒØªÙ…Ù„Ø©</h3><span class="number" id="completedRequests">0</span>
                </div>
                <div class="stat-card warning">
                    <div class="icon">â³</div><h3>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3><span class="number" id="pendingRequests">0</span>
                </div>
            </div>
            <div class="glass-panel no-print">
                <canvas id="requestsChart"></canvas>
            </div>
        </section>

        <section id="reports" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-file-invoice"></i> ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</h1>
            </div>
            <div class="glass-panel no-print">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø©</h3>
                    <button class="btn-3d" onclick="printCategorizedReport()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                </div>
                <div id="gridReport" class="authority-grid"></div>
            </div>
        </section>

        <section id="register" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-plus-circle"></i> â• ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨</h1>
            </div>
            <div class="glass-panel form-container">
                <form id="requestForm">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                            <input type="text" id="reqId" readonly>
                        </div>
                        <div class="input-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
                            <input type="date" id="reqDate" required>
                        </div>
                        <div class="input-group full-width">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
                            <select id="reqType" required>
                                <option value="special">Ø·Ù„Ø¨ Ø®Ø§Øµ</option>
                                <option value="general">Ø·Ù„Ø¨ Ø¹Ø§Ù…</option>
                                <option value="briefing">Ø·Ù„Ø¨ Ø¥Ø­Ø§Ø·Ø©</option>
                            </select>
                        </div>
                        <div class="input-group full-width">
                            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
                            <input type="text" id="reqTitle" required placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ± Ù„Ù„Ø·Ù„Ø¨">
                        </div>
                        <div class="input-group full-width">
                            <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù†ÙŠØ©</label>
                            <input type="text" id="reqAuthority" required placeholder="Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©">
                        </div>
                        <div class="input-group full-width">
                            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
                            <textarea id="reqDetails" rows="5" required></textarea>
                        </div>
                        <div class="input-group">
                            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                            <select id="reqStatus" required>
                                <option value="execution">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="review">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                                <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px;" class="no-print">
                        <button type="submit" class="btn-3d" style="flex: 1;">
                            <i class="fas fa-save"></i> <span id="submitButtonText">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</span>
                        </button>
                        <button type="button" class="btn-3d secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <section id="archive" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-archive"></i> ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</h1>
            </div>
            <div class="filter-container no-print">
                <div style="flex: 2; min-width: 200px; position: relative;">
                    <i class="fas fa-search" style="position: absolute; right: 12px; top: 12px; color: var(--text-light);"></i>
                    <input type="text" id="searchInput" style="padding-right: 35px;" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..." oninput="applyFilters()">
                </div>
                <button class="btn-3d btn-sm" onclick="printFilteredReport()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            </div>
            <div class="glass-panel">
                <div class="table-responsive" style="margin-top: 0;">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ”¢ Ø§Ù„Ø±Ù‚Ù…</th>
                                <th>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>ğŸ›ï¸ Ø§Ù„Ø¬Ù‡Ø©</th>
                                <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>âœ… Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¹Ø±Ø¶</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="logs" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-history"></i> ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h1>
            </div>
            <div class="glass-panel">
                <div class="table-responsive" style="margin-top: 0;">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ•’ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>ğŸ“± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù†Ø¸Ø§Ù…</th>
                                <th>âš¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                <th>ğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr><td colspan="4" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="backup" class="tab-content">
            <div class="header-3d no-print">
                <h1><i class="fas fa-database"></i> ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
            </div>
            <div class="glass-panel">
                <div class="backup-container">
                    <!-- Export Card -->
                    <div class="backup-card">
                        <div class="backup-icon"><i class="fas fa-file-export"></i></div>
                        <h3>ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <p style="color:#64748b; margin-bottom:20px;">Ù‚Ù… Ø¨ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© ÙƒÙ…Ù„Ù JSON.</p>
                        <button class="btn-3d success" onclick="exportDatabase()">
                            <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                        </button>
                    </div>
                    <!-- Import Card -->
                    <div class="backup-card">
                        <div class="backup-icon"><i class="fas fa-file-import"></i></div>
                        <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <p style="color:#64748b; margin-bottom:20px;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©.</p>
                        <button class="btn-3d danger" onclick="triggerFileUpload()">
                            <i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø©
                        </button>
                        <input type="file" id="dbFileInput" accept=".json" style="display: none;" onchange="handleFileImport(this)">
                    </div>
                </div>
                <div class="last-backup-info">
                    <h4><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
                    <p id="lastBackupText" style="margin-top: 5px;">Ù„Ù… ÙŠØªÙ… Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø¨Ù„.</p>
                </div>
            </div>
        </section>
    </main>

    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">Ã—</span>
            <div class="modal-header"><h2 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions">
                <button class="btn-action edit" onclick="checkPasscode('edit')" style="background: var(--primary);"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-action delete" onclick="checkPasscode('delete')" style="background: var(--danger);"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                <button class="btn-action print" onclick="printRequest()" style="background: var(--secondary);"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG & INITIALIZATION
        // ==========================================
        let requestsData = [];
        let currentRequestKey = null; 
        const SECURE_CODE = "521988";
        
        const statusMap = {
            'execution': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', 'review': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'completed': 'Ù…ÙƒØªÙ…Ù„', 'rejected': 'Ù…Ø±ÙÙˆØ¶'
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('reqDate').valueAsDate = new Date();
            LogManager.init(); // Initialize Logger
            checkBackupStatus();
            updateLastBackupUI();

            if (typeof RequestManager !== 'undefined') {
                fetchRealtimeData();
                // Log "Login" / System Open after a short delay
                setTimeout(() => {
                    LogManager.log("ÙØªØ­ Ø§Ù„Ù†Ø¸Ø§Ù…", "ØªÙ… ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚");
                }, 1000);
            }
        });

        // ==========================================
        // LOGS MANAGER (ENHANCED DEVICE DETECTION)
        // ==========================================
        const LogManager = {
            ref: null,
            listener: null,

            init: function() {
                if(window.database) this.ref = window.database.ref('system_logs');
            },

            // Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ÙØ¹Ù„ÙŠ
            getDetailedDeviceInfo: function() {
                const ua = navigator.userAgent;
                let device = "Unknown";
                let os = "Unknown";
                
                // Check for Mobile / Tablet first
                if (/iPad/.test(ua) && !window.MSStream) {
                    device = "iPad (Tablet)";
                    os = "iOS";
                } else if (/iPhone/.test(ua) && !window.MSStream) {
                    device = "iPhone";
                    os = "iOS";
                } else if (/Android/.test(ua)) {
                    device = "Android Device";
                    os = "Android";
                    // Try to detect generic Android version
                    const match = ua.match(/Android\s([0-9\.]+)/);
                    if(match) os += " " + match[1];
                } 
                // Check for Desktop
                else if (/Windows/.test(ua)) {
                    device = "PC / Laptop";
                    os = "Windows";
                } else if (/Macintosh|Mac OS X/.test(ua)) {
                    device = "Mac (Desktop/Laptop)";
                    os = "macOS";
                } else if (/Linux/.test(ua)) {
                    device = "PC / Laptop";
                    os = "Linux";
                } else {
                    device = "Generic Device";
                }

                return `${device} - ${os}`;
            },

            log: function(action, details) {
                if(!this.ref) return;
                const deviceInfo = this.getDetailedDeviceInfo();
                
                const logEntry = {
                    timestamp: Date.now(),
                    device: deviceInfo,
                    action: action,
                    details: details
                };
                this.ref.push(logEntry);
            },

            startListening: function() {
                if(!this.ref) return;
                // Cancel previous listener if any
                if(this.listener) this.ref.off();
                
                this.listener = this.ref.orderByChild('timestamp').limitToLast(50).on('value', snap => {
                    const data = snap.val();
                    const logsArr = data ? Object.values(data) : [];
                    logsArr.sort((a, b) => b.timestamp - a.timestamp);
                    renderLogsTable(logsArr);
                });
            },

            stopListening: function() {
                if(this.ref && this.listener) {
                    this.ref.off(); // Stop Firebase listener
                }
            }
        };

        function openSecureTab(tabId, element) {
            if(tabId === 'logs') {
                const code = prompt("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„:");
                if (code !== SECURE_CODE) {
                    alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦! Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.");
                    return;
                }
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-links li, .mobile-nav-item').forEach(item => item.classList.remove('active'));
            if (element) element.classList.add('active');

            if (tabId === 'logs') {
                LogManager.startListening();
            } else {
                LogManager.stopListening();
            }
        }

        function renderLogsTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';
            
            if(logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù†Ø´Ø§Ø·Ø§Øª</td></tr>';
                return;
            }

            logs.forEach(log => {
                const dateObj = new Date(log.timestamp);
                const dateStr = dateObj.toLocaleDateString('ar-EG');
                const timeStr = dateObj.toLocaleTimeString('ar-EG');

                let actionClass = 'log-action-system';
                if(log.action.includes('Ø¥Ø¶Ø§ÙØ©')) actionClass = 'log-action-add';
                else if(log.action.includes('ØªØ¹Ø¯ÙŠÙ„')) actionClass = 'log-action-edit';
                else if(log.action.includes('Ø­Ø°Ù')) actionClass = 'log-action-delete';
                else if(log.action.includes('Ù†Ø³Ø®') || log.action.includes('Ø§Ø³ØªØ±Ø¬Ø§Ø¹')) actionClass = 'log-action-backup';

                const deviceClass = log.device.includes('iPhone') || log.device.includes('Android') ? 'log-device-mobile' : 'log-device-desktop';

                const row = `
                    <tr>
                        <td>
                            <div style="font-weight:bold;">${dateStr}</div>
                            <div style="font-size:0.8rem; color:#64748b;">${timeStr}</div>
                        </td>
                        <td><span class="${deviceClass}">${log.device}</span></td>
                        <td><span class="${actionClass}">${log.action}</span></td>
                        <td style="font-size:0.9rem;">${log.details}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ==========================================
        // BACKUP & IMPORT LOGIC
        // ==========================================
        function updateLastBackupUI() {
            const lastBackup = localStorage.getItem('lastBackupTime');
            const textEl = document.getElementById('lastBackupText');
            if (lastBackup) {
                const date = new Date(parseInt(lastBackup));
                textEl.innerText = `Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${date.toLocaleDateString('ar-EG')} - ${date.toLocaleTimeString('ar-EG')}`;
            }
        }

        function checkBackupStatus() {
            const lastBackup = localStorage.getItem('lastBackupTime');
            const toast = document.getElementById('notification-toast');
            if (!lastBackup) { toast.style.display = 'flex'; return; }
            const diffDays = Math.ceil(Math.abs(Date.now() - parseInt(lastBackup)) / (1000 * 60 * 60 * 24)); 
            if (diffDays >= 7) { toast.style.display = 'flex'; }
        }

        function dismissNotification() { document.getElementById('notification-toast').style.display = 'none'; }
        function goToBackup() {
            dismissNotification();
            document.querySelectorAll('.nav-links li')[5].click(); // Assuming Backup is 6th item
        }

        function exportDatabase() {
            if (!checkPasscode('export')) return;
            try {
                const dataStr = JSON.stringify(requestsData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Parliament_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                localStorage.setItem('lastBackupTime', Date.now());
                updateLastBackupUI();
                dismissNotification();
                
                // Log Export
                LogManager.log("ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª", "ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");
                alert("ØªÙ… ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
            } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±."); }
        }

        function triggerFileUpload() { document.getElementById('dbFileInput').click(); }

        function handleFileUpload() {
            const fileInput = document.getElementById('dbFileInput');
            if (!fileInput.files.length) return;
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        if (checkPasscode('import')) performImport(json);
                    } else { alert("ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­."); }
                } catch (err) { alert("Ù…Ù„Ù ØªØ§Ù„Ù."); }
            };
            reader.readAsText(file);
            fileInput.value = '';
        }

        async function performImport(data) {
            if (!confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
            try {
                await window.database.ref('parliament-requests').set(null); 
                await window.database.ref('parliament-requests').set(data); 
                localStorage.setItem('lastBackupTime', Date.now());
                updateLastBackupUI();
                
                // Log Import
                LogManager.log("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª", "ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");
                alert("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
            } catch (err) { alert("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©."); }
        }

        // ==========================================
        // MAIN APP LOGIC
        // ==========================================
        function checkPasscode(action) {
            const code = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ:");
            if (code === SECURE_CODE) {
                if (action === 'edit') performEdit();
                else if (action === 'delete') performDelete();
                return true;
            } else { 
                if(code !== null) alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦!"); 
                return false;
            }
        }

        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-links li, .mobile-nav-item').forEach(item => item.classList.remove('active'));
            if (element) element.classList.add('active');
            if (tabId === 'register') setAutoId();
        }

        function fetchRealtimeData() {
            RequestManager.listenToRequests((data) => {
                requestsData = data;
                requestsData.sort((a, b) => a.reqId.localeCompare(b.reqId, undefined, { numeric: true, sensitivity: 'base' }));
                renderTable(requestsData);
                updateDashboard();
                updateAllReports(); 
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('requestsTableBody');
            tbody.innerHTML = '';
            if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>'; return; }
            data.forEach(req => {
                const stClass = 'status-' + req.status;
                const row = `
                    <tr onclick="openModal('${req.firebaseKey}')" style="cursor:pointer">
                        <td>${req.reqId}</td>
                        <td style="font-weight:bold;">${req.title}</td>
                        <td>${req.authority}</td>
                        <td>${req.reqDate}</td>
                        <td><span class="status-badge ${stClass}">${statusMap[req.status]}</span></td>
                        <td><button class="btn-action" style="padding:5px 10px; background:var(--primary);"><i class="fas fa-eye"></i></button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function setAutoId() {
            if (requestsData.length === 0) { document.getElementById('reqId').value = "1"; return; }
            let maxId = 0;
            requestsData.forEach(req => {
                const matches = req.reqId.match(/\d+/g);
                if (matches) {
                    const num = parseInt(matches.join(''), 10);
                    if (num > maxId) maxId = num;
                }
            });
            document.getElementById('reqId').value = (maxId + 1).toString();
        }

        function updateDashboard() {
            document.getElementById("totalRequests").innerText = requestsData.length;
            document.getElementById("completedRequests").innerText = requestsData.filter(r => r.status === 'completed').length;
            document.getElementById("pendingRequests").innerText = requestsData.filter(r => r.status === 'execution' || r.status === 'review').length;
            
            const ctx = document.getElementById('requestsChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù…ÙƒØªÙ…Ù„', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'],
                    datasets: [{ data: [requestsData.filter(r => r.status === 'completed').length, requestsData.filter(r => r.status !== 'completed').length], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // AI Grouping Logic (Simplified for brevity)
        function updateAllReports() {
            const grid = document.getElementById('gridReport');
            grid.innerHTML = '';
            const groups = {};
            requestsData.forEach(r => {
                const auth = r.authority || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                groups[auth] = (groups[auth] || 0) + 1;
            });
            Object.entries(groups).forEach(([auth, count]) => {
                grid.innerHTML += `
                    <div class="authority-card">
                        <h4>${auth}</h4>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="authority-count">${count}</div>
                        </div>
                    </div>`;
            });
        }

        // Form Handling
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const requestData = {
                reqId: document.getElementById('reqId').value,
                reqDate: document.getElementById('reqDate').value,
                requestType: document.getElementById('reqType').value,
                title: document.getElementById('reqTitle').value,
                authority: document.getElementById('reqAuthority').value,
                details: document.getElementById('reqDetails').value,
                status: document.getElementById('reqStatus').value,
            };
            let success = false;
            if (currentRequestKey) {
                success = await RequestManager.updateRequest(currentRequestKey, requestData);
                if(success) alert('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                success = await RequestManager.addRequest(requestData);
                if(success) alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            }
            if(success) { resetForm(); switchTab('archive'); }
        });

        function resetForm() {
            document.getElementById('requestForm').reset();
            document.getElementById('reqDate').valueAsDate = new Date();
            currentRequestKey = null;
            document.getElementById('submitButtonText').innerText = 'Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨';
            setAutoId();
        }

        function applyFilters() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            renderTable(requestsData.filter(r => r.title.toLowerCase().includes(txt) || r.reqId.includes(txt)));
        }

        // Modal Actions
        function openModal(key) {
            const req = requestsData.find(r => r.firebaseKey === key);
            if (!req) return;
            currentRequestKey = key;
            document.getElementById('modalTitle').innerText = req.title;
            document.getElementById('modalBody').innerHTML = `
                <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${req.requestType}</p>
                <p><strong>Ø§Ù„Ø¬Ù‡Ø©:</strong> ${req.authority}</p>
                <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${statusMap[req.status]}</p>
                <div style="background:#f8fafc; padding:10px; margin-top:10px;">${req.details}</div>
            `;
            document.getElementById('detailsModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; currentRequestKey = null; }

        async function performEdit() {
            const req = requestsData.find(r => r.firebaseKey === currentRequestKey);
            closeModal();
            switchTab('register');
            document.getElementById('reqId').value = req.reqId;
            document.getElementById('reqDate').value = req.reqDate;
            document.getElementById('reqType').value = req.requestType; 
            document.getElementById('reqTitle').value = req.title;
            document.getElementById('reqAuthority').value = req.authority;
            document.getElementById('reqDetails').value = req.details;
            document.getElementById('reqStatus').value = req.status;
            document.getElementById('submitButtonText').innerText = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨';
        }

        async function performDelete() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                await RequestManager.deleteRequest(currentRequestKey);
                closeModal();
            }
        }

        // Print Functions (Simplified)
        function printRequest() {
            const req = requestsData.find(r => r.firebaseKey === currentRequestKey);
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `<h1>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${req.reqId}</h1><p>${req.details}</p>`;
            setTimeout(() => window.print(), 300);
        }
        function printCategorizedReport() { window.print(); }
        function printFilteredReport() { window.print(); }

    </script>

    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4J8ncbuejvzfWvzCTAXRzjFgvrchXpE8",
            authDomain: "hedor-bea3c.firebaseapp.com",
            databaseURL: "https://hedor-bea3c-default-rtdb.firebaseio.com",
            projectId: "hedor-bea3c",
            storageBucket: "hedor-bea3c.firebasestorage.app",
            messagingSenderId: "369239455736",
            appId: "1:369239455736:web:116295854269abecf6480d",
            measurementId: "G-R2MG1YKQEP"
        };

        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            window.database = firebase.database();
        }

        window.RequestManager = {
            addRequest: async (data) => {
                const ref = window.database.ref('parliament-requests').push();
                await ref.set({ ...data, firebaseKey: ref.key });
                LogManager.log("Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯", `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${data.reqId} - ${data.title}`);
                return true;
            },
            updateRequest: async (key, data) => {
                await window.database.ref(`parliament-requests/${key}`).update(data);
                LogManager.log("ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨", `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${data.reqId} - ${data.title}`);
                return true;
            },
            deleteRequest: async (key) => {
                await window.database.ref(`parliament-requests/${key}`).remove();
                LogManager.log("Ø­Ø°Ù Ø·Ù„Ø¨", "ØªÙ… Ø­Ø°Ù Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…");
                return true;
            },
            listenToRequests: (cb) => {
                window.database.ref('parliament-requests').on('value', snap => {
                    const data = snap.val();
                    const arr = data ? Object.values(data) : [];
                    cb(arr);
                });
            }
        };
    </script>
    <div id="printArea"></div>
</body>
</html>
