<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .sidebar {
            background: white;
            min-height: calc(100vh - 56px);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            right: 0;
            top: 56px;
            width: 250px;
            z-index: 100;
        }
        .sidebar .nav-link {
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 5px 10px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .main-content {
            margin-right: 250px;
            padding: 30px;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stat-item {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
        }
        .stat-item.present {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .stat-item.absent {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }
        .stat-item.late {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .stat-item.total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-item h2 {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-item small {
            font-size: 12px;
            opacity: 0.9;
        }
        #adminMap {
            height: 500px;
            border-radius: 15px;
        }
        .table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .employee-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .map-legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-shield-alt me-2"></i>
                لوحة تحكم المدير
            </span>
            <div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
    </nav>

    <div class="sidebar">
        <nav class="nav flex-column py-3">
            <a class="nav-link active" href="admin-dashboard.html">
                <i class="fas fa-home me-2"></i> الرئيسية
            </a>
            <a class="nav-link" href="admin.html">
                <i class="fas fa-users me-2"></i> إدارة الموظفين
            </a>
            <a class="nav-link" href="attendance-history.html">
                <i class="fas fa-history me-2"></i> سجلات الحضور
            </a>
            <a class="nav-link" href="reports.html">
                <i class="fas fa-chart-bar me-2"></i> التقارير
            </a>
            <a class="nav-link" href="settings.html">
                <i class="fas fa-cog me-2"></i> الإعدادات
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="mb-4">
            <h3><i class="fas fa-chart-line me-2"></i>لوحة التحكم الرئيسية</h3>
            <p class="text-muted">نظرة عامة على أداء النظام وإحصائيات الحضور</p>
        </div>

        <!-- الإحصائيات -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-item present">
                    <i class="fas fa-user-check fa-2x mb-2"></i>
                    <h2 id="presentCount">0</h2>
                    <p class="mb-1">موظف حاضر الآن</p>
                    <small id="presentChange">+0 من الأمس</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item absent">
                    <i class="fas fa-user-times fa-2x mb-2"></i>
                    <h2 id="absentCount">0</h2>
                    <p class="mb-1">موظف غائب</p>
                    <small id="absentChange">-0 من الأمس</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item late">
                    <i class="fas fa-user-clock fa-2x mb-2"></i>
                    <h2 id="lateCount">0</h2>
                    <p class="mb-1">متأخر اليوم</p>
                    <small id="lateChange">-0 من الأمس</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item total">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h2 id="totalEmployees">0</h2>
                    <p class="mb-1">إجمالي الموظفين</p>
                    <small id="totalChange">+0 جديد</small>
                </div>
            </div>
        </div>

        <!-- الخريطة -->
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-map-marked-alt me-2"></i>خريطة مواقع الموظفين</h5>
                <button class="btn btn-sm btn-primary" onclick="refreshMap()">
                    <i class="fas fa-sync-alt"></i> تحديث
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-9">
                    <div id="adminMap"></div>
                </div>
                <div class="col-md-3">
                    <div class="map-legend">
                        <h6 class="mb-3">معلومات الخريطة</h6>
                        <p class="small mb-2">
                            <i class="fas fa-circle text-success me-2"></i>
                            داخل نطاق العمل: <strong id="inRangeCount">0</strong>
                        </p>
                        <p class="small mb-2">
                            <i class="fas fa-circle text-danger me-2"></i>
                            خارج نطاق العمل: <strong id="outRangeCount">0</strong>
                        </p>
                        <hr>
                        <p class="small mb-2">
                            <i class="fas fa-circle text-primary me-2"></i>
                            نطاق التسجيل: <strong id="radiusText">100 متر</strong>
                        </p>
                        <p class="small mb-0">
                            <i class="fas fa-clock me-2"></i>
                            آخر تحديث: <strong id="lastUpdateTime">--:--:--</strong>
                        </p>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="mb-3">آخر الحركات</h6>
                        <div id="recentActivities">
                            <p class="text-muted small">جاري التحميل...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- سجلات الحضور اليومية -->
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-calendar-day me-2"></i>سجلات الحضور اليومية</h5>
                <button class="btn btn-sm btn-success" onclick="exportTodayAttendance()">
                    <i class="fas fa-file-excel"></i> تصدير Excel
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الموظف</th>
                            <th>القسم</th>
                            <th>وقت الدخول</th>
                            <th>وقت الخروج</th>
                            <th>ساعات العمل</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="todayAttendanceTable">
                        <tr>
                            <td colspan="8" class="text-center">جاري تحميل بيانات اليوم...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="utils.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&libraries=geometry"></script>
    <script>
        let currentUser = null;
        let workLocation = null;
        let adminMap = null;
        let employeeMarkers = [];
        let workMarker = null;
        let radiusCircle = null;

        window.addEventListener('load', async () => {
            currentUser = checkUserRole();
            if (!currentUser) return;

            await loadWorkLocation();
            initAdminMap();
            await loadStatistics();
            await loadTodayAttendance();
            await loadRecentActivities();
            
            // تحديث تلقائي كل دقيقة
            setInterval(refreshData, 60000);
        });

        async function loadWorkLocation() {
            try {
                const doc = await db.collection('settings').doc('workLocation').get();
                if (doc.exists) {
                    workLocation = doc.data();
                } else {
                    workLocation = {
                        latitude: 31.2001,
                        longitude: 29.9187,
                        radius: 100,
                        name: 'موقع العمل'
                    };
                }
                document.getElementById('radiusText').textContent = workLocation.radius + ' متر';
            } catch (error) {
                console.error('Error loading work location:', error);
            }
        }

        function initAdminMap() {
            const mapOptions = {
                zoom: 15,
                center: { lat: workLocation.latitude, lng: workLocation.longitude },
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: true
            };

            adminMap = new google.maps.Map(document.getElementById('adminMap'), mapOptions);

            workMarker = new google.maps.Marker({
                position: { lat: workLocation.latitude, lng: workLocation.longitude },
                map: adminMap,
                title: workLocation.name || 'موقع العمل',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24">
                            <path fill="#dc3545" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(50, 50)
                }
            });

            radiusCircle = new google.maps.Circle({
                map: adminMap,
                center: { lat: workLocation.latitude, lng: workLocation.longitude },
                radius: workLocation.radius,
                fillColor: '#667eea',
                fillOpacity: 0.2,
                strokeColor: '#667eea',
                strokeOpacity: 0.5,
                strokeWeight: 2
            });
        }

        async function loadStatistics() {
            try {
                const today = formatDate(new Date());
                const yesterday = formatDate(new Date(Date.now() - 86400000));

                const [todaySnapshot, yesterdaySnapshot, employeesSnapshot] = await Promise.all([
                    db.collection('attendance').where('date', '==', today).get(),
                    db.collection('attendance').where('date', '==', yesterday).get(),
                    db.collection('employees').where('status', '==', 'active').get()
                ]);

                const totalEmployees = employeesSnapshot.size;
                const todayPresent = todaySnapshot.size;
                const yesterdayPresent = yesterdaySnapshot.size;
                
                let lateCount = 0;
                todaySnapshot.forEach(doc => {
                    if (doc.data().status === 'late') lateCount++;
                });

                let yesterdayLate = 0;
                yesterdaySnapshot.forEach(doc => {
                    if (doc.data().status === 'late') yesterdayLate++;
                });

                const absentCount = totalEmployees - todayPresent;
                const yesterdayAbsent = totalEmployees - yesterdayPresent;

                document.getElementById('presentCount').textContent = todayPresent;
                document.getElementById('absentCount').textContent = absentCount;
                document.getElementById('lateCount').textContent = lateCount;
                document.getElementById('totalEmployees').textContent = totalEmployees;

                document.getElementById('presentChange').textContent = 
                    `${todayPresent >= yesterdayPresent ? '+' : ''}${todayPresent - yesterdayPresent} من الأمس`;
                document.getElementById('absentChange').textContent = 
                    `${absentCount >= yesterdayAbsent ? '+' : ''}${absentCount - yesterdayAbsent} من الأمس`;
                document.getElementById('lateChange').textContent = 
                    `${lateCount >= yesterdayLate ? '+' : ''}${lateCount - yesterdayLate} من الأمس`;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadTodayAttendance() {
            try {
                const today = formatDate(new Date());
                const snapshot = await db.collection('attendance')
                    .where('date', '==', today)
                    .get();

                const tbody = document.getElementById('todayAttendanceTable');
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد سجلات حضور اليوم</td></tr>';
                    clearEmployeeMarkers();
                    return;
                }

                tbody.innerHTML = '';
                let index = 1;
                let inRangeCount = 0;
                let outRangeCount = 0;

                clearEmployeeMarkers();

                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const timeDiff = data.checkOut ? 
                        calculateTimeDifference(data.checkIn, data.checkOut) : 
                        { hours: 0, minutes: 0 };

                    let statusBadge = '';
                    if (data.status === 'present') {
                        statusBadge = '<span class="badge bg-success">حاضر</span>';
                    } else if (data.status === 'late') {
                        statusBadge = '<span class="badge bg-warning">متأخر</span>';
                    } else {
                        statusBadge = '<span class="badge bg-secondary">' + data.status + '</span>';
                    }

                    const row = `
                        <tr>
                            <td>${index++}</td>
                            <td>${data.employeeName}</td>
                            <td>${data.department || '--'}</td>
                            <td>${formatTime(data.checkIn)}</td>
                            <td>${data.checkOut ? formatTime(data.checkOut) : '--:--:--'}</td>
                            <td>${timeDiff.hours} ساعة ${timeDiff.minutes} دقيقة</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewAttendanceDetails('${doc.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;

                    // إضافة علامة على الخريطة
                    if (data.checkInLocation) {
                        const distance = calculateDistance(
                            data.checkInLocation.latitude,
                            data.checkInLocation.longitude,
                            workLocation.latitude,
                            workLocation.longitude
                        );

                        const isInRange = distance <= workLocation.radius;
                        if (isInRange) inRangeCount++;
                        else outRangeCount++;

                        const marker = new google.maps.Marker({
                            position: { 
                                lat: data.checkInLocation.latitude, 
                                lng: data.checkInLocation.longitude 
                            },
                            map: adminMap,
                            title: data.employeeName,
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10" fill="${isInRange ? '#28a745' : '#dc3545'}" stroke="white" stroke-width="2"/>
                                        <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">${data.employeeName.charAt(0)}</text>
                                    </svg>
                                `),
                                scaledSize: new google.maps.Size(35, 35)
                            }
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="padding:10px;">
                                    <h6>${data.employeeName}</h6>
                                    <p class="mb-1"><small>القسم: ${data.department || '--'}</small></p>
                                    <p class="mb-1"><small>وقت الدخول: ${formatTime(data.checkIn)}</small></p>
                                    <p class="mb-0"><small>المسافة: ${Math.round(distance)} متر</small></p>
                                </div>
                            `
                        });

                        marker.addListener('click', () => {
                            infoWindow.open(adminMap, marker);
                        });

                        employeeMarkers.push(marker);
                    }
                }

                document.getElementById('inRangeCount').textContent = inRangeCount;
                document.getElementById('outRangeCount').textContent = outRangeCount;
                document.getElementById('lastUpdateTime').textContent = formatTime(new Date());

            } catch (error) {
                console.error('Error loading today attendance:', error);
            }
        }

        function clearEmployeeMarkers() {
            employeeMarkers.forEach(marker => marker.setMap(null));
            employeeMarkers = [];
        }

        async function loadRecentActivities() {
            try {
                const today = formatDate(new Date());
                const snapshot = await db.collection('attendance')
                    .where('date', '==', today)
                    .orderBy('checkIn', 'desc')
                    .limit(5)
                    .get();

                const container = document.getElementById('recentActivities');
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-muted small">لا توجد حركات اليوم</p>';
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const time = new Date(data.checkIn);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - time) / 60000);
                    
                    let timeText = '';
                    if (diffMinutes < 60) {
                        timeText = `منذ ${diffMinutes} دقيقة`;
                    } else if (diffMinutes < 1440) {
                        timeText = `منذ ${Math.floor(diffMinutes / 60)} ساعة`;
                    } else {
                        timeText = formatTime(time);
                    }

                    const statusIcon = data.status === 'late' ? 
                        '<i class="fas fa-exclamation-triangle text-warning"></i>' : 
                        '<i class="fas fa-check-circle text-success"></i>';

                    container.innerHTML += `
                        <div class="mb-3 pb-2 border-bottom">
                            <h6 class="mb-1">${statusIcon} ${data.employeeName}</h6>
                            <small class="text-muted">سجل ${data.checkOut ? 'انصراف' : 'دخول'} الساعة ${formatTime(data.checkIn)}</small>
                            <br><small class="text-muted">${timeText}</small>
                        </div>
                    `;
                });

            } catch (error) {
                console.error('Error loading recent activities:', error);
            }
        }

        function refreshMap() {
            loadTodayAttendance();
            loadStatistics();
            showSuccess('تم تحديث الخريطة');
        }

        function refreshData() {
            loadStatistics();
            loadTodayAttendance();
            loadRecentActivities();
        }

        function viewAttendanceDetails(docId) {
            window.location.href = `attendance-history.html?id=${docId}`;
        }

        async function exportTodayAttendance() {
            try {
                const today = formatDate(new Date());
                const snapshot = await db.collection('attendance')
                    .where('date', '==', today)
                    .get();

                if (snapshot.empty) {
                    showError('لا توجد بيانات للتصدير');
                    return;
                }

                let csvContent = '\uFEFF'; // UTF-8 BOM
                csvContent += 'الرقم,الموظف,القسم,التاريخ,وقت الدخول,وقت الخروج,ساعات العمل,الحالة\n';

                let index = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const timeDiff = data.checkOut ? 
                        calculateTimeDifference(data.checkIn, data.checkOut) : 
                        { hours: 0, minutes: 0 };

                    csvContent += `${index++},${data.employeeName},${data.department || '--'},${data.date},${formatTime(data.checkIn)},${data.checkOut ? formatTime(data.checkOut) : '--'},${timeDiff.hours}:${timeDiff.minutes},${data.status}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `attendance_${today}.csv`;
                link.click();

                showSuccess('تم تصدير البيانات بنجاح');

            } catch (error) {
                console.error('Error exporting attendance:', error);
                showError('فشل تصدير البيانات');
            }
        }
    </script>
</body>
</html>
